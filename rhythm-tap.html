<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç¯€æ‹é»æ“Š - ç¶²é å°éŠæˆ²</title>
    <link rel="stylesheet" href="game-styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      #gameCanvas {
        border: 3px solid #2c3e50;
        border-radius: 10px;
        background: linear-gradient(to bottom, #1e3c72, #2a5298);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .game-track {
        position: relative;
        background: rgba(44, 62, 80, 0.8);
        border-radius: 10px;
        margin: 10px;
        height: 80px;
        overflow: hidden;
        border: 2px solid #34495e;
      }

      .track-lane {
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        align-items: center;
        padding: 0 20px;
        background: linear-gradient(
          90deg,
          rgba(52, 152, 219, 0.3) 0%,
          rgba(155, 89, 182, 0.3) 50%,
          rgba(231, 76, 60, 0.3) 100%
        );
      }

      .hit-zone {
        position: absolute;
        right: 20px;
        width: 60px;
        height: 60px;
        border: 3px solid #ecf0f1;
        border-radius: 50%;
        background: rgba(236, 240, 241, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #ecf0f1;
        box-shadow: 0 0 20px rgba(236, 240, 241, 0.5);
      }

      .hit-zone.active {
        animation: hitZoneActive 0.3s ease-out;
        background: rgba(46, 204, 113, 0.8);
        border-color: #2ecc71;
        box-shadow: 0 0 30px rgba(46, 204, 113, 0.8);
      }

      @keyframes hitZoneActive {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .note {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        font-weight: bold;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        animation: noteGlow 0.5s ease-in-out infinite alternate;
      }

      @keyframes noteGlow {
        0% {
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        100% {
          box-shadow: 0 0 25px rgba(255, 255, 255, 0.3);
        }
      }

      .note.type1 {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .note.type2 {
        background: linear-gradient(45deg, #3498db, #2980b9);
      }

      .note.type3 {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
      }

      .note.type4 {
        background: linear-gradient(45deg, #f1c40f, #e67e22);
      }

      .score-popup {
        position: absolute;
        font-size: 20px;
        font-weight: bold;
        pointer-events: none;
        z-index: 1000;
        animation: scorePopup 1s ease-out forwards;
      }

      @keyframes scorePopup {
        0% {
          opacity: 1;
          transform: scale(0.5) translateY(0);
        }
        50% {
          transform: scale(1.2) translateY(-20px);
        }
        100% {
          opacity: 0;
          transform: scale(1) translateY(-60px);
        }
      }

      .perfect {
        color: #2ecc71;
      }
      .great {
        color: #f39c12;
      }
      .good {
        color: #3498db;
      }
      .miss {
        color: #e74c3c;
      }

      .game-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        background: linear-gradient(45deg, #2c3e50, #34495e);
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: bold;
      }

      .info-item {
        text-align: center;
      }

      .info-value {
        font-size: 24px;
        display: block;
        margin-top: 5px;
      }

      .combo-display {
        position: absolute;
        top: 20px;
        left: 20px;
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 18px;
        display: none;
        animation: comboGlow 0.5s ease-in-out infinite alternate;
      }

      @keyframes comboGlow {
        0% {
          box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        100% {
          box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
        }
      }

      .multiplier-display {
        position: absolute;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        color: white;
        padding: 10px 15px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 16px;
      }

      .control-keys {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
      }

      .key-display {
        background: #34495e;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        min-width: 60px;
        text-align: center;
        border: 3px solid #2c3e50;
        transition: all 0.2s ease;
      }

      .key-display.active {
        background: #2ecc71;
        border-color: #27ae60;
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(46, 204, 113, 0.6);
      }

      .game-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
      }

      .control-button {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .control-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .control-button:disabled {
        background: #7f8c8d;
        cursor: not-allowed;
        transform: none;
      }

      .difficulty-selector {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      .difficulty-button {
        background: #34495e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .difficulty-button.active {
        background: #2ecc71;
      }

      .accuracy-bar {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        margin: 15px 0;
        overflow: hidden;
      }

      .accuracy-fill {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .progress-indicator {
        text-align: center;
        margin: 10px 0;
        font-size: 16px;
        font-weight: bold;
        color: #2c3e50;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <header class="game-header">
        <h1 class="game-title">
          <i class="fas fa-music"></i>
          ç¯€æ‹é»æ“Š
        </h1>
        <button class="back-button" onclick="window.location.href='index.html'">
          <i class="fas fa-arrow-left"></i>
          è¿”å›é¸å–®
        </button>
      </header>

      <div class="game-info">
        <div class="info-item">
          <span>åˆ†æ•¸</span>
          <span class="info-value" id="score">0</span>
        </div>
        <div class="info-item">
          <span>å‘½ä¸­ç‡</span>
          <span class="info-value" id="accuracy">100%</span>
        </div>
        <div class="info-item">
          <span>é€£æ“Š</span>
          <span class="info-value" id="combo">0</span>
        </div>
        <div class="info-item">
          <span>æœ€å¤§é€£æ“Š</span>
          <span class="info-value" id="maxCombo">0</span>
        </div>
      </div>

      <div class="difficulty-selector">
        <button class="difficulty-button active" data-difficulty="easy">
          ç°¡å–®
        </button>
        <button class="difficulty-button" data-difficulty="medium">ä¸­ç­‰</button>
        <button class="difficulty-button" data-difficulty="hard">å›°é›£</button>
        <button class="difficulty-button" data-difficulty="extreme">
          æ¥µé™
        </button>
      </div>

      <div class="progress-indicator" id="progressIndicator">æº–å‚™é–‹å§‹...</div>

      <div class="accuracy-bar">
        <div class="accuracy-fill" id="accuracyFill" style="width: 100%"></div>
      </div>

      <div class="control-keys">
        <div class="key-display" data-key="d">D</div>
        <div class="key-display" data-key="f">F</div>
        <div class="key-display" data-key="j">J</div>
        <div class="key-display" data-key="k">K</div>
      </div>

      <div class="game-canvas-container">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div class="combo-display" id="comboDisplay">
          é€£æ“Š x<span id="comboCount">0</span>
        </div>
        <div class="multiplier-display" id="multiplierDisplay">x1.0</div>
      </div>

      <div class="game-controls">
        <button class="control-button" id="startButton">é–‹å§‹éŠæˆ²</button>
        <button class="control-button" id="pauseButton" disabled>æš«åœ</button>
        <button class="control-button" id="resetButton">é‡æ–°é–‹å§‹</button>
        <button class="control-button" id="helpButton">éŠæˆ²èªªæ˜</button>
      </div>

      <div class="game-stats">
        <div class="stat-item">
          <span class="stat-label">æœ€é«˜åˆ†ï¼š</span>
          <span class="stat-value" id="highScore">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">ç¸½éŠæˆ²æ¬¡æ•¸ï¼š</span>
          <span class="stat-value" id="totalGames">0</span>
        </div>
      </div>
    </div>

    <!-- éŠæˆ²èªªæ˜æ¨¡æ…‹æ¡† -->
    <div id="helpModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ğŸµ ç¯€æ‹é»æ“Š - éŠæˆ²èªªæ˜</h2>
        <div class="help-content">
          <h3>ğŸ¯ éŠæˆ²ç›®æ¨™</h3>
          <p>æŒ‰ç…§ç¯€æ‹æº–ç¢ºé»æ“Šå°æ‡‰æŒ‰éµï¼Œç²å¾—æœ€é«˜åˆ†æ•¸å’Œé€£æ“Šï¼</p>

          <h3>ğŸ® æ“ä½œæ–¹å¼</h3>
          <ul>
            <li>ä½¿ç”¨ Dã€Fã€Jã€K éµå°æ‡‰å››å€‹è»Œé“</li>
            <li>ç•¶éŸ³ç¬¦åˆ°é”å³å´ç›®æ¨™å€åŸŸæ™‚æŒ‰ä¸‹å°æ‡‰æŒ‰éµ</li>
            <li>æŒ‰éµæ™‚æ©Ÿè¶Šæº–ç¢ºï¼Œç²å¾—çš„åˆ†æ•¸è¶Šé«˜</li>
          </ul>

          <h3>ğŸ¯ è©•åˆ†ç³»çµ±</h3>
          <ul>
            <li>
              <span style="color: #2ecc71">Perfect</span> - å®Œç¾æ™‚æ©Ÿ (100åˆ†)
            </li>
            <li><span style="color: #f39c12">Great</span> - å¾ˆå¥½ (75åˆ†)</li>
            <li><span style="color: #3498db">Good</span> - ä¸éŒ¯ (50åˆ†)</li>
            <li><span style="color: #e74c3c">Miss</span> - éŒ¯é (0åˆ†)</li>
          </ul>

          <h3>âš¡ é›£åº¦ç­‰ç´š</h3>
          <ul>
            <li><strong>ç°¡å–®ï¼š</strong>è¼ƒæ…¢çš„éŸ³ç¬¦é€Ÿåº¦ï¼Œè¼ƒå¯¬çš„åˆ¤å®šç¯„åœ</li>
            <li><strong>ä¸­ç­‰ï¼š</strong>æ¨™æº–é€Ÿåº¦å’Œåˆ¤å®š</li>
            <li><strong>å›°é›£ï¼š</strong>è¼ƒå¿«é€Ÿåº¦ï¼Œè¼ƒåš´æ ¼åˆ¤å®š</li>
            <li><strong>æ¥µé™ï¼š</strong>æœ€å¿«é€Ÿåº¦ï¼Œæœ€åš´æ ¼åˆ¤å®š</li>
          </ul>

          <h3>ğŸ”¥ é€£æ“Šç³»çµ±</h3>
          <ul>
            <li>é€£çºŒæº–ç¢ºæ“Šä¸­å¯ç²å¾—é€£æ“ŠåŠ æˆ</li>
            <li>é€£æ“Šå€æ•¸æœƒéš¨è‘—é€£æ“Šæ•¸å¢åŠ </li>
            <li>éŒ¯ééŸ³ç¬¦æœƒä¸­æ–·é€£æ“Š</li>
            <li>æ›´é«˜çš„é€£æ“Šèƒ½ç²å¾—æ›´å¤šåˆ†æ•¸</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- éŠæˆ²çµæŸæ¨¡æ…‹æ¡† -->
    <div id="gameOverModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ‰ éŠæˆ²çµæŸï¼</h2>
        <div id="gameOverContent">
          <p>æœ€çµ‚åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
          <p>å‘½ä¸­ç‡ï¼š<span id="finalAccuracy">0%</span></p>
          <p>æœ€å¤§é€£æ“Šï¼š<span id="finalMaxCombo">0</span></p>
          <p>Perfectï¼š<span id="finalPerfect">0</span></p>
          <p>Greatï¼š<span id="finalGreat">0</span></p>
          <p>Goodï¼š<span id="finalGood">0</span></p>
          <p>Missï¼š<span id="finalMiss">0</span></p>
        </div>
        <div class="modal-buttons">
          <button class="modal-button" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
          <button
            class="modal-button"
            onclick="window.location.href='index.html'"
          >
            è¿”å›é¸å–®
          </button>
        </div>
      </div>
    </div>

    <script src="gameUtils.js"></script>
    <script>
      class RhythmTapGame {
        constructor() {
          this.canvas = document.getElementById("gameCanvas");
          this.ctx = this.canvas.getContext("2d");
          this.isRunning = false;
          this.isPaused = false;

          this.score = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.accuracy = 100;

          this.notes = [];
          this.tracks = 4;
          this.trackHeight = this.canvas.height / this.tracks;
          this.noteSpeed = 3;
          this.difficulty = "easy";

          this.hitCounts = {
            perfect: 0,
            great: 0,
            good: 0,
            miss: 0,
          };

          this.keys = ["d", "f", "j", "k"];
          this.keyStates = {};
          this.lastNoteSpawn = 0;
          this.noteSpawnInterval = 1000;
          this.gameTime = 0;
          this.gameDuration = 120000; // 2 minutes

          this.difficultySettings = {
            easy: {
              speed: 2,
              spawnRate: 1200,
              perfectWindow: 100,
              greatWindow: 150,
              goodWindow: 200,
            },
            medium: {
              speed: 3,
              spawnRate: 1000,
              perfectWindow: 80,
              greatWindow: 120,
              goodWindow: 160,
            },
            hard: {
              speed: 4,
              spawnRate: 800,
              perfectWindow: 60,
              greatWindow: 100,
              goodWindow: 140,
            },
            extreme: {
              speed: 5,
              spawnRate: 600,
              perfectWindow: 40,
              greatWindow: 80,
              goodWindow: 120,
            },
          };

          this.setupEventListeners();
          this.loadStats();
          this.setDifficulty("easy");
        }

        setupEventListeners() {
          document
            .getElementById("startButton")
            .addEventListener("click", () => this.startGame());
          document
            .getElementById("pauseButton")
            .addEventListener("click", () => this.togglePause());
          document
            .getElementById("resetButton")
            .addEventListener("click", () => this.resetGame());
          document
            .getElementById("helpButton")
            .addEventListener("click", () => this.showHelp());

          // é›£åº¦é¸æ“‡
          document.querySelectorAll(".difficulty-button").forEach((button) => {
            button.addEventListener("click", (e) =>
              this.setDifficulty(e.target.dataset.difficulty)
            );
          });

          // éµç›¤äº‹ä»¶
          document.addEventListener("keydown", (e) => this.handleKeyDown(e));
          document.addEventListener("keyup", (e) => this.handleKeyUp(e));

          // æ¨¡æ…‹æ¡†è¨­å®š
          this.setupModals();
        }

        setDifficulty(difficulty) {
          this.difficulty = difficulty;
          const settings = this.difficultySettings[difficulty];

          this.noteSpeed = settings.speed;
          this.noteSpawnInterval = settings.spawnRate;

          // æ›´æ–°UI
          document
            .querySelectorAll(".difficulty-button")
            .forEach((btn) => btn.classList.remove("active"));
          document
            .querySelector(`[data-difficulty="${difficulty}"]`)
            .classList.add("active");
        }

        startGame() {
          if (this.isRunning) return;

          this.isRunning = true;
          this.isPaused = false;
          this.score = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.accuracy = 100;
          this.notes = [];
          this.gameTime = 0;

          this.hitCounts = {
            perfect: 0,
            great: 0,
            good: 0,
            miss: 0,
          };

          this.updateUI();
          this.updateButtons();
          this.gameLoop();

          document.getElementById("progressIndicator").textContent =
            "éŠæˆ²é€²è¡Œä¸­...";
        }

        togglePause() {
          if (!this.isRunning) return;

          this.isPaused = !this.isPaused;
          document.getElementById("pauseButton").textContent = this.isPaused
            ? "ç¹¼çºŒ"
            : "æš«åœ";

          if (!this.isPaused) {
            this.gameLoop();
          }
        }

        resetGame() {
          this.isRunning = false;
          this.isPaused = false;
          this.score = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.accuracy = 100;
          this.notes = [];
          this.gameTime = 0;

          this.hitCounts = {
            perfect: 0,
            great: 0,
            good: 0,
            miss: 0,
          };

          this.updateUI();
          this.updateButtons();
          this.clearCanvas();

          document.getElementById("progressIndicator").textContent =
            "æº–å‚™é–‹å§‹...";
          document.getElementById("comboDisplay").style.display = "none";
        }

        handleKeyDown(e) {
          if (!this.isRunning || this.isPaused) return;

          const key = e.key.toLowerCase();
          if (this.keys.includes(key) && !this.keyStates[key]) {
            this.keyStates[key] = true;
            this.handleKeyPress(key);

            // è¦–è¦ºåé¥‹
            const keyDisplay = document.querySelector(`[data-key="${key}"]`);
            if (keyDisplay) {
              keyDisplay.classList.add("active");
            }
          }
        }

        handleKeyUp(e) {
          const key = e.key.toLowerCase();
          if (this.keys.includes(key)) {
            this.keyStates[key] = false;

            // ç§»é™¤è¦–è¦ºåé¥‹
            const keyDisplay = document.querySelector(`[data-key="${key}"]`);
            if (keyDisplay) {
              keyDisplay.classList.remove("active");
            }
          }
        }

        handleKeyPress(key) {
          const trackIndex = this.keys.indexOf(key);
          if (trackIndex === -1) return;

          // æ‰¾åˆ°æœ€è¿‘çš„éŸ³ç¬¦
          let closestNote = null;
          let closestDistance = Infinity;
          const hitZoneX = this.canvas.width - 80;

          for (let i = 0; i < this.notes.length; i++) {
            const note = this.notes[i];
            if (note.track === trackIndex) {
              const distance = Math.abs(note.x - hitZoneX);
              if (distance < closestDistance) {
                closestDistance = distance;
                closestNote = note;
              }
            }
          }

          if (closestNote) {
            this.checkHit(closestNote, closestDistance);
          }
        }

        checkHit(note, distance) {
          const settings = this.difficultySettings[this.difficulty];
          let hitType = "miss";
          let points = 0;

          if (distance <= settings.perfectWindow) {
            hitType = "perfect";
            points = 100;
          } else if (distance <= settings.greatWindow) {
            hitType = "great";
            points = 75;
          } else if (distance <= settings.goodWindow) {
            hitType = "good";
            points = 50;
          }

          if (hitType !== "miss") {
            this.combo++;
            this.maxCombo = Math.max(this.maxCombo, this.combo);

            // é€£æ“ŠåŠ æˆ
            const comboMultiplier = Math.min(1 + (this.combo - 1) * 0.1, 3);
            points = Math.floor(points * comboMultiplier);

            this.score += points;
            this.hitCounts[hitType]++;

            // ç§»é™¤éŸ³ç¬¦
            const noteIndex = this.notes.indexOf(note);
            if (noteIndex !== -1) {
              this.notes.splice(noteIndex, 1);
            }

            this.updateComboDisplay();
          } else {
            this.combo = 0;
            this.hitCounts.miss++;
            this.updateComboDisplay();
          }

          this.showScorePopup(note.x, note.y, hitType, points);
          this.updateAccuracy();
        }

        showScorePopup(x, y, hitType, points) {
          const popup = document.createElement("div");
          popup.className = `score-popup ${hitType}`;
          popup.textContent = hitType === "miss" ? "MISS" : `+${points}`;

          // å°‡ç•«å¸ƒåº§æ¨™è½‰æ›ç‚ºé é¢åº§æ¨™
          const rect = this.canvas.getBoundingClientRect();
          popup.style.left = rect.left + x + "px";
          popup.style.top = rect.top + y + "px";
          popup.style.position = "fixed";

          document.body.appendChild(popup);

          setTimeout(() => {
            if (popup.parentElement) {
              popup.parentElement.removeChild(popup);
            }
          }, 1000);
        }

        updateComboDisplay() {
          const comboDisplay = document.getElementById("comboDisplay");
          const comboCount = document.getElementById("comboCount");
          const multiplierDisplay =
            document.getElementById("multiplierDisplay");

          if (this.combo > 3) {
            comboCount.textContent = this.combo;
            comboDisplay.style.display = "block";
          } else {
            comboDisplay.style.display = "none";
          }

          const multiplier = Math.min(1 + Math.max(0, this.combo - 1) * 0.1, 3);
          multiplierDisplay.textContent = `x${multiplier.toFixed(1)}`;
        }

        updateAccuracy() {
          const totalHits = Object.values(this.hitCounts).reduce(
            (a, b) => a + b,
            0
          );
          if (totalHits > 0) {
            const successfulHits =
              this.hitCounts.perfect +
              this.hitCounts.great +
              this.hitCounts.good;
            this.accuracy = Math.round((successfulHits / totalHits) * 100);
          }
        }

        gameLoop() {
          if (!this.isRunning || this.isPaused) return;

          this.gameTime += 16; // ç´„60FPS

          // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
          if (this.gameTime >= this.gameDuration) {
            this.endGame();
            return;
          }

          this.spawnNotes();
          this.updateNotes();
          this.render();
          this.updateUI();

          requestAnimationFrame(() => this.gameLoop());
        }

        spawnNotes() {
          if (this.gameTime - this.lastNoteSpawn >= this.noteSpawnInterval) {
            this.createNote();
            this.lastNoteSpawn = this.gameTime;
          }
        }

        createNote() {
          const track = Math.floor(Math.random() * this.tracks);
          const y = track * this.trackHeight + this.trackHeight / 2;

          const note = {
            x: -50,
            y: y,
            track: track,
            type: Math.floor(Math.random() * 4) + 1,
            hit: false,
          };

          this.notes.push(note);
        }

        updateNotes() {
          for (let i = this.notes.length - 1; i >= 0; i--) {
            const note = this.notes[i];
            note.x += this.noteSpeed;

            // ç§»é™¤è¶…å‡ºç•«é¢çš„éŸ³ç¬¦
            if (note.x > this.canvas.width + 50) {
              if (!note.hit) {
                this.combo = 0;
                this.hitCounts.miss++;
                this.updateAccuracy();
                this.updateComboDisplay();
              }
              this.notes.splice(i, 1);
            }
          }
        }

        render() {
          this.clearCanvas();
          this.drawTracks();
          this.drawNotes();
          this.drawHitZones();
        }

        clearCanvas() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }

        drawTracks() {
          for (let i = 0; i < this.tracks; i++) {
            const y = i * this.trackHeight;

            // è»Œé“èƒŒæ™¯
            this.ctx.fillStyle =
              i % 2 === 0 ? "rgba(52, 73, 94, 0.3)" : "rgba(44, 62, 80, 0.3)";
            this.ctx.fillRect(0, y, this.canvas.width, this.trackHeight);

            // è»Œé“åˆ†éš”ç·š
            if (i > 0) {
              this.ctx.strokeStyle = "#34495e";
              this.ctx.lineWidth = 2;
              this.ctx.beginPath();
              this.ctx.moveTo(0, y);
              this.ctx.lineTo(this.canvas.width, y);
              this.ctx.stroke();
            }
          }
        }

        drawNotes() {
          this.notes.forEach((note) => {
            this.ctx.save();

            // éŸ³ç¬¦é™°å½±
            this.ctx.globalAlpha = 0.3;
            this.ctx.fillStyle = "#000";
            this.ctx.beginPath();
            this.ctx.arc(note.x + 2, note.y + 2, 20, 0, Math.PI * 2);
            this.ctx.fill();

            this.ctx.restore();

            // éŸ³ç¬¦ä¸»é«”
            const gradient = this.ctx.createRadialGradient(
              note.x,
              note.y,
              0,
              note.x,
              note.y,
              20
            );

            switch (note.type) {
              case 1:
                gradient.addColorStop(0, "#e74c3c");
                gradient.addColorStop(1, "#c0392b");
                break;
              case 2:
                gradient.addColorStop(0, "#3498db");
                gradient.addColorStop(1, "#2980b9");
                break;
              case 3:
                gradient.addColorStop(0, "#2ecc71");
                gradient.addColorStop(1, "#27ae60");
                break;
              case 4:
                gradient.addColorStop(0, "#f1c40f");
                gradient.addColorStop(1, "#e67e22");
                break;
            }

            this.ctx.fillStyle = gradient;
            this.ctx.beginPath();
            this.ctx.arc(note.x, note.y, 20, 0, Math.PI * 2);
            this.ctx.fill();

            // éŸ³ç¬¦é«˜å…‰
            this.ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
            this.ctx.beginPath();
            this.ctx.arc(note.x - 7, note.y - 7, 8, 0, Math.PI * 2);
            this.ctx.fill();

            // éŸ³ç¬¦æ¨™è¨˜
            this.ctx.fillStyle = "white";
            this.ctx.font = "bold 16px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(
              this.keys[note.track].toUpperCase(),
              note.x,
              note.y + 5
            );
          });
        }

        drawHitZones() {
          for (let i = 0; i < this.tracks; i++) {
            const x = this.canvas.width - 80;
            const y = i * this.trackHeight + this.trackHeight / 2;

            // å‘½ä¸­å€åŸŸ
            this.ctx.strokeStyle = "#ecf0f1";
            this.ctx.lineWidth = 3;
            this.ctx.setLineDash([]);
            this.ctx.beginPath();
            this.ctx.arc(x, y, 30, 0, Math.PI * 2);
            this.ctx.stroke();

            // å®Œç¾å€åŸŸ
            this.ctx.strokeStyle = "#2ecc71";
            this.ctx.lineWidth = 2;
            this.ctx.setLineDash([5, 5]);
            this.ctx.beginPath();
            this.ctx.arc(x, y, 15, 0, Math.PI * 2);
            this.ctx.stroke();

            // æŒ‰éµæ¨™ç±¤
            this.ctx.fillStyle = "#ecf0f1";
            this.ctx.font = "bold 18px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(this.keys[i].toUpperCase(), x, y + 6);
          }
        }

        updateUI() {
          document.getElementById("score").textContent =
            this.score.toLocaleString();
          document.getElementById("accuracy").textContent = this.accuracy + "%";
          document.getElementById("combo").textContent = this.combo;
          document.getElementById("maxCombo").textContent = this.maxCombo;

          // æ›´æ–°æº–ç¢ºåº¦æ¢
          const accuracyFill = document.getElementById("accuracyFill");
          accuracyFill.style.width = this.accuracy + "%";

          // æ›´æ–°é€²åº¦
          const progress = (this.gameTime / this.gameDuration) * 100;
          const timeLeft = Math.ceil(
            (this.gameDuration - this.gameTime) / 1000
          );
          document.getElementById(
            "progressIndicator"
          ).textContent = `å‰©é¤˜æ™‚é–“: ${timeLeft}ç§’ (${Math.round(progress)}%)`;
        }

        updateButtons() {
          const startButton = document.getElementById("startButton");
          const pauseButton = document.getElementById("pauseButton");

          startButton.disabled = this.isRunning;
          pauseButton.disabled = !this.isRunning;

          startButton.textContent = this.isRunning ? "é€²è¡Œä¸­" : "é–‹å§‹éŠæˆ²";
          pauseButton.textContent = this.isPaused ? "ç¹¼çºŒ" : "æš«åœ";
        }

        endGame() {
          this.isRunning = false;
          this.updateStats();
          this.showGameOver();
          this.updateButtons();
        }

        showHelp() {
          const modal = document.getElementById("helpModal");
          if (modal) {
            modal.style.display = "block";

            // Set up close button event listener
            const closeBtn = modal.querySelector(".close");
            if (closeBtn) {
              closeBtn.onclick = () => this.closeHelp();
            }

            // Close when clicking outside the modal
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                this.closeHelp();
              }
            });

            // Close with escape key
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                this.closeHelp();
              }
            });
          }
        }

        closeHelp() {
          const modal = document.getElementById("helpModal");
          if (modal) {
            modal.style.display = "none";
          }
        }

        showGameOver() {
          document.getElementById("finalScore").textContent =
            this.score.toLocaleString();
          document.getElementById("finalAccuracy").textContent =
            this.accuracy + "%";
          document.getElementById("finalMaxCombo").textContent = this.maxCombo;
          document.getElementById("finalPerfect").textContent =
            this.hitCounts.perfect;
          document.getElementById("finalGreat").textContent =
            this.hitCounts.great;
          document.getElementById("finalGood").textContent =
            this.hitCounts.good;
          document.getElementById("finalMiss").textContent =
            this.hitCounts.miss;

          document.getElementById("gameOverModal").style.display = "block";
        }

        loadStats() {
          const stats = JSON.parse(
            localStorage.getItem("rhythmTapStats") || "{}"
          );
          document.getElementById("highScore").textContent = (
            stats.highScore || 0
          ).toLocaleString();
          document.getElementById("totalGames").textContent =
            stats.totalGames || 0;
        }

        updateStats() {
          const stats = JSON.parse(
            localStorage.getItem("rhythmTapStats") || "{}"
          );

          stats.highScore = Math.max(stats.highScore || 0, this.score);
          stats.totalGames = (stats.totalGames || 0) + 1;
          stats.totalScore = (stats.totalScore || 0) + this.score;
          stats.bestAccuracy = Math.max(stats.bestAccuracy || 0, this.accuracy);
          stats.bestCombo = Math.max(stats.bestCombo || 0, this.maxCombo);

          localStorage.setItem("rhythmTapStats", JSON.stringify(stats));
          this.loadStats();
        }

        setupModals() {
          const modals = document.querySelectorAll(".modal");
          const closeButtons = document.querySelectorAll(".close");

          closeButtons.forEach((button) => {
            button.addEventListener("click", (e) => {
              e.target.closest(".modal").style.display = "none";
            });
          });

          window.addEventListener("click", (e) => {
            modals.forEach((modal) => {
              if (e.target === modal) {
                modal.style.display = "none";
              }
            });
          });
        }
      }

      function restartGame() {
        document.getElementById("gameOverModal").style.display = "none";
        game.resetGame();
        game.startGame();
      }

      // åˆå§‹åŒ–éŠæˆ²
      const game = new RhythmTapGame();

      // è¨»å†ŠéŠæˆ²çµ±è¨ˆ
      if (typeof gameStats !== "undefined") {
        gameStats.registerGame("rhythmTap", "ç¯€æ‹é»æ“Š");
      }
    </script>
  </body>
</html>
