<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¡«è‰²éŠæˆ² - ç¶²é å°éŠæˆ²</title>
    <meta name="game-id" content="coloring-game" />
    <meta name="game-name" content="å¡«è‰²éŠæˆ²" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .coloring-container {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .game-controls-top {
        display: flex;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 20px;
      }

      .canvas-container {
        position: relative;
        border: 2px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      canvas {
        display: block;
        background-color: #fff;
      }

      .color-palette {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        max-width: 500px;
      }

      .color-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .color-option:hover {
        transform: scale(1.1);
      }

      .color-option.selected {
        transform: scale(1.2);
        box-shadow: 0 0 0 3px #333, 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 1;
      }

      .tool-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .tool-button {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        background-color: #f0f0f0;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .tool-button i {
        font-size: 18px;
      }

      .tool-button:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
      }

      .tool-button.active {
        background-color: var(--primary-color);
        color: white;
      }

      .brush-size-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .brush-size-label {
        font-size: 14px;
        color: #666;
      }

      .brush-preview {
        width: 20px;
        height: 20px;
        background-color: black;
        border-radius: 50%;
      }

      .template-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-bottom: 20px;
        max-width: 800px;
      }

      .template-option {
        width: 100px;
        height: 100px;
        border: 2px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
      }

      .template-option:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .template-option.selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-color);
      }

      .template-option img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .completion-indicator {
        width: 100%;
        height: 15px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        margin-bottom: 15px;
      }

      .completion-fill {
        height: 100%;
        background-color: var(--primary-color);
        width: 0%;
        transition: width 0.3s ease;
      }

      .completion-text {
        text-align: center;
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
      }

      .achievements {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
      }

      .achievement-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin: 5px 0;
        opacity: 0.5;
        transition: all 0.3s;
      }

      .achievement-badge.unlocked {
        opacity: 1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .achievement-icon {
        font-size: 20px;
        color: goldenrod;
      }

      .achievement-info {
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .canvas-container {
          max-width: 100%;
          max-height: 60vh;
        }

        canvas {
          max-width: 100%;
        }

        .color-palette {
          gap: 8px;
        }

        .color-option {
          width: 30px;
          height: 30px;
        }

        .template-option {
          width: 80px;
          height: 80px;
        }

        .tool-buttons {
          flex-wrap: wrap;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a href="index.html" class="site-title">ç¶²é å°éŠæˆ²</a>
        <nav class="site-nav">
          <ul>
            <li><a href="index.html#games">éŠæˆ²åˆ—è¡¨</a></li>
            <li><a href="index.html#about">é—œæ–¼</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container">
      <div class="game-header">
        <h1>å¡«è‰²éŠæˆ²</h1>
        <div class="game-toolbar">
          <button id="helpButton" class="tool-button">éŠæˆ²èªªæ˜</button>
          <button id="pauseButton" class="tool-button">æš«åœ</button>
          <button id="restartButton" class="tool-button">é‡æ–°é–‹å§‹</button>
          <button id="homeButton" class="tool-button">è¿”å›é¦–é </button>
        </div>
      </div>

      <div class="score-display">åˆ†æ•¸: <span id="scoreValue">0</span></div>

      <div class="coloring-container">
        <div class="game-controls-top">
          <div class="brush-size-control">
            <span class="brush-size-label">ç­†åˆ·å°ºå¯¸:</span>
            <input type="range" id="brushSize" min="1" max="20" value="5" />
            <div id="brushPreview" class="brush-preview"></div>
          </div>

          <div class="tool-buttons">
            <button id="pencilTool" class="tool-button active" title="é‰›ç­†">
              <i class="fas fa-pencil-alt"></i> é‰›ç­†
            </button>
            <button id="fillTool" class="tool-button" title="å¡«å……">
              <i class="fas fa-fill-drip"></i> å¡«å……
            </button>
            <button id="eraserTool" class="tool-button" title="æ©¡çš®æ“¦">
              <i class="fas fa-eraser"></i> æ©¡çš®æ“¦
            </button>
            <button id="clearButton" class="tool-button" title="æ¸…é™¤ç•«å¸ƒ">
              <i class="fas fa-trash"></i> æ¸…é™¤
            </button>
            <button id="saveButton" class="tool-button" title="å„²å­˜åœ–ç‰‡">
              <i class="fas fa-save"></i> å„²å­˜
            </button>
          </div>
        </div>

        <div class="canvas-container">
          <canvas id="coloringCanvas" width="800" height="600"></canvas>
        </div>

        <div class="completion-indicator">
          <div id="completionFill" class="completion-fill"></div>
        </div>
        <div id="completionText" class="completion-text">å¡«è‰²å®Œæˆåº¦: 0%</div>

        <h3>é¸æ“‡é¡è‰²</h3>
        <div id="colorPalette" class="color-palette">
          <!-- é¡è‰²é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>

        <h3>é¸æ“‡åœ–æ¡ˆ</h3>
        <div id="templateSelector" class="template-selector">
          <!-- æ¨¡æ¿é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <div id="gamePaused" class="game-paused">æš«åœä¸­</div>
    </main>

    <script src="gameUtils.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŒ–éŠæˆ²å·¥å…·
        const helpModal = new GameUtils.Modal(
          "helpModal",
          "å¡«è‰²éŠæˆ² - éŠæˆ²èªªæ˜",
          `
            <h3>éŠæˆ²ä»‹ç´¹ï¼š</h3>
            <p>å¡«è‰²éŠæˆ²æ˜¯ä¸€æ¬¾æ”¾é¬†è€Œæœ‰è¶£çš„å‰µæ„éŠæˆ²ï¼Œä½ å¯ä»¥çµ¦å„ç¨®ç·šæ¢åœ–æ¡ˆå¡—ä¸Šé¡è‰²ï¼Œå‰µé€ å±¬æ–¼è‡ªå·±çš„è—è¡“ä½œå“ï¼</p>
            
            <h3>åŸºæœ¬æ“ä½œï¼š</h3>
            <ul>
              <li><strong>é‰›ç­†å·¥å…·</strong>ï¼šè‡ªç”±ç¹ªåœ–ï¼Œå¯èª¿æ•´ç­†åˆ·å°ºå¯¸</li>
              <li><strong>å¡«å……å·¥å…·</strong>ï¼šé»æ“Šå€åŸŸå¡«å……ç›¸åŒé¡è‰²</li>
              <li><strong>æ©¡çš®æ“¦</strong>ï¼šæ“¦é™¤å·²ç¹ªè£½çš„éƒ¨åˆ†</li>
              <li><strong>æ¸…é™¤ç•«å¸ƒ</strong>ï¼šé‡ç½®ç•¶å‰ç•«å¸ƒåˆ°åˆå§‹ç‹€æ…‹</li>
              <li><strong>å„²å­˜åœ–ç‰‡</strong>ï¼šå°‡ç•¶å‰ä½œå“å„²å­˜ç‚ºåœ–ç‰‡</li>
            </ul>
            
            <h3>éŠæˆ²æ¨¡å¼ï¼š</h3>
            <p>é¸æ“‡ä¸åŒçš„æ¨¡æ¿é€²è¡Œå¡«è‰²ï¼Œç³»çµ±æœƒæ ¹æ“šä½ çš„å¡«è‰²å®Œæˆåº¦å’Œå‰µæ„ç¨‹åº¦çµ¦äºˆåˆ†æ•¸ã€‚</p>
            
            <h3>éŠæˆ²ç›®æ¨™ï¼š</h3>
            <p>ç›¡å¯èƒ½å®Œç¾åœ°å¡«æ»¿æ‰€æœ‰å€åŸŸï¼Œå‰µé€ å‡ºç¾éº—çš„è—è¡“å“ï¼å¡«è‰²å®Œæˆåº¦é”åˆ°85%ä»¥ä¸Šå³å¯ç²å¾—æˆå°±ã€‚</p>
            
            <h3>æ“ä½œæç¤ºï¼š</h3>
            <ul>
              <li>ä½¿ç”¨å¡«å……å·¥å…·å¯ä»¥å¿«é€Ÿå¡«æ»¿å°é–‰å€åŸŸ</li>
              <li>ä½¿ç”¨ç´°ç­†åˆ·è™•ç†ç·šæ¢é‚Šç·£ï¼Œä½¿ä½œå“æ›´ç²¾ç·»</li>
              <li>é¡è‰²æ­é…å¾—ç•¶å¯ä»¥ç²å¾—æ›´é«˜çš„å‰µæ„åˆ†æ•¸</li>
            </ul>
          `
        );

        const gameController = new GameUtils.GameController();
        const scoreManager = new GameUtils.ScoreManager("scoreValue");

        // å–å¾— DOM å…ƒç´ 
        const canvas = document.getElementById("coloringCanvas");
        const ctx = canvas.getContext("2d");
        const brushSizeControl = document.getElementById("brushSize");
        const brushPreview = document.getElementById("brushPreview");
        const pencilTool = document.getElementById("pencilTool");
        const fillTool = document.getElementById("fillTool");
        const eraserTool = document.getElementById("eraserTool");
        const clearButton = document.getElementById("clearButton");
        const saveButton = document.getElementById("saveButton");
        const colorPalette = document.getElementById("colorPalette");
        const templateSelector = document.getElementById("templateSelector");
        const completionFill = document.getElementById("completionFill");
        const completionText = document.getElementById("completionText");

        // éŠæˆ²è®Šæ•¸
        let isDrawing = false;
        let currentColor = "#000000";
        let currentTool = "pencil";
        let brushSize = 5;
        let lastX = 0;
        let lastY = 0;
        let currentTemplate = null;
        let originalImageData = null;
        let gameActive = true;
        let templateImages = [];
        let completionPercentage = 0;

        // é¡è‰²é¸é …
        const colors = [
          "#000000", // é»‘è‰²
          "#FFFFFF", // ç™½è‰²
          "#FF0000", // ç´…è‰²
          "#00FF00", // ç¶ è‰²
          "#0000FF", // è—è‰²
          "#FFFF00", // é»ƒè‰²
          "#FF00FF", // æ´‹ç´…
          "#00FFFF", // é’è‰²
          "#FF8000", // æ©™è‰²
          "#8000FF", // ç´«è‰²
          "#0080FF", // å¤©è—
          "#FF0080", // ç²‰ç´…
          "#80FF00", // æ·¡ç¶ 
          "#008080", // æ·±é’
          "#800000", // è¤è‰²
          "#808000", // æ©„æ¬–
          "#008000", // æ·±ç¶ 
          "#000080", // æ·±è—
          "#808080", // ç°è‰²
        ];

        // æ¨¡æ¿é¸é … (ç·šæ¢åœ–æ¡ˆ)
        const templates = [
          {
            name: "èŠ±æœµ",
            path: "https://cdn.pixabay.com/photo/2016/03/31/23/37/drawing-1297720_1280.png",
          },
          {
            name: "è´è¶",
            path: "https://cdn.pixabay.com/photo/2018/10/01/00/46/coloring-3715500_1280.png",
          },
          {
            name: "é¢¨æ™¯",
            path: "https://cdn.pixabay.com/photo/2020/10/08/13/10/coloring-book-5638562_1280.png",
          },
          {
            name: "å‹•ç‰©",
            path: "https://cdn.pixabay.com/photo/2020/12/27/20/24/outline-5865633_1280.png",
          },
          {
            name: "å¹¾ä½•åœ–å½¢",
            path: "https://cdn.pixabay.com/photo/2016/03/31/23/26/mandala-1297569_1280.png",
          },
          {
            name: "åŸå ¡",
            path: "https://cdn.pixabay.com/photo/2019/10/31/20/41/coloring-4592517_1280.png",
          },
        ];

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
          // è¨­ç½®ç­†åˆ·å°ºå¯¸
          updateBrushPreview();

          // å‰µå»ºé¡è‰²é¸å–®
          createColorPalette();

          // å‰µå»ºæ¨¡æ¿é¸å–®
          createTemplateSelector();

          // æ¸…ç©ºåˆ†æ•¸
          scoreManager.set(0);

          // è¨­ç½®åˆå§‹ç•«å¸ƒ
          clearCanvas();

          // é åŠ è¼‰æ¨¡æ¿åœ–ç‰‡
          preloadImages();
        }

        // é åŠ è¼‰åœ–ç‰‡
        function preloadImages() {
          templates.forEach((template, index) => {
            const img = new Image();
            img.src = template.path;
            img.onload = function () {
              templateImages[index] = img;

              // å¦‚æœæ˜¯ç¬¬ä¸€å¼µåœ–ç‰‡ï¼Œé è¨­é¸æ“‡å®ƒ
              if (index === 0 && !currentTemplate) {
                selectTemplate(0);
              }
            };
            img.onerror = function () {
              console.error("Failed to load image: " + template.path);
            };
          });
        }

        // å‰µå»ºé¡è‰²é¸å–®
        function createColorPalette() {
          colorPalette.innerHTML = "";

          colors.forEach((color) => {
            const colorOption = document.createElement("div");
            colorOption.className = "color-option";
            colorOption.style.backgroundColor = color;
            colorOption.dataset.color = color;

            // é¸æ“‡é¡è‰²
            colorOption.addEventListener("click", function () {
              currentColor = color;

              // ç§»é™¤æ‰€æœ‰é¸ä¸­æ¨£å¼
              document.querySelectorAll(".color-option").forEach((opt) => {
                opt.classList.remove("selected");
              });

              // æ·»åŠ é¸ä¸­æ¨£å¼
              this.classList.add("selected");

              // æ›´æ–°ç­†åˆ·é è¦½
              brushPreview.style.backgroundColor = color;

              // å¦‚æœç•¶å‰æ˜¯æ©¡çš®æ“¦ï¼Œåˆ‡æ›åˆ°é‰›ç­†
              if (currentTool === "eraser") {
                currentTool = "pencil";
                updateToolButtons();
              }
            });

            colorPalette.appendChild(colorOption);
          });

          // é»˜èªé¸ä¸­ç¬¬ä¸€ç¨®é¡è‰²
          const firstColor = document.querySelector(".color-option");
          if (firstColor) {
            firstColor.classList.add("selected");
          }
        }

        // å‰µå»ºæ¨¡æ¿é¸å–®
        function createTemplateSelector() {
          templateSelector.innerHTML = "";

          templates.forEach((template, index) => {
            const templateOption = document.createElement("div");
            templateOption.className = "template-option";
            templateOption.dataset.index = index;

            const img = document.createElement("img");
            img.src = template.path;
            img.alt = template.name;

            templateOption.appendChild(img);

            // é¸æ“‡æ¨¡æ¿
            templateOption.addEventListener("click", function () {
              const index = parseInt(this.dataset.index);
              selectTemplate(index);
            });

            templateSelector.appendChild(templateOption);
          });
        }

        // é¸æ“‡æ¨¡æ¿
        function selectTemplate(index) {
          // ç§»é™¤ä¹‹å‰çš„é¸æ“‡
          document.querySelectorAll(".template-option").forEach((opt) => {
            opt.classList.remove("selected");
          });

          // æ·»åŠ é¸ä¸­æ¨£å¼
          const selectedOption = document.querySelector(
            `.template-option[data-index="${index}"]`
          );
          if (selectedOption) {
            selectedOption.classList.add("selected");
          }

          currentTemplate = index;

          // è¼‰å…¥æ¨¡æ¿åˆ°ç•«å¸ƒ
          if (templateImages[index]) {
            loadTemplate(templateImages[index]);
          }

          // é‡ç½®å®Œæˆåº¦
          updateCompletionPercentage(0);
        }

        // è¼‰å…¥æ¨¡æ¿åˆ°ç•«å¸ƒ
        function loadTemplate(img) {
          // æ¸…ç©ºç•«å¸ƒ
          clearCanvas();

          // æ ¹æ“šç•«å¸ƒå°ºå¯¸èª¿æ•´åœ–åƒå¤§å°
          const aspectRatio = img.width / img.height;
          let drawWidth, drawHeight;

          if (canvas.width / canvas.height > aspectRatio) {
            // ç•«å¸ƒæ›´å¯¬
            drawHeight = canvas.height * 0.9;
            drawWidth = drawHeight * aspectRatio;
          } else {
            // ç•«å¸ƒæ›´é«˜
            drawWidth = canvas.width * 0.9;
            drawHeight = drawWidth / aspectRatio;
          }

          // åœ¨ç•«å¸ƒä¸­å¤®ç¹ªè£½åœ–åƒ
          const x = (canvas.width - drawWidth) / 2;
          const y = (canvas.height - drawHeight) / 2;

          ctx.drawImage(img, x, y, drawWidth, drawHeight);

          // ä¿å­˜åŸå§‹åœ–åƒæ•¸æ“š
          originalImageData = ctx.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          );

          // åˆå§‹åŒ–å®Œæˆåº¦
          updateCompletionPercentage(0);
        }

        // æ›´æ–°ç­†åˆ·é è¦½
        function updateBrushPreview() {
          brushSize = parseInt(brushSizeControl.value);
          brushPreview.style.width = brushSize + "px";
          brushPreview.style.height = brushSize + "px";
          brushPreview.style.backgroundColor = currentColor;
        }

        // æ›´æ–°å·¥å…·æŒ‰éˆ•ç‹€æ…‹
        function updateToolButtons() {
          pencilTool.classList.toggle("active", currentTool === "pencil");
          fillTool.classList.toggle("active", currentTool === "fill");
          eraserTool.classList.toggle("active", currentTool === "eraser");

          if (currentTool === "eraser") {
            brushPreview.style.backgroundColor = "#FFFFFF";
          } else {
            brushPreview.style.backgroundColor = currentColor;
          }
        }

        // æ¸…ç©ºç•«å¸ƒ
        function clearCanvas() {
          ctx.fillStyle = "#FFFFFF";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // å¦‚æœæœ‰ç•¶å‰æ¨¡æ¿ï¼Œé‡æ–°è¼‰å…¥
          if (currentTemplate !== null && templateImages[currentTemplate]) {
            loadTemplate(templateImages[currentTemplate]);
          }

          // é‡ç½®å®Œæˆåº¦
          updateCompletionPercentage(0);
        }

        // è¨ˆç®—å¡«è‰²å®Œæˆåº¦
        function calculateCompletion() {
          if (!originalImageData) return 0;

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          const originalData = originalImageData.data;

          let coloredPixels = 0;
          let totalColorablePixels = 0;

          for (let i = 0; i < data.length; i += 4) {
            // å¦‚æœåŸåœ–æ˜¯é»‘è‰²ç·šæ¢ (RGBéƒ½å°æ–¼100)
            if (
              originalData[i] < 100 &&
              originalData[i + 1] < 100 &&
              originalData[i + 2] < 100
            ) {
              continue; // è·³éç·šæ¢éƒ¨åˆ†
            }

            // å¦‚æœåŸåœ–æ˜¯ç™½è‰²èƒŒæ™¯ (RGBéƒ½å¤§æ–¼200)
            if (
              originalData[i] > 200 &&
              originalData[i + 1] > 200 &&
              originalData[i + 2] > 200
            ) {
              totalColorablePixels++;

              // å¦‚æœç•¶å‰åƒç´ ä¸æ˜¯ç™½è‰² (å·²å¡«è‰²)
              if (data[i] < 250 || data[i + 1] < 250 || data[i + 2] < 250) {
                coloredPixels++;
              }
            }
          }

          return totalColorablePixels > 0
            ? (coloredPixels / totalColorablePixels) * 100
            : 0;
        }

        // æ›´æ–°å®Œæˆåº¦é¡¯ç¤º
        function updateCompletionPercentage(percentage) {
          completionPercentage = percentage;
          completionFill.style.width = percentage + "%";
          completionText.textContent = `å¡«è‰²å®Œæˆåº¦: ${Math.round(percentage)}%`;

          // æ ¹æ“šå®Œæˆåº¦çµ¦äºˆåˆ†æ•¸
          if (percentage >= 25 && !achievements.quarter) {
            achievements.quarter = true;
            scoreManager.add(10);
            showAchievement("å¡«è‰²å°æ–°æ‰‹", "å®Œæˆ25%çš„å¡«è‰²");
          }

          if (percentage >= 50 && !achievements.half) {
            achievements.half = true;
            scoreManager.add(25);
            showAchievement("åŠé€”æˆåŠŸ", "å®Œæˆ50%çš„å¡«è‰²");
          }

          if (percentage >= 75 && !achievements.threeQuarters) {
            achievements.threeQuarters = true;
            scoreManager.add(50);
            showAchievement("æ¥è¿‘å®Œæˆ", "å®Œæˆ75%çš„å¡«è‰²");
          }

          if (percentage >= 95 && !achievements.complete) {
            achievements.complete = true;
            scoreManager.add(100);
            showAchievement("å¡«è‰²å¤§å¸«", "å¹¾ä¹å®Œæˆå…¨éƒ¨å¡«è‰²(95%ä»¥ä¸Š)ï¼");

            // é¡¯ç¤ºå®Œæˆå°è©±æ¡†
            gameController.showMessage(
              "æ­å–œå®Œæˆï¼",
              `
              <div style="text-align:center;">
                <p>å¤ªæ£’äº†ï¼ä½ æˆåŠŸå®Œæˆäº†é€™å¹…ä½œå“ï¼</p>
                <p>å®Œæˆåº¦: ${Math.round(percentage)}%</p>
                <p>ç²å¾—åˆ†æ•¸: 100</p>
                <button id="nextTemplateBtn" class="primary-button">ä¸‹ä¸€å¹…ä½œå“</button>
              </div>
              `
            );

            setTimeout(() => {
              document
                .getElementById("nextTemplateBtn")
                .addEventListener("click", () => {
                  gameController.hideMessage();

                  // é¸æ“‡ä¸‹ä¸€å€‹æ¨¡æ¿
                  const nextTemplate = (currentTemplate + 1) % templates.length;
                  selectTemplate(nextTemplate);
                });
            }, 100);
          }
        }

        // æˆå°±ç³»çµ±
        const achievements = {
          quarter: false,
          half: false,
          threeQuarters: false,
          complete: false,
        };

        // é¡¯ç¤ºæˆå°±
        function showAchievement(title, description) {
          gameController.showNotification(`ğŸ† ${title}`, description);
        }

        // å¡«å……å·¥å…·å‡½æ•¸
        function floodFill(startX, startY, fillColor) {
          // ç²å–ç•«å¸ƒæ•¸æ“š
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          // ç²å–èµ·å§‹é»çš„é¡è‰²
          const startIndex = (startY * canvas.width + startX) * 4;
          const startR = data[startIndex];
          const startG = data[startIndex + 1];
          const startB = data[startIndex + 2];

          // å¦‚æœé»æ“Šçš„é¡è‰²å’Œå¡«å……é¡è‰²ç›¸åŒï¼Œå‰‡ä¸éœ€è¦å¡«å……
          const fillR = parseInt(fillColor.substring(1, 3), 16);
          const fillG = parseInt(fillColor.substring(3, 5), 16);
          const fillB = parseInt(fillColor.substring(5, 7), 16);

          if (
            Math.abs(startR - fillR) < 10 &&
            Math.abs(startG - fillG) < 10 &&
            Math.abs(startB - fillB) < 10
          ) {
            return;
          }

          // å®¹å¿åº¦è¨­å®š (ç›¸ä¼¼é¡è‰²çš„ç¯„åœ)
          const tolerance = 30;

          // ä½¿ç”¨éšŠåˆ—å¯¦ç¾æ¼«æ°´å¡«å……ç®—æ³•
          const queue = [[startX, startY]];
          const visited = new Array(canvas.width * canvas.height).fill(false);

          while (queue.length > 0) {
            const [x, y] = queue.shift();
            const index = (y * canvas.width + x) * 4;

            // å¦‚æœè¶…å‡ºç•«å¸ƒç¯„åœæˆ–å·²è¨ªå•é
            if (
              x < 0 ||
              x >= canvas.width ||
              y < 0 ||
              y >= canvas.height ||
              visited[y * canvas.width + x]
            ) {
              continue;
            }

            // æª¢æŸ¥é¡è‰²æ˜¯å¦ç›¸ä¼¼
            const r = data[index];
            const g = data[index + 1];
            const b = data[index + 2];

            if (
              Math.abs(r - startR) <= tolerance &&
              Math.abs(g - startG) <= tolerance &&
              Math.abs(b - startB) <= tolerance
            ) {
              // å¡«å……è©²é»
              data[index] = fillR;
              data[index + 1] = fillG;
              data[index + 2] = fillB;

              // æ¨™è¨˜ç‚ºå·²è¨ªå•
              visited[y * canvas.width + x] = true;

              // å°‡ç›¸é„°å››å€‹é»åŠ å…¥éšŠåˆ—
              queue.push([x + 1, y]);
              queue.push([x - 1, y]);
              queue.push([x, y + 1]);
              queue.push([x, y - 1]);
            }
          }

          // æ›´æ–°ç•«å¸ƒ
          ctx.putImageData(imageData, 0, 0);

          // æ›´æ–°å®Œæˆåº¦
          const completion = calculateCompletion();
          updateCompletionPercentage(completion);
        }

        // ç¹ªåœ–åŠŸèƒ½
        function startDrawing(e) {
          if (!gameActive) return;

          isDrawing = true;

          // ç²å–é¼ æ¨™ç›¸å°æ–¼ç•«å¸ƒçš„ä½ç½®
          const rect = canvas.getBoundingClientRect();
          lastX = e.clientX - rect.left;
          lastY = e.clientY - rect.top;

          // å¦‚æœæ˜¯å¡«å……å·¥å…·ï¼ŒåŸ·è¡Œå¡«å……
          if (currentTool === "fill") {
            floodFill(Math.floor(lastX), Math.floor(lastY), currentColor);
            isDrawing = false;
            return;
          }

          // ç¹ªè£½ä¸€å€‹é»
          ctx.beginPath();
          ctx.arc(lastX, lastY, brushSize / 2, 0, Math.PI * 2);
          ctx.fillStyle = currentTool === "eraser" ? "#FFFFFF" : currentColor;
          ctx.fill();
        }

        function draw(e) {
          if (!isDrawing || !gameActive) return;

          // å¡«å……å·¥å…·ä¸éœ€è¦æ‹–æ›³
          if (currentTool === "fill") return;

          // ç²å–é¼ æ¨™ä½ç½®
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // è¨­ç½®ç¹ªåœ–æ¨£å¼
          ctx.lineWidth = brushSize;
          ctx.lineCap = "round";
          ctx.strokeStyle = currentTool === "eraser" ? "#FFFFFF" : currentColor;

          // ç¹ªè£½ç·šæ®µ
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();

          // æ›´æ–°ä¸Šä¸€é»ä½ç½®
          lastX = x;
          lastY = y;
        }

        function stopDrawing() {
          if (!isDrawing) return;
          isDrawing = false;

          // å¦‚æœä¸æ˜¯å¡«å……å·¥å…·ï¼Œè¨ˆç®—å¡«è‰²å®Œæˆåº¦
          if (currentTool !== "fill") {
            const completion = calculateCompletion();
            updateCompletionPercentage(completion);
          }
        }

        // ä¿å­˜åœ–ç‰‡
        function saveImage() {
          // å‰µå»ºä¸€å€‹è‡¨æ™‚é€£çµ
          const link = document.createElement("a");
          link.download = `å¡«è‰²ä½œå“_${new Date().toLocaleDateString()}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();

          // çµ¦äºˆçå‹µ
          if (!achievements.saved) {
            achievements.saved = true;
            scoreManager.add(15);
            showAchievement("è—è¡“å®¶", "ä¿å­˜äº†ä½ çš„ç¬¬ä¸€å¹…ä½œå“");
          }
        }

        // äº‹ä»¶ç›£è½å™¨
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);

        // è§¸æ‘¸è¨­å‚™æ”¯æŒ
        canvas.addEventListener("touchstart", function (e) {
          e.preventDefault();
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent("mousedown", {
            clientX: touch.clientX,
            clientY: touch.clientY,
          });
          canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener("touchmove", function (e) {
          e.preventDefault();
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent("mousemove", {
            clientX: touch.clientX,
            clientY: touch.clientY,
          });
          canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener("touchend", function (e) {
          e.preventDefault();
          const mouseEvent = new MouseEvent("mouseup");
          canvas.dispatchEvent(mouseEvent);
        });

        // å·¥å…·é¸æ“‡
        pencilTool.addEventListener("click", function () {
          currentTool = "pencil";
          updateToolButtons();
        });

        fillTool.addEventListener("click", function () {
          currentTool = "fill";
          updateToolButtons();
        });

        eraserTool.addEventListener("click", function () {
          currentTool = "eraser";
          updateToolButtons();
        });

        // æ¸…é™¤æŒ‰éˆ•
        clearButton.addEventListener("click", function () {
          if (confirm("ç¢ºå®šè¦æ¸…é™¤ç•«å¸ƒå—ï¼Ÿ")) {
            clearCanvas();
          }
        });

        // ä¿å­˜æŒ‰éˆ•
        saveButton.addEventListener("click", saveImage);

        // ç­†åˆ·å°ºå¯¸æ§åˆ¶
        brushSizeControl.addEventListener("input", updateBrushPreview);

        // è¨­ç½®éŠæˆ²æ§åˆ¶å™¨
        gameController.setGameLoop(() => {
          // é€™å€‹éŠæˆ²ä¸éœ€è¦éŠæˆ²å¾ªç’°
        });

        // è¨­ç½®é‡å•Ÿè™•ç†å™¨
        gameController.setRestartHandler(() => {
          clearCanvas();

          // é‡ç½®æˆå°±
          Object.keys(achievements).forEach((key) => {
            achievements[key] = false;
          });

          scoreManager.set(0);

          // å¦‚æœç•¶å‰æœ‰é¸æ“‡æ¨¡æ¿ï¼Œé‡æ–°è¼‰å…¥
          if (currentTemplate !== null) {
            selectTemplate(currentTemplate);
          }
        });

        // è™•ç†æš«åœç‹€æ…‹è®ŠåŒ–
        gameController.onPauseStateChange = function (isPaused) {
          const pauseIndicator = document.getElementById("gamePaused");
          if (pauseIndicator) {
            pauseIndicator.style.display = isPaused ? "flex" : "none";
          }
          gameActive = !isPaused;
        };

        // åˆå§‹åŒ–éŠæˆ²
        initGame();

        // é¡¯ç¤ºé–‹å§‹å¼•å°
        gameController.showStartAnimation(() => {
          gameController.showMessage(
            "æ­¡è¿ä¾†åˆ°å¡«è‰²éŠæˆ²",
            `
            <div style="text-align:center;">
              <p>é‡‹æ”¾ä½ çš„å‰µæ„ï¼Œäº«å—å¡«è‰²çš„æ¨‚è¶£ï¼</p>
              <p>é¸æ“‡ä¸åŒçš„æ¨¡æ¿ã€é¡è‰²å’Œå·¥å…·ï¼Œå‰µé€ å‡ºä½ ç¨ç‰¹çš„è—è¡“å“ã€‚</p>
              <p>ç•¶ä½ å®Œæˆä¸€å¹…ä½œå“ï¼Œå°±å¯ä»¥ç²å¾—åˆ†æ•¸å’Œæˆå°±ã€‚</p>
              <button id="startGameBtn" class="primary-button">é–‹å§‹å‰µä½œ</button>
            </div>
            `
          );

          setTimeout(() => {
            document
              .getElementById("startGameBtn")
              .addEventListener("click", () => {
                gameController.hideMessage();
              });
          }, 100);
        });
      });
    </script>
  </body>
</html>
