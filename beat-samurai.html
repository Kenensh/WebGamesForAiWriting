<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç¯€æ‹æ­¦å£« - Beat Samurai</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #2c3e50 0%, #fd79a8 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Arial", sans-serif;
        overflow: hidden;
      }

      .game-container {
        width: 90vw;
        height: 90vh;
        max-width: 900px;
        max-height: 700px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 30px;
        text-align: center;
        position: relative;
      }

      h1 {
        color: white;
        font-size: 2.5em;
        margin-bottom: 20px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .game-stats {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        margin-bottom: 20px;
        color: white;
        font-size: 1em;
      }

      .stat-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .rhythm-track {
        width: 100%;
        height: 80px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        margin: 20px 0;
        position: relative;
        overflow: hidden;
      }

      .beat-line {
        position: absolute;
        width: 3px;
        height: 100%;
        background: linear-gradient(0deg, #3498db, #2ecc71);
        animation: beatMove 2s linear infinite;
      }

      @keyframes beatMove {
        from {
          left: -3px;
        }
        to {
          left: 100%;
        }
      }

      .game-area {
        width: 100%;
        height: 350px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        position: relative;
        margin: 20px 0;
        overflow: hidden;
      }

      .slash-zone {
        position: absolute;
        width: 120px;
        height: 120px;
        border: 3px dashed rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2em;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .slash-zone:hover {
        border-color: #f39c12;
        background: rgba(241, 196, 15, 0.2);
        transform: scale(1.05);
      }

      .slash-zone.active {
        border-color: #2ecc71;
        background: rgba(46, 204, 113, 0.3);
        animation: zoneActive 0.5s ease;
      }

      @keyframes zoneActive {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .beat-target {
        position: absolute;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: targetApproach linear;
        border: 3px solid white;
      }

      .beat-target.normal {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .beat-target.perfect {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        border-color: #f39c12;
        animation: perfectGlow 1s infinite;
      }

      .beat-target.combo {
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        border-color: #9b59b6;
      }

      .beat-target.slashed {
        animation: slashEffect 0.5s ease;
      }

      .beat-target.missed {
        animation: missEffect 0.5s ease;
      }

      @keyframes targetApproach {
        from {
          transform: scale(0.3) rotate(0deg);
          opacity: 0.7;
        }
        to {
          transform: scale(1) rotate(360deg);
          opacity: 1;
        }
      }

      @keyframes perfectGlow {
        0%,
        100% {
          box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(241, 196, 15, 0.8);
        }
      }

      @keyframes slashEffect {
        0% {
          transform: scale(1) rotate(0deg);
        }
        50% {
          transform: scale(1.5) rotate(180deg);
          background: radial-gradient(circle, #2ecc71, #27ae60);
        }
        100% {
          transform: scale(0) rotate(360deg);
          opacity: 0;
        }
      }

      @keyframes missEffect {
        0% {
          transform: scale(1);
        }
        100% {
          transform: scale(0.5);
          opacity: 0;
          background: #e74c3c;
        }
      }

      .combo-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 3em;
        color: #f39c12;
        font-weight: bold;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        transform: scale(1);
        transition: all 0.3s ease;
      }

      .combo-indicator.highlight {
        transform: scale(1.3);
        color: #e74c3c;
        animation: comboFlash 0.5s ease;
      }

      @keyframes comboFlash {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .precision-meter {
        width: 100%;
        height: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 7px;
        margin: 15px 0;
        overflow: hidden;
      }

      .precision-fill {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
        border-radius: 7px;
        transition: width 0.3s ease;
        width: 50%;
      }

      .controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 25px;
        background: linear-gradient(45deg, #2c3e50, #fd79a8);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .difficulty-select {
        margin-bottom: 20px;
      }

      .difficulty-btn {
        margin: 0 5px;
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .difficulty-btn.active {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
      }

      .status {
        color: white;
        font-size: 1.3em;
        margin: 15px 0;
        min-height: 30px;
        font-weight: bold;
      }

      .slash-trail {
        position: absolute;
        pointer-events: none;
        width: 4px;
        height: 100px;
        background: linear-gradient(45deg, #2ecc71, rgba(46, 204, 113, 0));
        transform-origin: bottom;
        animation: slashTrail 0.3s ease-out;
      }

      @keyframes slashTrail {
        0% {
          opacity: 1;
          transform: scaleY(0);
        }
        100% {
          opacity: 0;
          transform: scaleY(1);
        }
      }

      .beat-feedback {
        position: absolute;
        font-size: 2em;
        font-weight: bold;
        color: #f39c12;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        pointer-events: none;
        animation: feedbackFloat 1s ease-out forwards;
      }

      @keyframes feedbackFloat {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-50px) scale(1.2);
        }
      }

      @media (max-width: 768px) {
        .game-container {
          width: 95vw;
          height: 95vh;
          padding: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .game-stats {
          grid-template-columns: repeat(3, 1fr);
          font-size: 0.9em;
        }

        .beat-target {
          width: 60px;
          height: 60px;
        }

        .slash-zone {
          width: 100px;
          height: 100px;
          font-size: 1.5em;
        }
        .game-area {
          height: 300px;
        }
      }

      /* æ¨¡æ…‹æ¡†æ¨£å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: linear-gradient(135deg, #2c3e50 0%, #fd79a8 100%);
        margin: 5% auto;
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        color: white;
        max-height: 80vh;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      }

      .modal-header h2 {
        margin: 0;
        color: #fd79a8;
        font-size: 24px;
      }

      .close-btn {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close-btn:hover {
        color: #fd79a8;
      }

      .modal-body {
        line-height: 1.6;
      }

      .modal-body h3 {
        color: #74b9ff;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      .modal-body ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      .modal-body li {
        margin: 5px 0;
      }

      .modal-footer {
        text-align: center;
        padding-top: 20px;
        border-top: 2px solid rgba(255, 255, 255, 0.2);
        margin-top: 20px;
      }

      .modal-btn {
        background: linear-gradient(45deg, #fd79a8, #fdcb6e);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .modal-btn:hover {
        background: linear-gradient(45deg, #fdcb6e, #fd79a8);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>âš”ï¸ ç¯€æ‹æ­¦å£«</h1>

      <div class="game-stats">
        <div class="stat-box">åˆ†æ•¸: <span id="score">0</span></div>
        <div class="stat-box">é€£æ“Š: <span id="combo">0</span></div>
        <div class="stat-box">ç²¾æº–åº¦: <span id="precision">100%</span></div>
        <div class="stat-box">ç­‰ç´š: <span id="level">1</span></div>
        <div class="stat-box">æ™‚é–“: <span id="timer">90</span></div>
      </div>

      <div class="rhythm-track" id="rhythmTrack">
        <!-- ç¯€æ‹ç·šæ¢å°‡ç”±JSç”Ÿæˆ -->
      </div>

      <div class="precision-meter">
        <div class="precision-fill" id="precisionFill"></div>
      </div>

      <div class="difficulty-select">
        <button class="btn difficulty-btn active" data-difficulty="normal">
          æ™®é€š
        </button>
        <button class="btn difficulty-btn" data-difficulty="hard">å›°é›£</button>
        <button class="btn difficulty-btn" data-difficulty="master">
          å¤§å¸«
        </button>
      </div>

      <div class="status" id="status">
        æº–å‚™æˆç‚ºç¯€æ‹æ­¦å£«ï¼åœ¨æ­£ç¢ºçš„æ™‚æ©Ÿæ–¬æ“Šç›®æ¨™ï¼
      </div>

      <div class="game-area" id="gameArea">
        <div class="combo-indicator" id="comboIndicator">0</div>

        <!-- æ–¬æ“Šå€åŸŸ -->
        <div class="slash-zone" id="slashZone1" style="top: 50px; left: 50px">
          âš”ï¸
        </div>
        <div class="slash-zone" id="slashZone2" style="top: 50px; right: 50px">
          âš”ï¸
        </div>
        <div
          class="slash-zone"
          id="slashZone3"
          style="bottom: 50px; left: 50px"
        >
          âš”ï¸
        </div>
        <div
          class="slash-zone"
          id="slashZone4"
          style="bottom: 50px; right: 50px"
        >
          âš”ï¸
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="startBtn">é–‹å§‹éŠæˆ²</button>
        <button class="btn" id="pauseBtn" style="display: none">æš«åœ</button>
        <button class="btn" id="resetBtn">é‡æ–°é–‹å§‹</button>
        <button class="btn" id="helpBtn">éŠæˆ²èªªæ˜</button>
      </div>
    </div>

    <!-- éŠæˆ²èªªæ˜æ¨¡æ…‹æ¡† -->
    <div id="helpModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âš”ï¸ ç¯€æ‹æ­¦å£« - éŠæˆ²èªªæ˜</h2>
          <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
          <h3>ğŸ¯ éŠæˆ²ç›®æ¨™</h3>
          <p>è·Ÿéš¨éŸ³æ¨‚ç¯€æ‹ï¼Œåœ¨ç²¾ç¢ºçš„æ™‚æ©Ÿåˆ‡å‰²é£›ä¾†çš„ç›®æ¨™ï¼Œæˆç‚ºæœ€å¼·çš„ç¯€æ‹æ­¦å£«ï¼</p>

          <h3>ğŸ® æ“ä½œæ–¹å¼</h3>
          <ul>
            <li>è§€å¯Ÿè¢å¹•ä¸Šæ–¹çš„ç¯€æ‹ç·šï¼Œå®ƒæœƒæŒ‡ç¤ºæœ€ä½³åˆ‡å‰²æ™‚æ©Ÿ</li>
            <li>ç•¶ç›®æ¨™ç‰©é«”é£›å…¥åˆ‡å‰²å€åŸŸæ™‚ï¼Œåœ¨ç¯€æ‹ä¸Šé»æ“Šé€²è¡Œåˆ‡å‰²</li>
            <li>åœ¨å®Œç¾æ™‚æ©Ÿåˆ‡å‰²å¯ä»¥ç²å¾—æœ€é«˜åˆ†æ•¸</li>
            <li>éŒ¯éæ™‚æ©Ÿæˆ–åˆ‡å‰²å¤±æ•—æœƒä¸­æ–·é€£æ“Š</li>
          </ul>

          <h3>âš¡ åˆ‡å‰²æ™‚æ©Ÿ</h3>
          <ul>
            <li><strong>å®Œç¾ (Perfect)ï¼š</strong>åœ¨ç¯€æ‹ç·šç¶“éæ™‚åˆ‡å‰² - 200åˆ†</li>
            <li><strong>å¾ˆå¥½ (Great)ï¼š</strong>æ™‚æ©Ÿç•¥æœ‰åå·® - 150åˆ†</li>
            <li><strong>ä¸éŒ¯ (Good)ï¼š</strong>æ™‚æ©Ÿåå·®è¼ƒå¤§ - 100åˆ†</li>
            <li><strong>éŒ¯é (Miss)ï¼š</strong>å®Œå…¨éŒ¯éæ™‚æ©Ÿ - 0åˆ†</li>
          </ul>

          <h3>ğŸ”¥ é€£æ“Šç³»çµ±</h3>
          <ul>
            <li>é€£çºŒæˆåŠŸåˆ‡å‰²å¯ä»¥å»ºç«‹é€£æ“Š</li>
            <li>æ›´é«˜çš„é€£æ“Šæœƒæä¾›åˆ†æ•¸å€æ•¸åŠ æˆ</li>
            <li>éŒ¯éåˆ‡å‰²æœƒé‡ç½®é€£æ“Šæ•¸</li>
            <li>ä¿æŒé€£æ“Šæ˜¯ç²å¾—é«˜åˆ†çš„é—œéµ</li>
          </ul>

          <h3>ğŸ“Š é›£åº¦ç­‰ç´š</h3>
          <ul>
            <li><strong>æ™®é€šï¼š</strong>é©ä¸­çš„é€Ÿåº¦å’Œå¯¬é¬†çš„æ™‚æ©Ÿåˆ¤å®š</li>
            <li><strong>å›°é›£ï¼š</strong>æ›´å¿«çš„é€Ÿåº¦å’Œåš´æ ¼çš„æ™‚æ©Ÿåˆ¤å®š</li>
            <li><strong>å¤§å¸«ï¼š</strong>æ¥µå¿«é€Ÿåº¦å’Œæ¥µå…¶ç²¾ç¢ºçš„æ™‚æ©Ÿè¦æ±‚</li>
          </ul>

          <h3>ğŸ† è¨ˆåˆ†æŠ€å·§</h3>
          <ul>
            <li>å°ˆæ³¨æ–¼ç¯€æ‹ç·šï¼Œè€Œä¸æ˜¯ç›®æ¨™ç‰©é«”</li>
            <li>ç·´ç¿’è·Ÿéš¨éŸ³æ¨‚ç¯€å¥ï¼ŒåŸ¹é¤Šç¯€æ‹æ„Ÿ</li>
            <li>å„ªå…ˆä¿æŒé€£æ“Šï¼Œè€Œä¸æ˜¯è¿½æ±‚å–®æ¬¡é«˜åˆ†</li>
            <li>è§€å¯Ÿç²¾æº–åº¦æ¢ï¼Œç¶­æŒé«˜ç²¾æº–åº¦å¯ç²å¾—é¡å¤–çå‹µ</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="modal-btn" onclick="beatSamurai.closeHelp()">
            é–‹å§‹æŒ‘æˆ°
          </button>
        </div>
      </div>
    </div>

    <script>
      class BeatSamurai {
        constructor() {
          this.gameArea = document.getElementById("gameArea");
          this.rhythmTrack = document.getElementById("rhythmTrack");
          this.startBtn = document.getElementById("startBtn");
          this.pauseBtn = document.getElementById("pauseBtn");
          this.resetBtn = document.getElementById("resetBtn");
          this.status = document.getElementById("status");
          this.scoreEl = document.getElementById("score");
          this.comboEl = document.getElementById("combo");
          this.precisionEl = document.getElementById("precision");
          this.levelEl = document.getElementById("level");
          this.timerEl = document.getElementById("timer");
          this.comboIndicator = document.getElementById("comboIndicator");
          this.precisionFill = document.getElementById("precisionFill");

          this.score = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.level = 1;
          this.timeLeft = 90;
          this.precision = 100;
          this.totalTargets = 0;
          this.hitTargets = 0;
          this.gameActive = false;
          this.isPaused = false;
          this.difficulty = "normal";

          this.targets = [];
          this.slashZones = [];
          this.beatInterval = 500; // ç¯€æ‹é–“éš”
          this.currentBeat = 0;

          this.difficulties = {
            normal: { targetSpeed: 3000, spawnRate: 1500, perfectWindow: 200 },
            hard: { targetSpeed: 2500, spawnRate: 1200, perfectWindow: 150 },
            master: { targetSpeed: 2000, spawnRate: 1000, perfectWindow: 100 },
          };

          this.spawnInterval = null;
          this.timerInterval = null;
          this.beatInterval = null;

          this.initializeGame();
        }
        initializeGame() {
          this.setupSlashZones();
          this.createRhythmTrack();

          this.startBtn.addEventListener("click", () => this.startGame());
          this.pauseBtn.addEventListener("click", () => this.pauseGame());
          this.resetBtn.addEventListener("click", () => this.resetGame());

          // æ·»åŠ HelpæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
          const helpBtn = document.getElementById("helpBtn");
          if (helpBtn) {
            helpBtn.addEventListener("click", () => this.showHelp());
          }

          document.querySelectorAll(".difficulty-btn").forEach((btn) => {
            btn.addEventListener("click", (e) =>
              this.setDifficulty(e.target.dataset.difficulty)
            );
          });

          // éµç›¤æ§åˆ¶
          document.addEventListener("keydown", (e) => this.handleKeyPress(e));

          this.updateDisplay();
        }

        showHelp() {
          const modal = document.getElementById("helpModal");
          if (modal) {
            modal.style.display = "flex";

            // æ·»åŠ é—œé–‰æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const closeBtn = modal.querySelector(".close-help");
            if (closeBtn) {
              closeBtn.onclick = () => this.closeHelp();
            }

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            modal.onclick = (e) => {
              if (e.target === modal) {
                this.closeHelp();
              }
            };

            // ESCéµé—œé–‰
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                this.closeHelp();
              }
            });
          }
        }

        closeHelp() {
          const modal = document.getElementById("helpModal");
          if (modal) {
            modal.style.display = "none";
          }
        }

        setupSlashZones() {
          this.slashZones = [
            document.getElementById("slashZone1"),
            document.getElementById("slashZone2"),
            document.getElementById("slashZone3"),
            document.getElementById("slashZone4"),
          ];

          this.slashZones.forEach((zone, index) => {
            zone.addEventListener("click", () => this.handleSlash(index));
            zone.dataset.index = index;
          });
        }

        createRhythmTrack() {
          // å‰µå»ºç¯€æ‹å¯è¦–åŒ–
          for (let i = 0; i < 20; i++) {
            const beatLine = document.createElement("div");
            beatLine.className = "beat-line";
            beatLine.style.animationDelay = i * 0.1 + "s";
            this.rhythmTrack.appendChild(beatLine);
          }
        }

        setDifficulty(diff) {
          if (this.gameActive) return;

          this.difficulty = diff;
          document.querySelectorAll(".difficulty-btn").forEach((btn) => {
            btn.classList.remove("active");
          });
          document
            .querySelector(`[data-difficulty="${diff}"]`)
            .classList.add("active");
        }

        startGame() {
          this.gameActive = true;
          this.isPaused = false;
          this.score = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.level = 1;
          this.timeLeft = 90;
          this.precision = 100;
          this.totalTargets = 0;
          this.hitTargets = 0;

          this.clearTargets();
          this.updateDisplay();
          this.startSpawning();
          this.startTimer();
          this.startBeatTracker();

          this.startBtn.style.display = "none";
          this.pauseBtn.style.display = "inline-block";
          this.status.textContent = "éŠæˆ²é–‹å§‹ï¼è·Ÿéš¨ç¯€æ‹æ–¬æ“Šç›®æ¨™ï¼";
        }

        startSpawning() {
          const config = this.difficulties[this.difficulty];

          this.spawnInterval = setInterval(() => {
            if (!this.isPaused && this.gameActive) {
              this.spawnTarget();
            }
          }, config.spawnRate);
        }

        startTimer() {
          this.timerInterval = setInterval(() => {
            if (!this.isPaused && this.gameActive) {
              this.timeLeft--;
              this.updateDisplay();

              if (this.timeLeft <= 0) {
                this.endGame();
              }

              // æ¯20ç§’æå‡ç­‰ç´š
              if (this.timeLeft % 20 === 0 && this.timeLeft < 90) {
                this.levelUp();
              }
            }
          }, 1000);
        }

        startBeatTracker() {
          this.beatInterval = setInterval(() => {
            if (!this.isPaused && this.gameActive) {
              this.currentBeat++;
              this.updateBeatVisuals();
            }
          }, this.beatInterval);
        }

        updateBeatVisuals() {
          // æ›´æ–°ç¯€æ‹å¯è¦–åŒ–æ•ˆæœ
          this.slashZones.forEach((zone, index) => {
            if (this.currentBeat % 4 === index) {
              zone.style.borderColor = "#f39c12";
              zone.style.background = "rgba(241, 196, 15, 0.3)";
              setTimeout(() => {
                zone.style.borderColor = "rgba(255, 255, 255, 0.5)";
                zone.style.background = "rgba(255, 255, 255, 0.1)";
              }, this.beatInterval / 2);
            }
          });
        }

        spawnTarget() {
          const zoneIndex = Math.floor(Math.random() * 4);
          const zone = this.slashZones[zoneIndex];
          const zoneRect = zone.getBoundingClientRect();
          const gameAreaRect = this.gameArea.getBoundingClientRect();

          const target = {
            id: Date.now() + Math.random(),
            zoneIndex: zoneIndex,
            x: zoneRect.left - gameAreaRect.left + 20,
            y: zoneRect.top - gameAreaRect.top + 20,
            type: this.getTargetType(),
            element: null,
            spawnTime: Date.now(),
          };

          this.createTargetElement(target);
          this.targets.push(target);
          this.totalTargets++;

          const config = this.difficulties[this.difficulty];
          setTimeout(() => {
            this.removeTarget(target);
            if (this.gameActive) {
              this.missTarget();
            }
          }, config.targetSpeed);
        }

        getTargetType() {
          const rand = Math.random();
          if (rand < 0.1) return "perfect";
          if (rand < 0.2) return "combo";
          return "normal";
        }

        createTargetElement(target) {
          const element = document.createElement("div");
          element.className = `beat-target ${target.type}`;
          element.style.left = target.x + "px";
          element.style.top = target.y + "px";
          element.dataset.id = target.id;
          element.dataset.zoneIndex = target.zoneIndex;

          switch (target.type) {
            case "normal":
              element.textContent = "â—";
              break;
            case "perfect":
              element.textContent = "â˜…";
              break;
            case "combo":
              element.textContent = "âš¡";
              break;
          }

          const config = this.difficulties[this.difficulty];
          element.style.animationDuration = config.targetSpeed + "ms";

          element.addEventListener("click", () => this.slashTarget(target));
          target.element = element;
          this.gameArea.appendChild(element);
        }

        handleKeyPress(e) {
          if (!this.gameActive || this.isPaused) return;

          let zoneIndex = -1;
          switch (e.code) {
            case "KeyQ":
            case "Digit1":
              zoneIndex = 0;
              break;
            case "KeyW":
            case "Digit2":
              zoneIndex = 1;
              break;
            case "KeyA":
            case "Digit3":
              zoneIndex = 2;
              break;
            case "KeyS":
            case "Digit4":
              zoneIndex = 3;
              break;
            case "Space":
              // å…¨å€åŸŸæ–¬æ“Š
              this.handleSlash(-1);
              return;
          }

          if (zoneIndex !== -1) {
            this.handleSlash(zoneIndex);
          }
        }

        handleSlash(zoneIndex) {
          if (zoneIndex === -1) {
            // å…¨å€åŸŸæ–¬æ“Š
            this.targets.forEach((target) => {
              this.slashTarget(target);
            });
            return;
          }

          const zone = this.slashZones[zoneIndex];
          zone.classList.add("active");
          setTimeout(() => zone.classList.remove("active"), 500);

          // å‰µå»ºæ–¬æ“Šè»Œè·¡
          this.createSlashTrail(zone);

          // å°‹æ‰¾è©²å€åŸŸçš„ç›®æ¨™
          const targetsInZone = this.targets.filter(
            (target) => target.zoneIndex === zoneIndex
          );

          if (targetsInZone.length > 0) {
            const closestTarget = this.findClosestTarget(targetsInZone, zone);
            if (closestTarget) {
              this.slashTarget(closestTarget);
            }
          }
        }

        findClosestTarget(targets, zone) {
          const zoneRect = zone.getBoundingClientRect();
          const zoneCenterX = zoneRect.left + zoneRect.width / 2;
          const zoneCenterY = zoneRect.top + zoneRect.height / 2;

          let closest = null;
          let minDistance = Infinity;

          targets.forEach((target) => {
            const targetRect = target.element.getBoundingClientRect();
            const targetCenterX = targetRect.left + targetRect.width / 2;
            const targetCenterY = targetRect.top + targetRect.height / 2;

            const distance = Math.sqrt(
              Math.pow(targetCenterX - zoneCenterX, 2) +
                Math.pow(targetCenterY - zoneCenterY, 2)
            );

            if (distance < minDistance) {
              minDistance = distance;
              closest = target;
            }
          });

          return closest;
        }

        createSlashTrail(zone) {
          const trail = document.createElement("div");
          trail.className = "slash-trail";

          const zoneRect = zone.getBoundingClientRect();
          const gameAreaRect = this.gameArea.getBoundingClientRect();

          trail.style.left = zoneRect.left - gameAreaRect.left + 60 + "px";
          trail.style.top = zoneRect.top - gameAreaRect.top + "px";
          trail.style.transform =
            "rotate(" + (Math.random() * 90 - 45) + "deg)";

          this.gameArea.appendChild(trail);
          setTimeout(() => {
            if (trail.parentNode) {
              trail.parentNode.removeChild(trail);
            }
          }, 300);
        }

        slashTarget(target) {
          const now = Date.now();
          const timingAccuracy = this.calculateTimingAccuracy(target, now);

          let baseScore = 50;
          let feedback = "HIT!";

          // æ ¹æ“šç›®æ¨™é¡å‹èª¿æ•´åˆ†æ•¸
          switch (target.type) {
            case "perfect":
              baseScore = 150;
              feedback = "PERFECT!";
              break;
            case "combo":
              baseScore = 100;
              feedback = "COMBO!";
              break;
          }

          // æ™‚æ©Ÿæº–ç¢ºåº¦åŠ æˆ
          if (timingAccuracy > 0.8) {
            baseScore *= 2;
            feedback = "PERFECT TIMING!";
          } else if (timingAccuracy > 0.6) {
            baseScore *= 1.5;
            feedback = "GREAT!";
          }

          // é€£æ“ŠåŠ æˆ
          this.combo++;
          this.maxCombo = Math.max(this.maxCombo, this.combo);
          const comboBonus = Math.floor(this.combo / 5) * 25;
          const totalScore = baseScore + comboBonus;

          this.score += totalScore;
          this.hitTargets++;

          // è¦–è¦ºåé¥‹
          target.element.classList.add("slashed");
          this.showBeatFeedback(target.x, target.y, feedback, totalScore);
          this.updateComboIndicator();

          setTimeout(() => this.removeTarget(target), 500);
          this.updateDisplay();
        }

        calculateTimingAccuracy(target, hitTime) {
          const targetLifeTime = hitTime - target.spawnTime;
          const config = this.difficulties[this.difficulty];
          const perfectTiming = config.targetSpeed * 0.8; // 80%çš„æ™‚é–“é»ç‚ºå®Œç¾æ™‚æ©Ÿ

          const timingDiff = Math.abs(targetLifeTime - perfectTiming);
          const accuracy = Math.max(0, 1 - timingDiff / config.perfectWindow);

          return accuracy;
        }

        missTarget() {
          this.combo = 0;
          this.updateComboIndicator();
          this.updateDisplay();
        }

        showBeatFeedback(x, y, text, score) {
          const feedback = document.createElement("div");
          feedback.className = "beat-feedback";
          feedback.textContent = text;
          feedback.style.left = x + "px";
          feedback.style.top = y + "px";

          if (score > 100) {
            feedback.style.color = "#2ecc71";
          } else if (score > 50) {
            feedback.style.color = "#f39c12";
          } else {
            feedback.style.color = "#e74c3c";
          }

          this.gameArea.appendChild(feedback);
          setTimeout(() => {
            if (feedback.parentNode) {
              feedback.parentNode.removeChild(feedback);
            }
          }, 1000);
        }

        updateComboIndicator() {
          this.comboIndicator.textContent = this.combo;

          if (this.combo > 0 && this.combo % 10 === 0) {
            this.comboIndicator.classList.add("highlight");
            setTimeout(() => {
              this.comboIndicator.classList.remove("highlight");
            }, 500);
          }
        }

        removeTarget(target) {
          const index = this.targets.findIndex((t) => t.id === target.id);
          if (index !== -1) {
            if (target.element && target.element.parentNode) {
              target.element.parentNode.removeChild(target.element);
            }
            this.targets.splice(index, 1);
          }
        }

        clearTargets() {
          this.targets.forEach((target) => {
            if (target.element && target.element.parentNode) {
              target.element.parentNode.removeChild(target.element);
            }
          });
          this.targets = [];
        }

        levelUp() {
          this.level++;
          const config = this.difficulties[this.difficulty];

          // æå‡é›£åº¦
          clearInterval(this.spawnInterval);
          this.spawnInterval = setInterval(() => {
            if (!this.isPaused && this.gameActive) {
              this.spawnTarget();
            }
          }, Math.max(config.spawnRate - this.level * 50, 600));

          this.status.textContent = `ç­‰ç´šæå‡åˆ° ${this.level}ï¼ç¯€æ‹åŠ å¿«ï¼`;
          setTimeout(() => {
            this.status.textContent = "è·Ÿéš¨ç¯€æ‹æ–¬æ“Šç›®æ¨™ï¼";
          }, 2000);
        }

        updateDisplay() {
          this.scoreEl.textContent = this.score;
          this.comboEl.textContent = this.combo;
          this.levelEl.textContent = this.level;
          this.timerEl.textContent = this.timeLeft;

          // è¨ˆç®—ç²¾æº–åº¦
          this.precision =
            this.totalTargets > 0
              ? Math.round((this.hitTargets / this.totalTargets) * 100)
              : 100;
          this.precisionEl.textContent = this.precision + "%";
          this.precisionFill.style.width = this.precision + "%";

          // æ ¹æ“šç²¾æº–åº¦èª¿æ•´é¡è‰²
          if (this.precision > 80) {
            this.precisionFill.style.background =
              "linear-gradient(90deg, #2ecc71, #27ae60)";
          } else if (this.precision > 60) {
            this.precisionFill.style.background =
              "linear-gradient(90deg, #f39c12, #e67e22)";
          } else {
            this.precisionFill.style.background =
              "linear-gradient(90deg, #e74c3c, #c0392b)";
          }
        }

        pauseGame() {
          if (this.gameActive) {
            this.isPaused = !this.isPaused;
            this.pauseBtn.textContent = this.isPaused ? "ç¹¼çºŒ" : "æš«åœ";
            this.status.textContent = this.isPaused ? "éŠæˆ²å·²æš«åœ" : "éŠæˆ²ç¹¼çºŒ";
          }
        }

        endGame() {
          this.gameActive = false;
          clearInterval(this.spawnInterval);
          clearInterval(this.timerInterval);
          clearInterval(this.beatInterval);

          this.clearTargets();
          this.status.textContent = `ğŸ‰ éŠæˆ²çµæŸï¼æœ€çµ‚åˆ†æ•¸: ${this.score} | æœ€é«˜é€£æ“Š: ${this.maxCombo}`;
          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
        }

        resetGame() {
          this.gameActive = false;
          this.isPaused = false;
          clearInterval(this.spawnInterval);
          clearInterval(this.timerInterval);
          clearInterval(this.beatInterval);

          this.score = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.level = 1;
          this.timeLeft = 90;
          this.precision = 100;
          this.totalTargets = 0;
          this.hitTargets = 0;
          this.currentBeat = 0;

          this.clearTargets();
          this.updateDisplay();
          this.comboIndicator.textContent = "0";

          this.status.textContent = "æº–å‚™æˆç‚ºç¯€æ‹æ­¦å£«ï¼åœ¨æ­£ç¢ºçš„æ™‚æ©Ÿæ–¬æ“Šç›®æ¨™ï¼";
          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
        }
      }

      // åˆå§‹åŒ–éŠæˆ²
      window.addEventListener("load", () => {
        new BeatSamurai();
      });
    </script>
  </body>
</html>
