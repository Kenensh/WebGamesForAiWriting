<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤šé‡ä»»å‹™æŒ‘æˆ°</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Arial", sans-serif;
        overflow: hidden;
        color: white;
      }

      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: grid;
        grid-template-areas:
          "header header header"
          "task1 task2 task3"
          "footer footer footer";
        grid-template-rows: 80px 1fr 100px;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        padding: 10px;
        box-sizing: border-box;
      }

      .header {
        grid-area: header;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(10px);
      }

      .score-panel {
        display: flex;
        gap: 20px;
        font-size: 1.2em;
        font-weight: bold;
      }

      .controls {
        display: flex;
        gap: 10px;
      }

      .control-button {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .control-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .task-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      .task-header {
        text-align: center;
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #ffd700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .task-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* ä»»å‹™1: é»æ“Šåœ“é» */
      .click-area {
        width: 100%;
        height: 100%;
        position: relative;
        cursor: pointer;
      }

      .click-dot {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: radial-gradient(circle, #ff6b6b, #ee5a52);
        border: 3px solid white;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      .click-dot:hover {
        transform: scale(1.1);
      }

      /* ä»»å‹™2: æ•¸å­¸è¨ˆç®— */
      .math-problem {
        text-align: center;
        font-size: 2em;
        margin: 20px 0;
        font-weight: bold;
      }

      .math-input {
        font-size: 1.5em;
        padding: 10px;
        border: 2px solid #4ecdc4;
        border-radius: 10px;
        text-align: center;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        width: 100px;
      }

      .math-input:focus {
        outline: none;
        border-color: #ffd700;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      }

      /* ä»»å‹™3: è¨˜æ†¶åºåˆ— */
      .memory-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        width: 180px;
        height: 180px;
      }

      .memory-button {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        font-weight: bold;
      }

      .memory-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .memory-button.active {
        background: #4ecdc4;
        transform: scale(1.1);
      }

      .memory-button.correct {
        background: #2ecc71;
      }

      .memory-button.wrong {
        background: #e74c3c;
      }

      /* ä»»å‹™é€²åº¦ */
      .task-progress {
        margin-top: 10px;
        font-size: 1em;
        text-align: center;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4ecdc4, #ffd700);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .footer {
        grid-area: footer;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 20px;
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .time-display {
        font-size: 2em;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .task-alert {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff6b6b;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: bold;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        color: white;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(5px);
      }

      .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        z-index: 200;
      }

      .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      @media (max-width: 900px) {
        .game-container {
          grid-template-areas:
            "header"
            "task1"
            "task2"
            "task3"
            "footer";
          grid-template-rows: 80px 1fr 1fr 1fr 80px;
          grid-template-columns: 1fr;
        }

        .score-panel {
          font-size: 1em;
          gap: 10px;
        }

        .task-header {
          font-size: 1.1em;
        }
      }
    </style>
  </head>
  <body>
    <button class="back-button" onclick="window.location.href='index.html'">
      â† è¿”å›
    </button>

    <div class="game-container">
      <div class="header">
        <div class="score-panel">
          <div>ç¸½åˆ†: <span id="totalScore">0</span></div>
          <div>å®Œæˆä»»å‹™: <span id="completedTasks">0</span></div>
          <div>å°ˆæ³¨åº¦: <span id="focusLevel">100%</span></div>
        </div>

        <div class="controls">
          <button class="control-button" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
          <button class="control-button" onclick="pauseGame()">æš«åœ</button>
          <button class="control-button" onclick="showHelp()">èªªæ˜</button>
        </div>
      </div>

      <!-- ä»»å‹™1: é»æ“Šåœ“é» -->
      <div class="task-panel" id="task1">
        <div class="task-header">ğŸ¯ å¿«é€Ÿé»æ“Š</div>
        <div class="task-content">
          <div class="click-area" id="clickArea"></div>
        </div>
        <div class="task-progress">
          é»æ“Šæ•¸: <span id="clickCount">0</span>/20
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="clickProgress"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- ä»»å‹™2: æ•¸å­¸è¨ˆç®— -->
      <div class="task-panel" id="task2">
        <div class="task-header">ğŸ§® å¿ƒç®—æŒ‘æˆ°</div>
        <div class="task-content">
          <div class="math-problem" id="mathProblem">æº–å‚™é–‹å§‹...</div>
          <input
            type="number"
            class="math-input"
            id="mathInput"
            placeholder="?"
            disabled
          />
        </div>
        <div class="task-progress">
          è¨ˆç®—é¡Œ: <span id="mathCount">0</span>/15
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="mathProgress"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- ä»»å‹™3: è¨˜æ†¶åºåˆ— -->
      <div class="task-panel" id="task3">
        <div class="task-header">ğŸ§  è¨˜æ†¶æŒ‘æˆ°</div>
        <div class="task-content">
          <div class="memory-grid" id="memoryGrid">
            <button class="memory-button" data-index="0">1</button>
            <button class="memory-button" data-index="1">2</button>
            <button class="memory-button" data-index="2">3</button>
            <button class="memory-button" data-index="3">4</button>
            <button class="memory-button" data-index="4">5</button>
            <button class="memory-button" data-index="5">6</button>
            <button class="memory-button" data-index="6">7</button>
            <button class="memory-button" data-index="7">8</button>
            <button class="memory-button" data-index="8">9</button>
          </div>
        </div>
        <div class="task-progress">
          åºåˆ—é•·åº¦: <span id="sequenceLength">3</span>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="memoryProgress"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="time-display">
          å‰©é¤˜æ™‚é–“: <span id="timeDisplay">120</span>ç§’
        </div>
      </div>
    </div>

    <!-- éŠæˆ²çµæŸæ¨¡æ…‹æ¡† -->
    <div class="modal" id="gameOverModal">
      <div class="modal-content">
        <h2>ğŸ® å¤šé‡ä»»å‹™æŒ‘æˆ°å®Œæˆï¼</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div>ç¸½åˆ†</div>
            <div style="font-size: 1.5em; color: #ffd700" id="finalTotalScore">
              0
            </div>
          </div>
          <div class="stat-item">
            <div>å®Œæˆä»»å‹™</div>
            <div
              style="font-size: 1.5em; color: #4ecdc4"
              id="finalCompletedTasks"
            >
              0
            </div>
          </div>
          <div class="stat-item">
            <div>å¹³å‡å°ˆæ³¨åº¦</div>
            <div style="font-size: 1.5em; color: #ff6b6b" id="avgFocus">
              100%
            </div>
          </div>
          <div class="stat-item">
            <div>é»æ“Šä»»å‹™</div>
            <div style="font-size: 1.5em; color: #9b59b6" id="clickTaskScore">
              0
            </div>
          </div>
          <div class="stat-item">
            <div>æ•¸å­¸ä»»å‹™</div>
            <div style="font-size: 1.5em; color: #e67e22" id="mathTaskScore">
              0
            </div>
          </div>
          <div class="stat-item">
            <div>è¨˜æ†¶ä»»å‹™</div>
            <div style="font-size: 1.5em; color: #2ecc71" id="memoryTaskScore">
              0
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="control-button" onclick="restartGame()">
            å†ç©ä¸€æ¬¡
          </button>
          <button class="control-button" onclick="closeModal()">
            è¿”å›é¸å–®
          </button>
        </div>
      </div>
    </div>

    <!-- èªªæ˜æ¨¡æ…‹æ¡† -->
    <div class="modal" id="helpModal">
      <div class="modal-content">
        <h2>ğŸ® éŠæˆ²èªªæ˜</h2>
        <div style="text-align: left; max-height: 60vh; overflow-y: auto">
          <h3>ğŸ“‹ éŠæˆ²ç›®æ¨™</h3>
          <p>åœ¨120ç§’å…§åŒæ™‚é€²è¡Œä¸‰å€‹ä¸åŒçš„ä»»å‹™ï¼Œæ¸¬è©¦ä½ çš„å¤šé‡ä»»å‹™è™•ç†èƒ½åŠ›ï¼</p>

          <h3>ğŸ¯ ä»»å‹™èªªæ˜</h3>
          <div style="margin: 15px 0">
            <h4>ä»»å‹™1: å¿«é€Ÿé»æ“Š ğŸ¯</h4>
            <ul>
              <li>é»æ“Šå‡ºç¾çš„ç´…è‰²åœ“é»</li>
              <li>åœ“é»æœƒåœ¨éš¨æ©Ÿä½ç½®å‡ºç¾</li>
              <li>éœ€è¦å®Œæˆ20æ¬¡é»æ“Š</li>
              <li>æ¯æ¬¡é»æ“Šå¾—10åˆ†</li>
            </ul>
          </div>

          <div style="margin: 15px 0">
            <h4>ä»»å‹™2: å¿ƒç®—æŒ‘æˆ° ğŸ§®</h4>
            <ul>
              <li>è§£ç­”å‡ºç¾çš„æ•¸å­¸è¨ˆç®—é¡Œ</li>
              <li>åœ¨è¼¸å…¥æ¡†ä¸­è¼¸å…¥ç­”æ¡ˆ</li>
              <li>æŒ‰Enterç¢ºèªç­”æ¡ˆ</li>
              <li>éœ€è¦å®Œæˆ15é“é¡Œç›®</li>
              <li>æ­£ç¢ºç­”æ¡ˆå¾—20åˆ†</li>
            </ul>
          </div>

          <div style="margin: 15px 0">
            <h4>ä»»å‹™3: è¨˜æ†¶æŒ‘æˆ° ğŸ§ </h4>
            <ul>
              <li>è¨˜ä½æŒ‰éˆ•é–ƒå…‰çš„é †åº</li>
              <li>æŒ‰ç›¸åŒé †åºé»æ“ŠæŒ‰éˆ•</li>
              <li>åºåˆ—é•·åº¦æœƒé€æ¼¸å¢åŠ </li>
              <li>æ­£ç¢ºå®Œæˆå¾—30åˆ†</li>
            </ul>
          </div>

          <h3>ğŸ“Š è¨ˆåˆ†ç³»çµ±</h3>
          <ul>
            <li>æ¯å€‹ä»»å‹™éƒ½æœ‰ç¨ç«‹çš„åˆ†æ•¸</li>
            <li>ç¸½åˆ†ç”±ä¸‰å€‹ä»»å‹™åˆ†æ•¸ç›¸åŠ </li>
            <li>å°ˆæ³¨åº¦å½±éŸ¿æœ€çµ‚å¾—åˆ†</li>
            <li>åŒæ™‚é€²è¡Œä»»å‹™å¯ç²å¾—åŠ æˆ</li>
          </ul>

          <h3>ğŸ¯ å°æŠ€å·§</h3>
          <ul>
            <li>åˆç†åˆ†é…æ³¨æ„åŠ›åˆ°ä¸‰å€‹ä»»å‹™</li>
            <li>å…ˆå®Œæˆç°¡å–®çš„ä»»å‹™</li>
            <li>ä¿æŒå†·éœï¼Œé¿å…æ…Œå¼µ</li>
            <li>å®šæœŸåˆ‡æ›ä»»å‹™ä¿æŒå°ˆæ³¨</li>
          </ul>
        </div>

        <div class="controls" style="margin-top: 20px">
          <button class="control-button" onclick="closeHelp()">ç¢ºå®š</button>
        </div>
      </div>
    </div>

    <script src="gameUtils.js"></script>
    <script>
      let gameState = "waiting"; // waiting, playing, paused, finished
      let gameTime = 120;
      let timeLeft = gameTime;
      let gameTimer = null;

      // ç¸½åˆ†å’Œçµ±è¨ˆ
      let totalScore = 0;
      let completedTasks = 0;
      let focusLevels = [];

      // ä»»å‹™1: é»æ“Šä»»å‹™
      let clickTask = {
        score: 0,
        count: 0,
        target: 20,
        currentDot: null,
        timer: null,
      };

      // ä»»å‹™2: æ•¸å­¸ä»»å‹™
      let mathTask = {
        score: 0,
        count: 0,
        target: 15,
        currentProblem: null,
        answer: 0,
      };

      // ä»»å‹™3: è¨˜æ†¶ä»»å‹™
      let memoryTask = {
        score: 0,
        count: 0,
        sequence: [],
        playerSequence: [],
        sequenceLength: 3,
        showingSequence: false,
        timer: null,
      };

      // é–‹å§‹éŠæˆ²
      function startGame() {
        if (gameState === "playing") return;

        gameState = "playing";
        timeLeft = gameTime;
        totalScore = 0;
        completedTasks = 0;
        focusLevels = [];

        // é‡ç½®æ‰€æœ‰ä»»å‹™
        resetTasks();
        updateUI();

        // é–‹å§‹æ‰€æœ‰ä»»å‹™
        startClickTask();
        startMathTask();
        startMemoryTask();

        // é–‹å§‹è¨ˆæ™‚
        gameTimer = setInterval(() => {
          timeLeft--;
          updateUI();

          // è¨ˆç®—å°ˆæ³¨åº¦ï¼ˆåŸºæ–¼ä»»å‹™åˆ‡æ›é »ç‡ï¼‰
          calculateFocus();

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }

      // æš«åœéŠæˆ²
      function pauseGame() {
        if (gameState === "playing") {
          gameState = "paused";
          clearInterval(gameTimer);
          clearTimeout(clickTask.timer);
          clearTimeout(memoryTask.timer);

          // ç¦ç”¨è¼¸å…¥
          document.getElementById("mathInput").disabled = true;
        } else if (gameState === "paused") {
          gameState = "playing";

          // ç¹¼çºŒè¨ˆæ™‚
          gameTimer = setInterval(() => {
            timeLeft--;
            updateUI();
            calculateFocus();

            if (timeLeft <= 0) {
              endGame();
            }
          }, 1000);

          // é‡æ–°å•Ÿå‹•ä»»å‹™
          if (clickTask.count < clickTask.target) {
            continueClickTask();
          }
          if (mathTask.count < mathTask.target) {
            document.getElementById("mathInput").disabled = false;
          }
          if (memoryTask.count < 10) {
            continueMemoryTask();
          }
        }
      }

      // é‡ç½®æ‰€æœ‰ä»»å‹™
      function resetTasks() {
        // é‡ç½®é»æ“Šä»»å‹™
        clickTask = {
          score: 0,
          count: 0,
          target: 20,
          currentDot: null,
          timer: null,
        };

        // é‡ç½®æ•¸å­¸ä»»å‹™
        mathTask = {
          score: 0,
          count: 0,
          target: 15,
          currentProblem: null,
          answer: 0,
        };

        // é‡ç½®è¨˜æ†¶ä»»å‹™
        memoryTask = {
          score: 0,
          count: 0,
          sequence: [],
          playerSequence: [],
          sequenceLength: 3,
          showingSequence: false,
          timer: null,
        };

        // æ¸…ç†UI
        document.getElementById("clickArea").innerHTML = "";
        document.getElementById("mathInput").value = "";
        document.getElementById("mathInput").disabled = true;

        document.querySelectorAll(".memory-button").forEach((btn) => {
          btn.classList.remove("active", "correct", "wrong");
        });
      }

      // ä»»å‹™1: é»æ“Šä»»å‹™
      function startClickTask() {
        if (gameState !== "playing" || clickTask.count >= clickTask.target)
          return;

        spawnClickDot();
      }

      function spawnClickDot() {
        if (gameState !== "playing" || clickTask.count >= clickTask.target)
          return;

        // ç§»é™¤èˆŠåœ“é»
        if (clickTask.currentDot) {
          clickTask.currentDot.remove();
        }

        const clickArea = document.getElementById("clickArea");
        const areaRect = clickArea.getBoundingClientRect();

        // å‰µå»ºæ–°åœ“é»
        const dot = document.createElement("div");
        dot.className = "click-dot";
        dot.textContent = "+10";

        // éš¨æ©Ÿä½ç½®
        const x = Math.random() * (areaRect.width - 50);
        const y = Math.random() * (areaRect.height - 50);
        dot.style.left = x + "px";
        dot.style.top = y + "px";

        // é»æ“Šäº‹ä»¶
        dot.addEventListener("click", () => {
          clickTask.score += 10;
          clickTask.count++;
          totalScore += 10;

          dot.remove();
          clickTask.currentDot = null;

          updateUI();

          if (clickTask.count < clickTask.target) {
            clickTask.timer = setTimeout(
              spawnClickDot,
              1000 + Math.random() * 2000
            );
          } else {
            completedTasks++;
            showTaskAlert("task1", "é»æ“Šä»»å‹™å®Œæˆï¼");
          }
        });

        clickArea.appendChild(dot);
        clickTask.currentDot = dot;

        // è‡ªå‹•æ¶ˆå¤±
        setTimeout(() => {
          if (dot.parentNode) {
            dot.remove();
            clickTask.currentDot = null;
            if (clickTask.count < clickTask.target) {
              clickTask.timer = setTimeout(
                spawnClickDot,
                500 + Math.random() * 1000
              );
            }
          }
        }, 3000);
      }

      function continueClickTask() {
        if (clickTask.count < clickTask.target) {
          clickTask.timer = setTimeout(spawnClickDot, 1000);
        }
      }

      // ä»»å‹™2: æ•¸å­¸ä»»å‹™
      function startMathTask() {
        if (gameState !== "playing" || mathTask.count >= mathTask.target)
          return;

        generateMathProblem();
        document.getElementById("mathInput").disabled = false;
      }

      function generateMathProblem() {
        if (mathTask.count >= mathTask.target) return;

        const operations = ["+", "-", "*"];
        const operation =
          operations[Math.floor(Math.random() * operations.length)];

        let a, b, answer;

        switch (operation) {
          case "+":
            a = Math.floor(Math.random() * 50) + 10;
            b = Math.floor(Math.random() * 50) + 10;
            answer = a + b;
            break;
          case "-":
            a = Math.floor(Math.random() * 50) + 30;
            b = Math.floor(Math.random() * 20) + 5;
            answer = a - b;
            break;
          case "*":
            a = Math.floor(Math.random() * 12) + 3;
            b = Math.floor(Math.random() * 12) + 3;
            answer = a * b;
            break;
        }

        mathTask.currentProblem = `${a} ${operation} ${b} = ?`;
        mathTask.answer = answer;

        document.getElementById("mathProblem").textContent =
          mathTask.currentProblem;
        document.getElementById("mathInput").value = "";
        document.getElementById("mathInput").focus();
      }

      // æ•¸å­¸è¼¸å…¥è™•ç†
      document
        .getElementById("mathInput")
        .addEventListener("keypress", (event) => {
          if (event.key === "Enter" && gameState === "playing") {
            const userAnswer = parseInt(
              document.getElementById("mathInput").value
            );

            if (userAnswer === mathTask.answer) {
              mathTask.score += 20;
              mathTask.count++;
              totalScore += 20;

              updateUI();

              if (mathTask.count < mathTask.target) {
                setTimeout(generateMathProblem, 500);
              } else {
                completedTasks++;
                showTaskAlert("task2", "æ•¸å­¸ä»»å‹™å®Œæˆï¼");
                document.getElementById("mathProblem").textContent =
                  "å…¨éƒ¨å®Œæˆï¼";
                document.getElementById("mathInput").disabled = true;
              }
            } else {
              // ç­”éŒ¯äº†ï¼Œé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
              document.getElementById("mathProblem").style.color = "#ff6b6b";
              setTimeout(() => {
                document.getElementById("mathProblem").style.color = "#fff";
                generateMathProblem();
              }, 1000);
            }
          }
        });

      // ä»»å‹™3: è¨˜æ†¶ä»»å‹™
      function startMemoryTask() {
        if (gameState !== "playing" || memoryTask.count >= 10) return;

        generateMemorySequence();
      }

      function generateMemorySequence() {
        if (memoryTask.count >= 10) return;

        memoryTask.sequence = [];
        memoryTask.playerSequence = [];

        // ç”Ÿæˆéš¨æ©Ÿåºåˆ—
        for (let i = 0; i < memoryTask.sequenceLength; i++) {
          memoryTask.sequence.push(Math.floor(Math.random() * 9));
        }

        showMemorySequence();
      }

      function showMemorySequence() {
        memoryTask.showingSequence = true;
        let index = 0;

        const showNext = () => {
          if (index < memoryTask.sequence.length) {
            const buttonIndex = memoryTask.sequence[index];
            const button = document.querySelector(
              `[data-index="${buttonIndex}"]`
            );

            button.classList.add("active");
            setTimeout(() => {
              button.classList.remove("active");
              index++;
              setTimeout(showNext, 200);
            }, 500);
          } else {
            memoryTask.showingSequence = false;
            enableMemoryInput();
          }
        };

        setTimeout(showNext, 1000);
      }

      function enableMemoryInput() {
        document.querySelectorAll(".memory-button").forEach((button) => {
          button.addEventListener("click", handleMemoryClick);
        });
      }

      function handleMemoryClick(event) {
        if (memoryTask.showingSequence || gameState !== "playing") return;

        const buttonIndex = parseInt(event.target.dataset.index);
        memoryTask.playerSequence.push(buttonIndex);

        const expectedIndex =
          memoryTask.sequence[memoryTask.playerSequence.length - 1];

        if (buttonIndex === expectedIndex) {
          event.target.classList.add("correct");
          setTimeout(() => event.target.classList.remove("correct"), 300);

          if (memoryTask.playerSequence.length === memoryTask.sequence.length) {
            // åºåˆ—å®Œæˆ
            memoryTask.score += 30;
            memoryTask.count++;
            totalScore += 30;

            updateUI();

            // å¢åŠ é›£åº¦
            if (memoryTask.count % 2 === 0 && memoryTask.sequenceLength < 6) {
              memoryTask.sequenceLength++;
            }

            if (memoryTask.count < 10) {
              setTimeout(() => {
                disableMemoryInput();
                generateMemorySequence();
              }, 1000);
            } else {
              completedTasks++;
              showTaskAlert("task3", "è¨˜æ†¶ä»»å‹™å®Œæˆï¼");
              disableMemoryInput();
            }
          }
        } else {
          // éŒ¯èª¤
          event.target.classList.add("wrong");
          setTimeout(() => event.target.classList.remove("wrong"), 300);

          // é‡æ–°é–‹å§‹é€™å€‹åºåˆ—
          setTimeout(() => {
            disableMemoryInput();
            generateMemorySequence();
          }, 1000);
        }
      }

      function disableMemoryInput() {
        document.querySelectorAll(".memory-button").forEach((button) => {
          button.removeEventListener("click", handleMemoryClick);
        });
      }

      function continueMemoryTask() {
        if (memoryTask.count < 10) {
          setTimeout(generateMemorySequence, 1000);
        }
      }

      // é¡¯ç¤ºä»»å‹™å®Œæˆè­¦å‘Š
      function showTaskAlert(taskId, message) {
        const task = document.getElementById(taskId);
        const alert = document.createElement("div");
        alert.className = "task-alert";
        alert.textContent = message;

        task.appendChild(alert);

        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 3000);
      }

      // è¨ˆç®—å°ˆæ³¨åº¦
      function calculateFocus() {
        // åŸºæ–¼ä»»å‹™å®Œæˆæ•ˆç‡è¨ˆç®—å°ˆæ³¨åº¦
        const timeElapsed = gameTime - timeLeft;
        if (timeElapsed === 0) return;

        const expectedProgress = timeElapsed / gameTime;
        const actualProgress =
          (clickTask.count / clickTask.target +
            mathTask.count / mathTask.target +
            memoryTask.count / 10) /
          3;

        const focus = Math.min(
          100,
          Math.max(0, (actualProgress / expectedProgress) * 100)
        );
        focusLevels.push(focus);
      }

      // æ›´æ–°UI
      function updateUI() {
        document.getElementById("totalScore").textContent = totalScore;
        document.getElementById("completedTasks").textContent = completedTasks;
        document.getElementById("timeDisplay").textContent = timeLeft;

        // æ›´æ–°å°ˆæ³¨åº¦
        const avgFocus =
          focusLevels.length > 0
            ? Math.round(
                focusLevels.reduce((a, b) => a + b, 0) / focusLevels.length
              )
            : 100;
        document.getElementById("focusLevel").textContent = avgFocus + "%";

        // æ›´æ–°ä»»å‹™é€²åº¦
        document.getElementById("clickCount").textContent = clickTask.count;
        document.getElementById("clickProgress").style.width =
          (clickTask.count / clickTask.target) * 100 + "%";

        document.getElementById("mathCount").textContent = mathTask.count;
        document.getElementById("mathProgress").style.width =
          (mathTask.count / mathTask.target) * 100 + "%";

        document.getElementById("sequenceLength").textContent =
          memoryTask.sequenceLength;
        document.getElementById("memoryProgress").style.width =
          (memoryTask.count / 10) * 100 + "%";
      }

      // çµæŸéŠæˆ²
      function endGame() {
        gameState = "finished";
        clearInterval(gameTimer);
        clearTimeout(clickTask.timer);
        clearTimeout(memoryTask.timer);

        // ç¦ç”¨æ‰€æœ‰è¼¸å…¥
        document.getElementById("mathInput").disabled = true;
        disableMemoryInput();

        // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
        const avgFocus =
          focusLevels.length > 0
            ? Math.round(
                focusLevels.reduce((a, b) => a + b, 0) / focusLevels.length
              )
            : 100;

        // é¡¯ç¤ºçµæœ
        document.getElementById("finalTotalScore").textContent = totalScore;
        document.getElementById("finalCompletedTasks").textContent =
          completedTasks;
        document.getElementById("avgFocus").textContent = avgFocus + "%";
        document.getElementById("clickTaskScore").textContent = clickTask.score;
        document.getElementById("mathTaskScore").textContent = mathTask.score;
        document.getElementById("memoryTaskScore").textContent =
          memoryTask.score;

        document.getElementById("gameOverModal").style.display = "flex";

        // æ›´æ–°éŠæˆ²çµ±è¨ˆ
        GameUtils.updateGameStats("multitask-challenge", {
          gamesPlayed: 1,
          totalScore: totalScore,
          bestScore: totalScore,
        });
      }

      // é‡æ–°é–‹å§‹éŠæˆ²
      function restartGame() {
        closeModal();
        startGame();
      }

      // é—œé–‰æ¨¡æ…‹æ¡†
      function closeModal() {
        document.getElementById("gameOverModal").style.display = "none";
        gameState = "waiting";
      }

      // é¡¯ç¤ºèªªæ˜
      function showHelp() {
        document.getElementById("helpModal").style.display = "flex";
      }

      // é—œé–‰èªªæ˜
      function closeHelp() {
        document.getElementById("helpModal").style.display = "none";
      }

      // éµç›¤äº‹ä»¶
      document.addEventListener("keydown", (event) => {
        switch (event.key) {
          case " ":
            if (event.target !== document.getElementById("mathInput")) {
              event.preventDefault();
              if (gameState === "waiting") {
                startGame();
              } else if (gameState === "playing" || gameState === "paused") {
                pauseGame();
              }
            }
            break;
          case "Escape":
            closeModal();
            closeHelp();
            break;
          case "r":
          case "R":
            if (gameState === "finished") {
              restartGame();
            }
            break;
        }
      });

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", (event) => {
          if (event.target === event.currentTarget) {
            modal.style.display = "none";
          }
        });
      });

      // åˆå§‹åŒ–
      updateUI();
    </script>
  </body>
</html>
