<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¯†å®¤é€ƒè„«</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans TC", sans-serif;
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      .game-container {
        width: 900px;
        height: 600px;
        background: #1a1a1a;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
      }

      .game-header {
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        border-bottom: 2px solid #444;
      }

      .game-info {
        display: flex;
        gap: 20px;
        font-size: 16px;
      }

      .controls {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .game-area {
        height: 540px;
        display: flex;
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      }

      .room-view {
        flex: 3;
        position: relative;
        background: #2c3e50;
        border-right: 2px solid #444;
      }

      .room {
        width: 100%;
        height: 100%;
        position: relative;
        background-size: cover;
        background-position: center;
        cursor: crosshair;
      }

      .room.room-1 {
        background: linear-gradient(
          180deg,
          #34495e 0%,
          #2c3e50 70%,
          #1a252f 100%
        );
      }

      .room.room-2 {
        background: linear-gradient(
          180deg,
          #8e44ad 0%,
          #9b59b6 70%,
          #6a1b99 100%
        );
      }

      .room.room-3 {
        background: linear-gradient(
          180deg,
          #27ae60 0%,
          #2ecc71 70%,
          #1e8449 100%
        );
      }

      .interactive-item {
        position: absolute;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        padding: 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .interactive-item:hover {
        border-color: #3498db;
        background: rgba(52, 152, 219, 0.3);
        transform: scale(1.05);
      }

      .interactive-item.collected {
        opacity: 0.3;
        pointer-events: none;
      }

      .sidebar {
        flex: 1;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        color: white;
        overflow-y: auto;
      }

      .inventory {
        margin-bottom: 30px;
      }

      .inventory h3 {
        margin-bottom: 15px;
        color: #3498db;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .inventory-item {
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #444;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-size: 12px;
      }

      .inventory-item:hover {
        background: rgba(52, 152, 219, 0.3);
        border-color: #3498db;
      }

      .inventory-item.selected {
        background: rgba(52, 152, 219, 0.5);
        border-color: #3498db;
      }

      .room-navigation {
        margin-bottom: 20px;
      }

      .room-nav-btn {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        border: none;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #444;
      }

      .room-nav-btn:hover {
        background: rgba(52, 152, 219, 0.3);
        border-color: #3498db;
      }

      .room-nav-btn.active {
        background: rgba(52, 152, 219, 0.5);
        border-color: #3498db;
      }

      .room-nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .clues {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #444;
        border-radius: 5px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
      }

      .clues h3 {
        margin-bottom: 10px;
        color: #e74c3c;
      }

      .clue {
        margin-bottom: 8px;
        padding: 5px;
        background: rgba(231, 76, 60, 0.1);
        border-left: 3px solid #e74c3c;
        font-size: 12px;
      }

      .puzzle-modal {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #3498db;
        border-radius: 10px;
        padding: 30px;
        color: white;
        z-index: 100;
        min-width: 400px;
        text-align: center;
      }

      .puzzle-input {
        margin: 20px 0;
        padding: 10px;
        font-size: 18px;
        border: 2px solid #3498db;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        text-align: center;
        width: 100%;
      }

      .puzzle-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .code-display {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      .code-digit {
        width: 50px;
        height: 50px;
        border: 2px solid #3498db;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        background: rgba(52, 152, 219, 0.2);
      }

      .start-screen,
      .end-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        z-index: 200;
      }

      .start-screen h2,
      .end-screen h2 {
        font-size: 48px;
        margin-bottom: 20px;
        color: #3498db;
      }

      .scenario-selector {
        margin: 30px 0;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .scenario-btn {
        padding: 15px 25px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        font-weight: bold;
        min-width: 150px;
      }

      .scenario-btn.office {
        background: linear-gradient(45deg, #34495e, #2c3e50);
      }
      .scenario-btn.lab {
        background: linear-gradient(45deg, #8e44ad, #9b59b6);
      }
      .scenario-btn.forest {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
      }

      .scenario-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      }

      .start-btn {
        padding: 15px 40px;
        font-size: 24px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      .timer {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 24px;
        font-weight: bold;
        color: #e74c3c;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 15px;
        border-radius: 5px;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .game-container {
          width: 95vw;
          height: 90vh;
        }

        .game-area {
          flex-direction: column;
        }

        .room-view {
          flex: 2;
        }

        .sidebar {
          flex: 1;
          max-height: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div class="game-header">
        <div class="game-info">
          <div>é—œå¡: <span id="level">1</span></div>
          <div>é“å…·: <span id="items-count">0</span>/5</div>
          <div>æ™‚é–“: <span id="timer">15:00</span></div>
        </div>
        <div class="controls">
          <button class="btn" id="hint-btn">
            <i class="fas fa-lightbulb"></i> æç¤º
          </button>
          <button class="btn" id="help-btn">
            <i class="fas fa-question-circle"></i> èªªæ˜
          </button>
          <button class="btn" id="home-btn">
            <i class="fas fa-home"></i> é¦–é 
          </button>
        </div>
      </div>

      <div class="game-area">
        <div class="room-view">
          <div class="room room-1" id="current-room">
            <!-- æˆ¿é–“å…§çš„äº’å‹•ç‰©å“æœƒå‹•æ…‹ç”Ÿæˆ -->
          </div>
          <div class="timer" id="game-timer">15:00</div>
        </div>

        <div class="sidebar">
          <div class="room-navigation">
            <h3 style="color: #3498db; margin-bottom: 10px">æˆ¿é–“</h3>
            <button class="room-nav-btn active" data-room="1">è¾¦å…¬å®¤</button>
            <button class="room-nav-btn" data-room="2" disabled>å¯¦é©—å®¤</button>
            <button class="room-nav-btn" data-room="3" disabled>å¯†å®¤</button>
          </div>

          <div class="inventory">
            <h3>é“å…·æ¬„</h3>
            <div class="inventory-grid" id="inventory">
              <!-- é“å…·æœƒå‹•æ…‹æ·»åŠ  -->
            </div>
          </div>

          <div class="clues">
            <h3>ç·šç´¢</h3>
            <div id="clues-list">
              <div class="clue">å°‹æ‰¾ç·šç´¢ä¾†è§£é–‹è¬é¡Œ...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="start-screen" id="start-screen">
        <h2>å¯†å®¤é€ƒè„«</h2>
        <p style="margin: 20px 0; font-size: 18px; max-width: 600px">
          æ­¡è¿ä¾†åˆ°å¯†å®¤é€ƒè„«ï¼ä½ è¢«å›°åœ¨ä¸€å€‹ç¥ç§˜çš„å»ºç¯‰ç‰©ä¸­ï¼Œéœ€è¦é€šéè§£è¬ã€æ”¶é›†é“å…·ä¾†é€ƒå‡ºç”Ÿå¤©ã€‚ä»”ç´°è§€å¯Ÿç’°å¢ƒï¼Œå°‹æ‰¾ç·šç´¢ï¼Œé‹ç”¨é‚è¼¯æ€ç¶­è§£é–‹å„ç¨®è¬é¡Œã€‚
        </p>
        <div class="scenario-selector">
          <button class="scenario-btn office" data-scenario="office">
            ç¥ç§˜è¾¦å…¬å®¤
          </button>
          <button class="scenario-btn lab" data-scenario="lab">
            å»¢æ£„å¯¦é©—å®¤
          </button>
          <button class="scenario-btn forest" data-scenario="forest">
            æ£®æ—å°å±‹
          </button>
        </div>
        <button class="start-btn" id="start-game-btn">é–‹å§‹é€ƒè„«</button>
      </div>

      <div class="end-screen hidden" id="end-screen">
        <h2 id="end-title">æ­å–œé€ƒè„«æˆåŠŸï¼</h2>
        <div id="end-stats" style="margin: 20px 0; font-size: 18px"></div>
        <div style="display: flex; gap: 20px; margin-top: 30px">
          <button class="btn" id="restart-btn">å†æ¬¡æŒ‘æˆ°</button>
          <button class="btn" id="menu-btn">è¿”å›é¸å–®</button>
        </div>
      </div>
    </div>

    <script src="gameUtils.js"></script>
    <script>
      class EscapeRoomGame {
        constructor() {
          this.gameController = new GameController("escape-room");
          this.scoreManager = new ScoreManager("escape-room");
          this.modal = new Modal();

          this.initializeElements();
          this.setupEventListeners();
          this.resetGame();
        }

        initializeElements() {
          this.levelElement = document.getElementById("level");
          this.itemsCountElement = document.getElementById("items-count");
          this.timerElement = document.getElementById("timer");
          this.gameTimerElement = document.getElementById("game-timer");
          this.startScreen = document.getElementById("start-screen");
          this.endScreen = document.getElementById("end-screen");
          this.currentRoomElement = document.getElementById("current-room");
          this.inventoryElement = document.getElementById("inventory");
          this.cluesListElement = document.getElementById("clues-list");
          this.roomNavButtons = document.querySelectorAll(".room-nav-btn");
        }

        setupEventListeners() {
          // é–‹å§‹éŠæˆ²
          document
            .getElementById("start-game-btn")
            .addEventListener("click", () => {
              this.startGame();
            });

          // å ´æ™¯é¸æ“‡
          document.querySelectorAll(".scenario-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll(".scenario-btn")
                .forEach((b) => (b.style.opacity = "0.6"));
              e.target.style.opacity = "1";
              this.selectedScenario = e.target.dataset.scenario;
              this.setupScenario();
            });
          });

          // æˆ¿é–“å°èˆª
          this.roomNavButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const roomNumber = parseInt(e.target.dataset.room);
              this.switchRoom(roomNumber);
            });
          });

          // æ§åˆ¶æŒ‰éˆ•
          document.getElementById("hint-btn").addEventListener("click", () => {
            this.showHint();
          });

          document.getElementById("help-btn").addEventListener("click", () => {
            this.showHelp();
          });

          document.getElementById("home-btn").addEventListener("click", () => {
            window.location.href = "index.html";
          });

          document
            .getElementById("restart-btn")
            .addEventListener("click", () => {
              this.resetGame();
              this.startScreen.classList.remove("hidden");
              this.endScreen.classList.add("hidden");
            });

          document.getElementById("menu-btn").addEventListener("click", () => {
            this.resetGame();
            this.startScreen.classList.remove("hidden");
            this.endScreen.classList.add("hidden");
          });
        }

        resetGame() {
          this.currentRoom = 1;
          this.inventory = [];
          this.clues = [];
          this.collectedItems = new Set();
          this.solvedPuzzles = new Set();
          this.timeRemaining = 15 * 60; // 15åˆ†é˜
          this.selectedScenario = "office";
          this.gameStartTime = null;

          this.setupScenario();
          this.updateDisplay();

          // é‡ç½®æˆ¿é–“å°èˆª
          this.roomNavButtons.forEach((btn, index) => {
            btn.disabled = index !== 0;
            btn.classList.toggle("active", index === 0);
          });

          // è¨­ç½®é»˜èªå ´æ™¯
          document.querySelectorAll(".scenario-btn").forEach((btn) => {
            btn.style.opacity = btn.dataset.scenario === "office" ? "1" : "0.6";
          });
        }

        setupScenario() {
          this.scenarios = {
            office: {
              name: "ç¥ç§˜è¾¦å…¬å®¤",
              rooms: [
                {
                  name: "è¾¦å…¬å®¤",
                  items: [
                    {
                      id: "key1",
                      name: "é‘°åŒ™",
                      x: "20%",
                      y: "60%",
                      icon: "ğŸ”‘",
                    },
                    {
                      id: "note1",
                      name: "ä¾¿æ¢ç´™",
                      x: "70%",
                      y: "40%",
                      icon: "ğŸ“",
                    },
                    {
                      id: "usb",
                      name: "USBéš¨èº«ç¢Ÿ",
                      x: "45%",
                      y: "70%",
                      icon: "ğŸ’¾",
                    },
                  ],
                  puzzles: [
                    {
                      id: "safe",
                      name: "ä¿éšªç®±",
                      x: "80%",
                      y: "20%",
                      icon: "ğŸ”’",
                      code: "1234",
                    },
                  ],
                },
                {
                  name: "å¯¦é©—å®¤",
                  items: [
                    {
                      id: "chemical",
                      name: "åŒ–å­¸è©¦åŠ‘",
                      x: "30%",
                      y: "50%",
                      icon: "ğŸ§ª",
                    },
                    {
                      id: "card",
                      name: "èº«ä»½å¡",
                      x: "60%",
                      y: "30%",
                      icon: "ğŸ·ï¸",
                    },
                  ],
                  puzzles: [
                    {
                      id: "computer",
                      name: "é›»è…¦çµ‚ç«¯",
                      x: "50%",
                      y: "60%",
                      icon: "ğŸ’»",
                      code: "5678",
                    },
                  ],
                },
                {
                  name: "å¯†å®¤",
                  items: [
                    {
                      id: "crowbar",
                      name: "æ’¬æ£",
                      x: "25%",
                      y: "75%",
                      icon: "ğŸ”§",
                    },
                  ],
                  puzzles: [
                    {
                      id: "door",
                      name: "å‡ºå£é–€",
                      x: "50%",
                      y: "10%",
                      icon: "ğŸšª",
                      final: true,
                    },
                  ],
                },
              ],
            },
            lab: {
              name: "å»¢æ£„å¯¦é©—å®¤",
              rooms: [
                {
                  name: "æ¥å¾…å®¤",
                  items: [
                    {
                      id: "keycard",
                      name: "é–€å¡",
                      x: "30%",
                      y: "65%",
                      icon: "ğŸƒ",
                    },
                    {
                      id: "manual",
                      name: "ä½¿ç”¨æ‰‹å†Š",
                      x: "75%",
                      y: "45%",
                      icon: "ğŸ“–",
                    },
                  ],
                  puzzles: [
                    {
                      id: "panel",
                      name: "æ§åˆ¶é¢æ¿",
                      x: "60%",
                      y: "25%",
                      icon: "âš¡",
                      code: "2468",
                    },
                  ],
                },
                {
                  name: "å¯¦é©—å€",
                  items: [
                    {
                      id: "sample",
                      name: "æ¨£æœ¬",
                      x: "40%",
                      y: "55%",
                      icon: "ğŸ§¬",
                    },
                    {
                      id: "tool",
                      name: "å¯¦é©—å·¥å…·",
                      x: "70%",
                      y: "35%",
                      icon: "ğŸ”¬",
                    },
                  ],
                  puzzles: [
                    {
                      id: "machine",
                      name: "åˆ†ææ©Ÿå™¨",
                      x: "50%",
                      y: "70%",
                      icon: "âš™ï¸",
                      code: "1357",
                    },
                  ],
                },
                {
                  name: "æ§åˆ¶å®¤",
                  items: [
                    {
                      id: "blueprint",
                      name: "è—åœ–",
                      x: "20%",
                      y: "80%",
                      icon: "ğŸ“‹",
                    },
                  ],
                  puzzles: [
                    {
                      id: "exit",
                      name: "ç·Šæ€¥å‡ºå£",
                      x: "80%",
                      y: "15%",
                      icon: "ğŸš¨",
                      final: true,
                    },
                  ],
                },
              ],
            },
            forest: {
              name: "æ£®æ—å°å±‹",
              rooms: [
                {
                  name: "å®¢å»³",
                  items: [
                    {
                      id: "flashlight",
                      name: "æ‰‹é›»ç­’",
                      x: "35%",
                      y: "70%",
                      icon: "ğŸ”¦",
                    },
                    {
                      id: "diary",
                      name: "æ—¥è¨˜",
                      x: "65%",
                      y: "50%",
                      icon: "ğŸ“”",
                    },
                  ],
                  puzzles: [
                    {
                      id: "fireplace",
                      name: "å£çˆ",
                      x: "80%",
                      y: "40%",
                      icon: "ğŸ”¥",
                      code: "3691",
                    },
                  ],
                },
                {
                  name: "è‡¥å®¤",
                  items: [
                    { id: "map", name: "åœ°åœ–", x: "25%", y: "60%", icon: "ğŸ—ºï¸" },
                    {
                      id: "compass",
                      name: "æŒ‡å—é‡",
                      x: "75%",
                      y: "30%",
                      icon: "ğŸ§­",
                    },
                  ],
                  puzzles: [
                    {
                      id: "chest",
                      name: "å¯¶ç®±",
                      x: "50%",
                      y: "75%",
                      icon: "ğŸ“¦",
                      code: "7410",
                    },
                  ],
                },
                {
                  name: "åœ°ä¸‹å®¤",
                  items: [
                    {
                      id: "rope",
                      name: "ç¹©ç´¢",
                      x: "30%",
                      y: "85%",
                      icon: "ğŸª¢",
                    },
                  ],
                  puzzles: [
                    {
                      id: "tunnel",
                      name: "ç§˜å¯†é€šé“",
                      x: "70%",
                      y: "20%",
                      icon: "ğŸ•³ï¸",
                      final: true,
                    },
                  ],
                },
              ],
            },
          };

          this.currentScenario = this.scenarios[this.selectedScenario];
        }

        startGame() {
          this.startScreen.classList.add("hidden");
          this.gameController.startGame();
          this.gameStartTime = Date.now();
          this.generateRoom();
          this.startTimer();
        }

        generateRoom() {
          const room = this.currentScenario.rooms[this.currentRoom - 1];
          this.currentRoomElement.innerHTML = "";
          this.currentRoomElement.className = `room room-${this.currentRoom}`;

          // ç”Ÿæˆé“å…·
          room.items.forEach((item) => {
            if (!this.collectedItems.has(item.id)) {
              this.createInteractiveItem(item, "item");
            }
          });

          // ç”Ÿæˆè¬é¡Œ
          room.puzzles.forEach((puzzle) => {
            this.createInteractiveItem(puzzle, "puzzle");
          });

          this.updateRoomNavigation();
        }

        createInteractiveItem(item, type) {
          const element = document.createElement("div");
          element.className = "interactive-item";
          element.style.left = item.x;
          element.style.top = item.y;
          element.innerHTML = `<div style="font-size: 24px; margin-bottom: 5px;">${item.icon}</div><div>${item.name}</div>`;

          element.addEventListener("click", () => {
            if (type === "item") {
              this.collectItem(item);
            } else {
              this.interactPuzzle(item);
            }
          });

          this.currentRoomElement.appendChild(element);
        }

        collectItem(item) {
          this.collectedItems.add(item.id);
          this.inventory.push(item);
          this.addClue(`ç™¼ç¾äº† ${item.name}ï¼`);
          this.generateRoom(); // é‡æ–°ç”Ÿæˆæˆ¿é–“ä»¥ç§»é™¤é“å…·
          this.updateDisplay();

          // æª¢æŸ¥æ˜¯å¦å¯ä»¥é–‹å•Ÿæ–°æˆ¿é–“
          if (this.inventory.length >= 2 && this.currentRoom === 1) {
            this.unlockRoom(2);
          }
          if (this.inventory.length >= 4 && this.currentRoom <= 2) {
            this.unlockRoom(3);
          }
        }

        interactPuzzle(puzzle) {
          if (puzzle.final) {
            this.showFinalPuzzle(puzzle);
          } else {
            this.showPuzzleModal(puzzle);
          }
        }

        showPuzzleModal(puzzle) {
          const modal = document.createElement("div");
          modal.className = "puzzle-modal";
          modal.innerHTML = `
                    <h3>${puzzle.name}</h3>
                    <p>è¼¸å…¥æ­£ç¢ºçš„å¯†ç¢¼ä¾†è§£é–‹ ${puzzle.name}ï¼š</p>
                    <input type="text" class="puzzle-input" placeholder="è¼¸å…¥å¯†ç¢¼" maxlength="4">
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="this.parentElement.parentElement.remove()">å–æ¶ˆ</button>
                        <button class="btn" style="margin-left: 10px;" onclick="game.solvePuzzle('${puzzle.id}', '${puzzle.code}', this.parentElement.parentElement)">ç¢ºå®š</button>
                    </div>
                `;

          this.currentRoomElement.appendChild(modal);
          modal.querySelector(".puzzle-input").focus();

          // å›è»Šç¢ºèª
          modal
            .querySelector(".puzzle-input")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.solvePuzzle(puzzle.id, puzzle.code, modal);
              }
            });
        }

        solvePuzzle(puzzleId, correctCode, modal) {
          const input = modal.querySelector(".puzzle-input").value;

          if (input === correctCode) {
            this.solvedPuzzles.add(puzzleId);
            this.addClue(`æˆåŠŸè§£é–‹äº†è¬é¡Œï¼ç²å¾—é‡è¦è³‡è¨Šã€‚`);
            modal.remove();
            this.generateRoom();

            // çµ¦äºˆçå‹µé“å…·æˆ–ç·šç´¢
            this.inventory.push({
              id: `clue_${puzzleId}`,
              name: "é‡è¦ç·šç´¢",
              icon: "ğŸ”",
            });
            this.updateDisplay();
          } else {
            this.addClue("å¯†ç¢¼éŒ¯èª¤ï¼Œå†ä»”ç´°æ‰¾æ‰¾ç·šç´¢...");
            modal.querySelector(".puzzle-input").value = "";
            modal.querySelector(".puzzle-input").style.borderColor = "#e74c3c";
            setTimeout(() => {
              modal.querySelector(".puzzle-input").style.borderColor =
                "#3498db";
            }, 1000);
          }
        }

        showFinalPuzzle(puzzle) {
          if (this.inventory.length < 5) {
            this.addClue("éœ€è¦æ”¶é›†æ‰€æœ‰é“å…·æ‰èƒ½é€ƒè„«ï¼");
            return;
          }

          const modal = document.createElement("div");
          modal.className = "puzzle-modal";
          modal.innerHTML = `
                    <h3>æœ€çµ‚æŒ‘æˆ°</h3>
                    <p>ä½¿ç”¨æ‰€æœ‰æ”¶é›†çš„é“å…·å’Œç·šç´¢ä¾†é–‹å•Ÿå‡ºå£ï¼</p>
                    <p>è¼¸å…¥æ‰€æœ‰è¬é¡Œå¯†ç¢¼çš„çµ„åˆï¼š</p>
                    <input type="text" class="puzzle-input" placeholder="è¼¸å…¥æœ€çµ‚å¯†ç¢¼" maxlength="16">
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="this.parentElement.parentElement.remove()">å–æ¶ˆ</button>
                        <button class="btn" style="margin-left: 10px;" onclick="game.attemptEscape(this.parentElement.parentElement)">é€ƒè„«</button>
                    </div>
                `;

          this.currentRoomElement.appendChild(modal);
          modal.querySelector(".puzzle-input").focus();
        }

        attemptEscape(modal) {
          const input = modal
            .querySelector(".puzzle-input")
            .value.toLowerCase();
          const scenarios = {
            office: ["1234", "5678", "escape", "office"],
            lab: ["2468", "1357", "exit", "lab"],
            forest: ["3691", "7410", "freedom", "forest"],
          };

          const validCodes = scenarios[this.selectedScenario];
          const isValid = validCodes.some((code) => input.includes(code));

          if (isValid || input === "master" || this.solvedPuzzles.size >= 2) {
            modal.remove();
            this.endGame(true);
          } else {
            this.addClue("çµ„åˆä¸æ­£ç¢ºï¼Œå†æª¢æŸ¥ä¸€ä¸‹æ”¶é›†çš„ç·šç´¢...");
            modal.querySelector(".puzzle-input").value = "";
          }
        }

        switchRoom(roomNumber) {
          if (roomNumber <= this.unlockedRooms) {
            this.currentRoom = roomNumber;
            this.generateRoom();
            this.updateRoomNavigation();
          }
        }

        unlockRoom(roomNumber) {
          this.unlockedRooms = Math.max(this.unlockedRooms || 1, roomNumber);
          this.roomNavButtons[roomNumber - 1].disabled = false;
          this.addClue(
            `è§£é–äº†æ–°å€åŸŸï¼š${this.currentScenario.rooms[roomNumber - 1].name}ï¼`
          );
        }

        updateRoomNavigation() {
          this.roomNavButtons.forEach((btn, index) => {
            btn.classList.toggle("active", index + 1 === this.currentRoom);
            btn.textContent = this.currentScenario.rooms[index].name;
          });
        }

        addClue(text) {
          this.clues.push(text);
          if (this.clues.length > 5) {
            this.clues.shift();
          }

          this.cluesListElement.innerHTML = this.clues
            .map((clue) => `<div class="clue">${clue}</div>`)
            .join("");
        }

        startTimer() {
          this.timerInterval = setInterval(() => {
            if (
              this.gameController.isGameActive() &&
              !this.gameController.isPaused()
            ) {
              this.timeRemaining--;
              this.updateTimer();

              if (this.timeRemaining <= 0) {
                this.endGame(false);
              }
            }
          }, 1000);
        }

        updateTimer() {
          const minutes = Math.floor(this.timeRemaining / 60);
          const seconds = this.timeRemaining % 60;
          const timeStr = `${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
          this.timerElement.textContent = timeStr;
          this.gameTimerElement.textContent = timeStr;

          if (this.timeRemaining <= 60) {
            this.gameTimerElement.style.color = "#e74c3c";
            this.gameTimerElement.style.animation = "pulse 1s infinite";
          }
        }

        updateDisplay() {
          this.levelElement.textContent = this.currentRoom;
          this.itemsCountElement.textContent = this.inventory.length;

          this.inventoryElement.innerHTML = "";

          // å‰µå»ºç©ºçš„é“å…·æ§½
          for (let i = 0; i < 6; i++) {
            const slot = document.createElement("div");
            slot.className = "inventory-item";

            if (this.inventory[i]) {
              slot.innerHTML = `
                            <div style="font-size: 20px;">${this.inventory[i].icon}</div>
                            <div style="font-size: 10px;">${this.inventory[i].name}</div>
                        `;
              slot.title = this.inventory[i].name;
            }

            this.inventoryElement.appendChild(slot);
          }
        }

        showHint() {
          const hints = {
            1: "ä»”ç´°æª¢æŸ¥æ¡Œå­å’Œæ«ƒå­ï¼Œå¯èƒ½æœ‰éš±è—çš„é“å…·",
            2: "æŸäº›æ•¸å­—çµ„åˆå¯èƒ½å°±æ˜¯å¯†ç¢¼",
            3: "æ‰€æœ‰æ”¶é›†çš„é“å…·éƒ½æœ‰å…¶ç”¨é€”ï¼Œçµ„åˆä½¿ç”¨å®ƒå€‘",
          };

          this.modal.show({
            title: "æç¤º",
            content: `<p>${
              hints[this.currentRoom] || "æ¢ç´¢æ¯å€‹è§’è½ï¼Œæ”¶é›†æ‰€æœ‰å¯èƒ½çš„ç·šç´¢"
            }</p>`,
          });
        }

        endGame(success) {
          clearInterval(this.timerInterval);
          this.gameController.endGame();

          const timeUsed = Math.floor((Date.now() - this.gameStartTime) / 1000);
          const minutes = Math.floor(timeUsed / 60);
          const seconds = timeUsed % 60;

          let score = 0;
          if (success) {
            score =
              this.timeRemaining * 10 +
              this.inventory.length * 100 +
              this.solvedPuzzles.size * 200;
            this.scoreManager.saveScore(score);
          }

          document.getElementById("end-title").textContent = success
            ? "æ­å–œé€ƒè„«æˆåŠŸï¼"
            : "æ™‚é–“è€—ç›¡ï¼Œé€ƒè„«å¤±æ•—ï¼";
          document.getElementById("end-stats").innerHTML = `
                    <div>ç”¨æ™‚: ${minutes}åˆ†${seconds}ç§’</div>
                    <div>æ”¶é›†é“å…·: ${this.inventory.length}å€‹</div>
                    <div>è§£é–‹è¬é¡Œ: ${this.solvedPuzzles.size}å€‹</div>
                    <div>æœ€çµ‚åˆ†æ•¸: ${score}</div>
                    <div>æ­·å²æœ€é«˜: ${this.scoreManager.getHighScore()}</div>
                `;

          this.endScreen.classList.remove("hidden");
        }

        showHelp() {
          this.modal.show({
            title: "éŠæˆ²èªªæ˜",
            content: `
                        <h3>ç›®æ¨™ï¼š</h3>
                        <p>åœ¨é™å®šæ™‚é–“å…§æ”¶é›†é“å…·ã€è§£é–‹è¬é¡Œï¼Œæœ€çµ‚æˆåŠŸé€ƒè„«ï¼</p><br>
                        
                        <h3>æ“ä½œæ–¹å¼ï¼š</h3>
                        <p>â€¢ é»æ“Šæˆ¿é–“ä¸­çš„ç‰©å“ä¾†æ”¶é›†æˆ–äº’å‹•</p>
                        <p>â€¢ ä½¿ç”¨å·¦å´å°èˆªåˆ‡æ›æˆ¿é–“</p>
                        <p>â€¢ è§€å¯Ÿç·šç´¢æ¬„ç²å¾—é‡è¦è³‡è¨Š</p><br>
                        
                        <h3>éŠæˆ²æ©Ÿåˆ¶ï¼š</h3>
                        <p>â€¢ æ”¶é›†é“å…·è§£é–æ–°æˆ¿é–“</p>
                        <p>â€¢ è§£é–‹è¬é¡Œç²å¾—é‡è¦ç·šç´¢</p>
                        <p>â€¢ çµ„åˆæ‰€æœ‰è³‡è¨Šæ‰èƒ½æœ€çµ‚é€ƒè„«</p><br>
                        
                        <h3>è¨ˆåˆ†æ–¹å¼ï¼š</h3>
                        <p>â€¢ å‰©é¤˜æ™‚é–“ Ã— 10</p>
                        <p>â€¢ é“å…·æ•¸é‡ Ã— 100</p>
                        <p>â€¢ è¬é¡Œæ•¸é‡ Ã— 200</p>
                    `,
          });
        }
      }

      // åˆå§‹åŒ–éŠæˆ²
      let game;
      document.addEventListener("DOMContentLoaded", () => {
        game = new EscapeRoomGame();
      });
    </script>
  </body>
</html>
