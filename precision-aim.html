<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç²¾æº–ç„æº–</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        font-family: "Arial", sans-serif;
        overflow: hidden;
        color: white;
      }

      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      .ui-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .score-panel {
        display: flex;
        gap: 20px;
        font-size: 1.2em;
        font-weight: bold;
      }

      .controls {
        display: flex;
        gap: 10px;
      }

      .control-button {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .control-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .game-canvas {
        width: 100%;
        height: 100%;
        cursor: crosshair;
        background: radial-gradient(circle at center, #1e3c72 0%, #0f1429 100%);
      }

      .target {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .target.normal {
        background: radial-gradient(circle, #ff6b6b, #ee5a52);
        border: 3px solid #fff;
      }

      .target.bonus {
        background: radial-gradient(circle, #ffd700, #ffed4e);
        border: 3px solid #fff;
        animation: glow 1s ease-in-out infinite alternate;
      }

      .target.fast {
        background: radial-gradient(circle, #4ecdc4, #44a08d);
        border: 3px solid #fff;
        animation: pulse 0.5s ease-in-out infinite;
      }

      .target.mini {
        background: radial-gradient(circle, #9b59b6, #8e44ad);
        border: 2px solid #fff;
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        100% {
          box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .hit-effect {
        position: absolute;
        pointer-events: none;
        border-radius: 50%;
        animation: hit-expand 0.5s ease-out forwards;
      }

      @keyframes hit-expand {
        0% {
          width: 20px;
          height: 20px;
          opacity: 1;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.8),
            transparent
          );
        }
        100% {
          width: 100px;
          height: 100px;
          opacity: 0;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0),
            transparent
          );
        }
      }

      .miss-effect {
        position: absolute;
        pointer-events: none;
        color: #ff6b6b;
        font-size: 2em;
        font-weight: bold;
        animation: miss-fade 1s ease-out forwards;
      }

      @keyframes miss-fade {
        0% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-50px);
        }
      }

      .score-popup {
        position: absolute;
        pointer-events: none;
        color: #ffd700;
        font-size: 1.5em;
        font-weight: bold;
        animation: score-rise 1s ease-out forwards;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      @keyframes score-rise {
        0% {
          opacity: 1;
          transform: translateY(0) scale(0.8);
        }
        50% {
          transform: translateY(-30px) scale(1.2);
        }
        100% {
          opacity: 0;
          transform: translateY(-60px) scale(1);
        }
      }

      .game-over-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 500px;
        color: white;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-content h2 {
        margin: 0 0 20px 0;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 20px 0;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(5px);
      }

      .difficulty-selector {
        margin: 20px 0;
      }

      .difficulty-button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid transparent;
        padding: 10px 20px;
        margin: 0 5px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
      }

      .difficulty-button.active {
        border-color: #4ecdc4;
        background: rgba(78, 205, 196, 0.3);
      }

      .difficulty-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .crosshair {
        position: absolute;
        pointer-events: none;
        z-index: 50;
        transform: translate(-50%, -50%);
      }

      .crosshair::before,
      .crosshair::after {
        content: "";
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 1px;
      }

      .crosshair::before {
        width: 20px;
        height: 2px;
        left: -10px;
        top: -1px;
      }

      .crosshair::after {
        width: 2px;
        height: 20px;
        left: -1px;
        top: -10px;
      }

      .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        z-index: 200;
      }

      .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      @media (max-width: 600px) {
        .ui-overlay {
          padding: 10px;
          flex-direction: column;
          gap: 10px;
        }

        .score-panel {
          font-size: 1em;
          gap: 10px;
        }

        .controls {
          flex-wrap: wrap;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <button class="back-button" onclick="window.location.href='index.html'">
      â† è¿”å›
    </button>

    <div class="game-container">
      <div class="ui-overlay">
        <div class="score-panel">
          <div>åˆ†æ•¸: <span id="score">0</span></div>
          <div>å‘½ä¸­: <span id="hits">0</span></div>
          <div>ç²¾æº–åº¦: <span id="accuracy">100%</span></div>
          <div>æ™‚é–“: <span id="time">60</span>s</div>
        </div>

        <div class="controls">
          <button class="control-button" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
          <button class="control-button" onclick="pauseGame()">æš«åœ</button>
          <button class="control-button" onclick="showSettings()">è¨­å®š</button>
          <button class="control-button" onclick="showHelp()">èªªæ˜</button>
        </div>
      </div>

      <div class="game-canvas" id="gameCanvas">
        <div class="crosshair" id="crosshair"></div>
      </div>
    </div>

    <!-- éŠæˆ²çµæŸæ¨¡æ…‹æ¡† -->
    <div class="game-over-modal" id="gameOverModal">
      <div class="modal-content">
        <h2>ğŸ¯ éŠæˆ²çµæŸ</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div>æœ€çµ‚åˆ†æ•¸</div>
            <div style="font-size: 1.5em; color: #ffd700" id="finalScore">
              0
            </div>
          </div>
          <div class="stat-item">
            <div>å‘½ä¸­ç›®æ¨™</div>
            <div style="font-size: 1.5em; color: #4ecdc4" id="finalHits">0</div>
          </div>
          <div class="stat-item">
            <div>å°„æ“Šç²¾æº–åº¦</div>
            <div style="font-size: 1.5em; color: #ff6b6b" id="finalAccuracy">
              100%
            </div>
          </div>
          <div class="stat-item">
            <div>å¹³å‡åæ‡‰æ™‚é–“</div>
            <div style="font-size: 1.5em; color: #9b59b6" id="avgReaction">
              0ms
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="control-button" onclick="restartGame()">
            å†ç©ä¸€æ¬¡
          </button>
          <button class="control-button" onclick="closeModal()">
            è¿”å›é¸å–®
          </button>
        </div>
      </div>
    </div>

    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div class="game-over-modal" id="settingsModal">
      <div class="modal-content">
        <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>

        <div class="difficulty-selector">
          <h3>é›£åº¦é¸æ“‡</h3>
          <button
            class="difficulty-button active"
            onclick="setDifficulty('easy')"
          >
            ç°¡å–®
          </button>
          <button class="difficulty-button" onclick="setDifficulty('normal')">
            æ™®é€š
          </button>
          <button class="difficulty-button" onclick="setDifficulty('hard')">
            å›°é›£
          </button>
          <button class="difficulty-button" onclick="setDifficulty('expert')">
            å°ˆå®¶
          </button>
        </div>

        <div style="margin: 20px 0">
          <h3>éŠæˆ²æ™‚é•·</h3>
          <button class="difficulty-button" onclick="setGameTime(30)">
            30ç§’
          </button>
          <button class="difficulty-button active" onclick="setGameTime(60)">
            60ç§’
          </button>
          <button class="difficulty-button" onclick="setGameTime(90)">
            90ç§’
          </button>
          <button class="difficulty-button" onclick="setGameTime(120)">
            120ç§’
          </button>
        </div>

        <div class="controls">
          <button class="control-button" onclick="closeSettings()">ç¢ºå®š</button>
        </div>
      </div>
    </div>

    <!-- èªªæ˜æ¨¡æ…‹æ¡† -->
    <div class="game-over-modal" id="helpModal">
      <div class="modal-content">
        <h2>ğŸ¯ éŠæˆ²èªªæ˜</h2>
        <div style="text-align: left; max-height: 60vh; overflow-y: auto">
          <h3>ğŸ“‹ éŠæˆ²ç›®æ¨™</h3>
          <p>åœ¨é™å®šæ™‚é–“å…§é»æ“Šå‡ºç¾çš„ç›®æ¨™ï¼Œç²å¾—æœ€é«˜åˆ†æ•¸å’Œæœ€ä½³ç²¾æº–åº¦ï¼</p>

          <h3>ğŸ® æ“ä½œæ–¹å¼</h3>
          <ul>
            <li>ä½¿ç”¨æ»‘é¼ ç„æº–ä¸¦é»æ“Šç›®æ¨™</li>
            <li>åå­—æº–æ˜Ÿæœƒè·Ÿéš¨æ»‘é¼ ç§»å‹•</li>
            <li>å¿«é€Ÿæº–ç¢ºåœ°é»æ“Šä»¥ç²å¾—é«˜åˆ†</li>
          </ul>

          <h3>ğŸ¯ ç›®æ¨™é¡å‹</h3>
          <ul>
            <li>ğŸ”´ æ™®é€šç›®æ¨™: åŸºæœ¬åˆ†æ•¸</li>
            <li>ğŸŸ¡ çå‹µç›®æ¨™: 2å€åˆ†æ•¸ + é–ƒå…‰æ•ˆæœ</li>
            <li>ğŸ”µ å¿«é€Ÿç›®æ¨™: ç§»å‹•ç›®æ¨™ï¼Œé«˜åˆ†å€¼</li>
            <li>ğŸŸ£ è¿·ä½ ç›®æ¨™: å°å°ºå¯¸ï¼Œè¶…é«˜åˆ†å€¼</li>
          </ul>

          <h3>ğŸ“Š è¨ˆåˆ†ç³»çµ±</h3>
          <ul>
            <li>æ ¹æ“šç›®æ¨™é¡å‹å’Œåæ‡‰é€Ÿåº¦è¨ˆåˆ†</li>
            <li>é€£çºŒå‘½ä¸­ç²å¾—é€£æ“ŠåŠ æˆ</li>
            <li>éŒ¯éç›®æ¨™æœƒé‡ç½®é€£æ“Š</li>
          </ul>

          <h3>âš™ï¸ é›£åº¦ç´šåˆ¥</h3>
          <ul>
            <li>ç°¡å–®: å¤§ç›®æ¨™ï¼Œæ…¢é€Ÿåº¦</li>
            <li>æ™®é€š: ä¸­ç­‰å¤§å°å’Œé€Ÿåº¦</li>
            <li>å›°é›£: å°ç›®æ¨™ï¼Œå¿«é€Ÿæ¶ˆå¤±</li>
            <li>å°ˆå®¶: æ¥µå°ç›®æ¨™ï¼Œæ¥µå¿«é€Ÿåº¦</li>
          </ul>
        </div>

        <div class="controls" style="margin-top: 20px">
          <button class="control-button" onclick="closeHelp()">ç¢ºå®š</button>
        </div>
      </div>
    </div>

    <script src="gameUtils.js"></script>
    <script>
      let gameState = "waiting"; // waiting, playing, paused, finished
      let score = 0;
      let hits = 0;
      let shots = 0;
      let gameTime = 60;
      let timeLeft = gameTime;
      let targets = [];
      let gameTimer = null;
      let spawnTimer = null;
      let difficulty = "normal";
      let combo = 0;
      let reactionTimes = [];
      let targetStartTime = null;

      const difficulties = {
        easy: {
          targetSize: { min: 80, max: 120 },
          spawnRate: 1500,
          lifetime: 3000,
          maxTargets: 3,
          speed: 0.5,
        },
        normal: {
          targetSize: { min: 60, max: 100 },
          spawnRate: 1200,
          lifetime: 2500,
          maxTargets: 4,
          speed: 1,
        },
        hard: {
          targetSize: { min: 40, max: 80 },
          spawnRate: 1000,
          lifetime: 2000,
          maxTargets: 5,
          speed: 1.5,
        },
        expert: {
          targetSize: { min: 30, max: 60 },
          spawnRate: 800,
          lifetime: 1500,
          maxTargets: 6,
          speed: 2,
        },
      };

      // åå­—æº–æ˜Ÿè·Ÿéš¨æ»‘é¼ 
      document.addEventListener("mousemove", (event) => {
        const crosshair = document.getElementById("crosshair");
        crosshair.style.left = event.clientX + "px";
        crosshair.style.top = event.clientY + "px";
      });

      // é–‹å§‹éŠæˆ²
      function startGame() {
        if (gameState === "playing") return;

        gameState = "playing";
        score = 0;
        hits = 0;
        shots = 0;
        combo = 0;
        timeLeft = gameTime;
        targets = [];
        reactionTimes = [];

        updateUI();
        clearTargets();

        // é–‹å§‹ç”Ÿæˆç›®æ¨™
        spawnTargets();

        // é–‹å§‹å€’æ•¸è¨ˆæ™‚
        gameTimer = setInterval(() => {
          timeLeft--;
          updateUI();

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }

      // æš«åœéŠæˆ²
      function pauseGame() {
        if (gameState === "playing") {
          gameState = "paused";
          clearInterval(gameTimer);
          clearTimeout(spawnTimer);

          // æš«åœæ‰€æœ‰ç›®æ¨™å‹•ç•«
          targets.forEach((target) => {
            target.element.style.animationPlayState = "paused";
          });
        } else if (gameState === "paused") {
          gameState = "playing";

          // ç¹¼çºŒå€’æ•¸è¨ˆæ™‚
          gameTimer = setInterval(() => {
            timeLeft--;
            updateUI();

            if (timeLeft <= 0) {
              endGame();
            }
          }, 1000);

          // ç¹¼çºŒç”Ÿæˆç›®æ¨™
          spawnTargets();

          // ç¹¼çºŒæ‰€æœ‰ç›®æ¨™å‹•ç•«
          targets.forEach((target) => {
            target.element.style.animationPlayState = "running";
          });
        }
      }

      // ç”Ÿæˆç›®æ¨™
      function spawnTargets() {
        if (gameState !== "playing") return;

        const config = difficulties[difficulty];

        // å¦‚æœç›®æ¨™æ•¸é‡æœªé”ä¸Šé™ï¼Œç”Ÿæˆæ–°ç›®æ¨™
        if (targets.length < config.maxTargets) {
          createTarget();
        }

        spawnTimer = setTimeout(spawnTargets, config.spawnRate);
      }

      // å‰µå»ºç›®æ¨™
      function createTarget() {
        const config = difficulties[difficulty];
        const canvas = document.getElementById("gameCanvas");
        const canvasRect = canvas.getBoundingClientRect();

        // éš¨æ©Ÿç›®æ¨™é¡å‹
        const types = ["normal", "normal", "normal", "bonus", "fast", "mini"];
        const type = types[Math.floor(Math.random() * types.length)];

        // æ ¹æ“šé¡å‹è¨­å®šå¤§å°
        let size;
        switch (type) {
          case "bonus":
            size =
              Math.random() * (config.targetSize.max - config.targetSize.min) +
              config.targetSize.min;
            break;
          case "fast":
            size = (config.targetSize.min + config.targetSize.max) / 2;
            break;
          case "mini":
            size = config.targetSize.min * 0.7;
            break;
          default:
            size =
              Math.random() * (config.targetSize.max - config.targetSize.min) +
              config.targetSize.min;
        }

        // éš¨æ©Ÿä½ç½®ï¼ˆç¢ºä¿å®Œå…¨åœ¨ç•«å¸ƒå…§ï¼‰
        const x = Math.random() * (canvasRect.width - size - 40) + 20;
        const y = Math.random() * (canvasRect.height - size - 120) + 100; // é¿é–‹UIå€åŸŸ

        // å‰µå»ºç›®æ¨™å…ƒç´ 
        const targetElement = document.createElement("div");
        targetElement.className = `target ${type}`;
        targetElement.style.width = size + "px";
        targetElement.style.height = size + "px";
        targetElement.style.left = x + "px";
        targetElement.style.top = y + "px";

        // è¨­å®šåˆ†æ•¸é¡¯ç¤º
        const baseScore = Math.round(size / 10);
        const scoreText =
          type === "bonus"
            ? baseScore * 2
            : type === "fast"
            ? baseScore * 1.5
            : type === "mini"
            ? baseScore * 3
            : baseScore;
        targetElement.textContent = "+" + Math.round(scoreText);

        const target = {
          element: targetElement,
          type: type,
          size: size,
          x: x,
          y: y,
          baseScore: Math.round(scoreText),
          startTime: performance.now(),
          lifetime: config.lifetime,
        };

        // é»æ“Šäº‹ä»¶
        targetElement.addEventListener("click", (event) => {
          event.stopPropagation();
          hitTarget(target);
        });

        canvas.appendChild(targetElement);
        targets.push(target);

        // å¦‚æœæ˜¯ç§»å‹•ç›®æ¨™ï¼Œæ·»åŠ ç§»å‹•å‹•ç•«
        if (type === "fast") {
          moveTarget(target);
        }

        // è¨­å®šç”Ÿå‘½é€±æœŸ
        setTimeout(() => {
          removeTarget(target);
        }, config.lifetime);
      }

      // ç§»å‹•ç›®æ¨™
      function moveTarget(target) {
        const canvas = document.getElementById("gameCanvas");
        const canvasRect = canvas.getBoundingClientRect();
        const config = difficulties[difficulty];

        let vx = (Math.random() - 0.5) * config.speed * 2;
        let vy = (Math.random() - 0.5) * config.speed * 2;

        const moveInterval = setInterval(() => {
          if (gameState !== "playing" || !targets.includes(target)) {
            clearInterval(moveInterval);
            return;
          }

          target.x += vx;
          target.y += vy;

          // é‚Šç•Œç¢°æ’æª¢æ¸¬
          if (target.x <= 0 || target.x >= canvasRect.width - target.size) {
            vx = -vx;
            target.x = Math.max(
              0,
              Math.min(canvasRect.width - target.size, target.x)
            );
          }
          if (target.y <= 100 || target.y >= canvasRect.height - target.size) {
            vy = -vy;
            target.y = Math.max(
              100,
              Math.min(canvasRect.height - target.size, target.y)
            );
          }

          target.element.style.left = target.x + "px";
          target.element.style.top = target.y + "px";
        }, 16);
      }

      // å‘½ä¸­ç›®æ¨™
      function hitTarget(target) {
        if (gameState !== "playing") return;

        hits++;
        shots++;
        combo++;

        // è¨ˆç®—åæ‡‰æ™‚é–“
        const reactionTime = performance.now() - target.startTime;
        reactionTimes.push(reactionTime);

        // è¨ˆç®—åˆ†æ•¸ï¼ˆåŒ…å«é€£æ“ŠåŠ æˆï¼‰
        const comboMultiplier = Math.min(1 + (combo - 1) * 0.1, 3); // æœ€é«˜3å€
        const finalScore = Math.round(target.baseScore * comboMultiplier);
        score += finalScore;

        // å‰µå»ºå‘½ä¸­æ•ˆæœ
        createHitEffect(target.x + target.size / 2, target.y + target.size / 2);
        createScorePopup(
          target.x + target.size / 2,
          target.y + target.size / 2,
          `+${finalScore}`
        );

        // ç§»é™¤ç›®æ¨™
        removeTarget(target);
        updateUI();
      }

      // ç§»é™¤ç›®æ¨™
      function removeTarget(target) {
        const index = targets.indexOf(target);
        if (index > -1) {
          targets.splice(index, 1);
          if (target.element && target.element.parentNode) {
            target.element.parentNode.removeChild(target.element);
          }
        }
      }

      // æ¸…ç©ºæ‰€æœ‰ç›®æ¨™
      function clearTargets() {
        targets.forEach((target) => {
          if (target.element && target.element.parentNode) {
            target.element.parentNode.removeChild(target.element);
          }
        });
        targets = [];
      }

      // å‰µå»ºå‘½ä¸­æ•ˆæœ
      function createHitEffect(x, y) {
        const effect = document.createElement("div");
        effect.className = "hit-effect";
        effect.style.left = x - 10 + "px";
        effect.style.top = y - 10 + "px";

        document.getElementById("gameCanvas").appendChild(effect);

        setTimeout(() => {
          if (effect.parentNode) {
            effect.parentNode.removeChild(effect);
          }
        }, 500);
      }

      // å‰µå»ºåˆ†æ•¸å½ˆå‡ºæ•ˆæœ
      function createScorePopup(x, y, text) {
        const popup = document.createElement("div");
        popup.className = "score-popup";
        popup.textContent = text;
        popup.style.left = x + "px";
        popup.style.top = y + "px";

        document.getElementById("gameCanvas").appendChild(popup);

        setTimeout(() => {
          if (popup.parentNode) {
            popup.parentNode.removeChild(popup);
          }
        }, 1000);
      }

      // è™•ç†ç•«å¸ƒé»æ“Šï¼ˆéŒ¯éï¼‰
      document
        .getElementById("gameCanvas")
        .addEventListener("click", (event) => {
          if (gameState === "playing") {
            shots++;
            combo = 0; // é‡ç½®é€£æ“Š

            // å‰µå»ºéŒ¯éæ•ˆæœ
            const effect = document.createElement("div");
            effect.className = "miss-effect";
            effect.textContent = "MISS";
            effect.style.left = event.clientX + "px";
            effect.style.top = event.clientY + "px";

            document.body.appendChild(effect);

            setTimeout(() => {
              if (effect.parentNode) {
                effect.parentNode.removeChild(effect);
              }
            }, 1000);

            updateUI();
          }
        });

      // æ›´æ–°UI
      function updateUI() {
        document.getElementById("score").textContent = score;
        document.getElementById("hits").textContent = hits;
        document.getElementById("time").textContent = timeLeft;

        const accuracy = shots > 0 ? Math.round((hits / shots) * 100) : 100;
        document.getElementById("accuracy").textContent = accuracy + "%";
      }

      // çµæŸéŠæˆ²
      function endGame() {
        gameState = "finished";
        clearInterval(gameTimer);
        clearTimeout(spawnTimer);
        clearTargets();

        // è¨ˆç®—å¹³å‡åæ‡‰æ™‚é–“
        const avgReaction =
          reactionTimes.length > 0
            ? Math.round(
                reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length
              )
            : 0;

        // é¡¯ç¤ºçµæœ
        document.getElementById("finalScore").textContent = score;
        document.getElementById("finalHits").textContent = hits;
        document.getElementById("finalAccuracy").textContent =
          shots > 0 ? Math.round((hits / shots) * 100) + "%" : "100%";
        document.getElementById("avgReaction").textContent = avgReaction + "ms";

        document.getElementById("gameOverModal").style.display = "flex";

        // æ›´æ–°éŠæˆ²çµ±è¨ˆ
        GameUtils.updateGameStats("precision-aim", {
          gamesPlayed: 1,
          totalScore: score,
          bestScore: score,
        });
      }

      // é‡æ–°é–‹å§‹éŠæˆ²
      function restartGame() {
        closeModal();
        startGame();
      }

      // é—œé–‰æ¨¡æ…‹æ¡†
      function closeModal() {
        document.getElementById("gameOverModal").style.display = "none";
        gameState = "waiting";
      }

      // è¨­å®šé›£åº¦
      function setDifficulty(newDifficulty) {
        difficulty = newDifficulty;

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll(".difficulty-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");
      }

      // è¨­å®šéŠæˆ²æ™‚é–“
      function setGameTime(time) {
        gameTime = time;
        timeLeft = time;
        updateUI();

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll(".difficulty-button").forEach((btn) => {
          if (btn.textContent.includes(time + "ç§’")) {
            btn.classList.add("active");
          } else if (btn.textContent.includes("ç§’")) {
            btn.classList.remove("active");
          }
        });
      }

      // é¡¯ç¤ºè¨­å®š
      function showSettings() {
        document.getElementById("settingsModal").style.display = "flex";
      }

      // é—œé–‰è¨­å®š
      function closeSettings() {
        document.getElementById("settingsModal").style.display = "none";
      }

      // é¡¯ç¤ºèªªæ˜
      function showHelp() {
        document.getElementById("helpModal").style.display = "flex";
      }

      // é—œé–‰èªªæ˜
      function closeHelp() {
        document.getElementById("helpModal").style.display = "none";
      }

      // éµç›¤äº‹ä»¶
      document.addEventListener("keydown", (event) => {
        switch (event.key) {
          case " ":
            event.preventDefault();
            if (gameState === "waiting") {
              startGame();
            } else if (gameState === "playing" || gameState === "paused") {
              pauseGame();
            }
            break;
          case "Escape":
            closeModal();
            closeSettings();
            closeHelp();
            break;
          case "r":
          case "R":
            if (gameState === "finished") {
              restartGame();
            }
            break;
        }
      });

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      document.querySelectorAll(".game-over-modal").forEach((modal) => {
        modal.addEventListener("click", (event) => {
          if (event.target === event.currentTarget) {
            modal.style.display = "none";
          }
        });
      });

      // åˆå§‹åŒ–
      updateUI();
    </script>
  </body>
</html>
