<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›·å°„é˜²ç¦¦ - Laser Defense</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans TC", sans-serif;
        background: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        min-height: 100vh;
        overflow: hidden;
        position: relative;
      }

      .starfield {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(2px 2px at 20px 30px, #eee, transparent),
          radial-gradient(2px 2px at 40px 70px, #fff, transparent),
          radial-gradient(1px 1px at 90px 40px, #fff, transparent),
          radial-gradient(1px 1px at 130px 80px, #fff, transparent),
          radial-gradient(2px 2px at 160px 30px, #ddd, transparent);
        background-repeat: repeat;
        background-size: 200px 100px;
        animation: twinkle 3s ease-in-out infinite alternate;
      }

      @keyframes twinkle {
        0% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 1;
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
      }

      .title {
        font-size: 2.5rem;
        background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        margin-bottom: 10px;
        font-weight: 700;
      }

      .subtitle {
        font-size: 1.2rem;
        color: #00ffff;
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
      }

      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .score-info {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .score-item {
        background: rgba(0, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 255, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
      }

      .score-label {
        font-size: 0.9rem;
        color: #00ffff;
        font-weight: 500;
      }

      .score-value {
        font-size: 1.1rem;
        color: #ffffff;
        font-weight: 700;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #ff0080, #ff8000);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 0, 128, 0.3);
      }

      .btn-secondary {
        background: rgba(0, 255, 255, 0.2);
        color: #00ffff;
        border: 1px solid rgba(0, 255, 255, 0.3);
        backdrop-filter: blur(10px);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
      }

      .game-area {
        flex: 1;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 0;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 30px rgba(0, 255, 255, 0.1);
      }

      .game-canvas {
        width: 100%;
        height: 100%;
        display: block;
        border-radius: 13px;
      }

      .game-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #00ffff;
        font-size: 2rem;
        font-weight: 700;
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        z-index: 10;
        pointer-events: none;
      }

      .health-bar {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 200px;
        height: 20px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        border: 2px solid #00ffff;
        overflow: hidden;
      }

      .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00);
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      }

      .ammo-counter {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 255, 255, 0.1);
        padding: 10px 15px;
        border-radius: 10px;
        border: 1px solid rgba(0, 255, 255, 0.3);
        color: #00ffff;
        font-weight: 600;
      }

      .instructions {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 10px;
        max-width: 250px;
        font-size: 0.9rem;
        color: #00ffff;
        border: 1px solid rgba(0, 255, 255, 0.3);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        margin: 5% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        position: relative;
        border: 2px solid rgba(0, 255, 255, 0.3);
        color: #ffffff;
      }

      .close {
        color: #00ffff;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }

      .close:hover {
        color: #ff00ff;
        text-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .title {
          font-size: 2rem;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }

        .instructions {
          position: static;
          margin-top: 20px;
          width: 100%;
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="starfield"></div>

    <div class="container">
      <div class="header">
        <h1 class="title">ğŸš€ é›·å°„é˜²ç¦¦</h1>
        <p class="subtitle">ä¿è¡›åœ°çƒï¼Œæ“Šé€€å¤–æ˜Ÿå…¥ä¾µè€…ï¼</p>
      </div>

      <div class="controls">
        <div class="score-info">
          <div class="score-item">
            <div class="score-label">å¾—åˆ†</div>
            <div class="score-value" id="score">0</div>
          </div>
          <div class="score-item">
            <div class="score-label">ç­‰ç´š</div>
            <div class="score-value" id="level">1</div>
          </div>
          <div class="score-item">
            <div class="score-label">æ“Šæ¯€</div>
            <div class="score-value" id="destroyed">0</div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="showInstructions()">
            <i class="fas fa-question-circle"></i> èªªæ˜
          </button>
          <button class="btn btn-primary" onclick="startGame()">
            <i class="fas fa-play"></i> é–‹å§‹é˜²ç¦¦
          </button>
          <button class="btn btn-secondary" onclick="pauseGame()">
            <i class="fas fa-pause"></i> æš«åœ
          </button>
          <a href="index.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> è¿”å›
          </a>
        </div>
      </div>

      <div class="game-area">
        <canvas id="gameCanvas" class="game-canvas"></canvas>
        <div class="game-overlay" id="gameOverlay">é»æ“Šé–‹å§‹é˜²ç¦¦</div>

        <div class="health-bar">
          <div class="health-fill" id="healthFill" style="width: 100%"></div>
        </div>

        <div class="ammo-counter" id="ammoCounter">å½ˆè—¥: âˆ</div>

        <div class="instructions">
          <strong>æ“ä½œèªªæ˜ï¼š</strong><br />
          â€¢ æ»‘é¼ ç§»å‹•ç„æº–<br />
          â€¢ é»æ“Šç™¼å°„é›·å°„<br />
          â€¢ æ‘§æ¯€æ‰€æœ‰æ•µäºº<br />
          â€¢ é¿å…æ•µäººåˆ°é”åº•éƒ¨
        </div>
      </div>
    </div>

    <!-- èªªæ˜æ¨¡æ…‹æ¡† -->
    <div id="instructionModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ğŸš€ é›·å°„é˜²ç¦¦ - éŠæˆ²èªªæ˜</h2>
        <br />
        <h3>ğŸ¯ éŠæˆ²ç›®æ¨™</h3>
        <p>ä¿è¡›åœ°çƒå…å—å¤–æ˜Ÿå…¥ä¾µè€…çš„æ”»æ“Šï¼Œæ“Šæ¯€æ‰€æœ‰æ•µäººç²å¾—é«˜åˆ†ï¼</p>
        <br />
        <h3>ğŸ® æ“ä½œæ–¹å¼</h3>
        <ul>
          <li><strong>ç„æº–ï¼š</strong>æ»‘é¼ ç§»å‹•æ§åˆ¶ç„æº–å™¨</li>
          <li><strong>å°„æ“Šï¼š</strong>é»æ“Šæ»‘é¼ å·¦éµç™¼å°„é›·å°„</li>
          <li><strong>æš«åœï¼š</strong>é»æ“Šæš«åœæŒ‰éˆ•æˆ–æŒ‰ESCéµ</li>
          <li><strong>é‡æ–°é–‹å§‹ï¼š</strong>éŠæˆ²çµæŸå¾Œé»æ“Šé‡æ–°é–‹å§‹</li>
        </ul>
        <br />
        <h3>ğŸ‘¾ æ•µäººé¡å‹</h3>
        <ul>
          <li><strong>å°å‹é£›èˆ¹ï¼š</strong>ç§»å‹•å¿«é€Ÿï¼Œ1ç™¼æ‘§æ¯€ - 10åˆ†</li>
          <li><strong>ä¸­å‹é£›èˆ¹ï¼š</strong>ç§»å‹•ä¸­ç­‰ï¼Œ2ç™¼æ‘§æ¯€ - 25åˆ†</li>
          <li><strong>å¤§å‹é£›èˆ¹ï¼š</strong>ç§»å‹•ç·©æ…¢ï¼Œ3ç™¼æ‘§æ¯€ - 50åˆ†</li>
          <li><strong>BOSSé£›èˆ¹ï¼š</strong>è¡€é‡å¾ˆé«˜ï¼Œçå‹µè±åš - 200åˆ†</li>
        </ul>
        <br />
        <h3>ğŸ’¥ éŠæˆ²æ©Ÿåˆ¶</h3>
        <ul>
          <li>æ•µäººåˆ°é”åº•éƒ¨æœƒé€ æˆç”Ÿå‘½å€¼æå¤±</li>
          <li>ç”Ÿå‘½å€¼æ­¸é›¶å³éŠæˆ²çµæŸ</li>
          <li>æ¯å€‹ç­‰ç´šæ•µäººæ•¸é‡å’Œé€Ÿåº¦å¢åŠ </li>
          <li>é€£çºŒæ“Šä¸­å¯ç²å¾—é€£æ“ŠåŠ æˆ</li>
          <li>ç‰¹æ®Šæ•µäººæœƒæ‰è½èƒ½é‡è£œçµ¦</li>
        </ul>
        <br />
        <p><strong>æº–å‚™å¥½æ‹¯æ•‘åœ°çƒäº†å—ï¼ŸğŸŒ</strong></p>
      </div>
    </div>

    <script src="gameUtils.js"></script>
    <script>
      class LaserDefenseGame {
        constructor() {
          this.canvas = document.getElementById("gameCanvas");
          this.ctx = this.canvas.getContext("2d");
          this.resizeCanvas();

          this.gameState = "waiting"; // waiting, playing, paused, gameOver
          this.score = 0;
          this.level = 1;
          this.health = 100;
          this.destroyed = 0;
          this.mouseX = 0;
          this.mouseY = 0;

          this.player = {
            x: this.canvas.width / 2,
            y: this.canvas.height - 50,
            size: 30,
          };

          this.lasers = [];
          this.enemies = [];
          this.particles = [];
          this.powerUps = [];

          this.enemySpawnTimer = 0;
          this.enemySpawnDelay = 60; // frames
          this.combo = 0;
          this.comboTimer = 0;

          this.bindEvents();
          this.updateDisplay();

          // éŠæˆ²å¾ªç’°
          this.gameLoop = this.gameLoop.bind(this);
          this.animationId = null;
        }

        resizeCanvas() {
          const container = this.canvas.parentElement;
          this.canvas.width = container.clientWidth;
          this.canvas.height = container.clientHeight;
        }

        bindEvents() {
          // æ»‘é¼ äº‹ä»¶
          this.canvas.addEventListener("mousemove", (e) => {
            const rect = this.canvas.getBoundingClientRect();
            this.mouseX = e.clientX - rect.left;
            this.mouseY = e.clientY - rect.top;
          });

          this.canvas.addEventListener("click", (e) => {
            if (this.gameState === "playing") {
              this.shootLaser();
            }
          });

          // éµç›¤äº‹ä»¶
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              this.pauseGame();
            }
          });

          // è¦–çª—å¤§å°èª¿æ•´
          window.addEventListener("resize", () => {
            this.resizeCanvas();
          });

          // èªªæ˜æ¨¡æ…‹æ¡†
          const modal = document.getElementById("instructionModal");
          const closeBtn = modal.querySelector(".close");

          closeBtn.onclick = () => (modal.style.display = "none");
          window.onclick = (e) => {
            if (e.target === modal) modal.style.display = "none";
          };
        }

        startGame() {
          if (this.gameState === "waiting" || this.gameState === "gameOver") {
            this.resetGame();
          }

          this.gameState = "playing";
          document.getElementById("gameOverlay").style.display = "none";

          if (!this.animationId) {
            this.gameLoop();
          }
        }

        pauseGame() {
          if (this.gameState === "playing") {
            this.gameState = "paused";
            document.getElementById("gameOverlay").textContent = "éŠæˆ²æš«åœ";
            document.getElementById("gameOverlay").style.display = "block";
          } else if (this.gameState === "paused") {
            this.gameState = "playing";
            document.getElementById("gameOverlay").style.display = "none";
          }
        }

        resetGame() {
          this.score = 0;
          this.level = 1;
          this.health = 100;
          this.destroyed = 0;
          this.combo = 0;
          this.comboTimer = 0;
          this.lasers = [];
          this.enemies = [];
          this.particles = [];
          this.powerUps = [];
          this.enemySpawnTimer = 0;
          this.enemySpawnDelay = 60;

          this.player.x = this.canvas.width / 2;
          this.player.y = this.canvas.height - 50;

          this.updateDisplay();
        }

        gameLoop() {
          if (this.gameState === "playing") {
            this.update();
            this.draw();
          }

          this.animationId = requestAnimationFrame(this.gameLoop);
        }

        update() {
          // æ›´æ–°ç©å®¶ä½ç½®ï¼ˆè·Ÿéš¨æ»‘é¼ ï¼‰
          this.player.x = this.mouseX;

          // ç”Ÿæˆæ•µäºº
          this.spawnEnemies();

          // æ›´æ–°é›·å°„
          this.updateLasers();

          // æ›´æ–°æ•µäºº
          this.updateEnemies();

          // æ›´æ–°ç²’å­æ•ˆæœ
          this.updateParticles();

          // æ›´æ–°èƒ½é‡åŒ…
          this.updatePowerUps();

          // ç¢°æ’æª¢æ¸¬
          this.checkCollisions();

          // æ›´æ–°é€£æ“Šè¨ˆæ™‚å™¨
          if (this.comboTimer > 0) {
            this.comboTimer--;
            if (this.comboTimer <= 0) {
              this.combo = 0;
            }
          }

          // æª¢æŸ¥éŠæˆ²çµæŸ
          if (this.health <= 0) {
            this.gameOver();
          }

          // æª¢æŸ¥å‡ç´š
          this.checkLevelUp();
        }

        spawnEnemies() {
          this.enemySpawnTimer++;
          if (this.enemySpawnTimer >= this.enemySpawnDelay) {
            this.enemySpawnTimer = 0;

            // éš¨æ©Ÿæ•µäººé¡å‹
            const types = ["small", "medium", "large"];
            const weights = [60, 30, 10];
            let randomValue = Math.random() * 100;
            let enemyType = "small";

            for (let i = 0; i < types.length; i++) {
              if (randomValue <= weights[i]) {
                enemyType = types[i];
                break;
              }
              randomValue -= weights[i];
            }

            // å‰µå»ºæ•µäºº
            const enemy = this.createEnemy(enemyType);
            this.enemies.push(enemy);

            // èª¿æ•´ç”Ÿæˆé »ç‡
            this.enemySpawnDelay = Math.max(20, 60 - this.level * 3);
          }
        }

        createEnemy(type) {
          const enemy = {
            x: Math.random() * (this.canvas.width - 40) + 20,
            y: -30,
            type: type,
            speed: 1 + this.level * 0.2,
            angle: 0,
          };

          switch (type) {
            case "small":
              enemy.size = 20;
              enemy.health = 1;
              enemy.maxHealth = 1;
              enemy.points = 10;
              enemy.color = "#ff4444";
              enemy.speed *= 1.5;
              break;
            case "medium":
              enemy.size = 35;
              enemy.health = 2;
              enemy.maxHealth = 2;
              enemy.points = 25;
              enemy.color = "#ffaa44";
              enemy.speed *= 1.0;
              break;
            case "large":
              enemy.size = 50;
              enemy.health = 3;
              enemy.maxHealth = 3;
              enemy.points = 50;
              enemy.color = "#ff8844";
              enemy.speed *= 0.7;
              break;
          }

          return enemy;
        }

        shootLaser() {
          const laser = {
            x: this.player.x,
            y: this.player.y - 20,
            targetX: this.mouseX,
            targetY: this.mouseY,
            speed: 10,
            size: 3,
          };

          // è¨ˆç®—æ–¹å‘
          const dx = laser.targetX - laser.x;
          const dy = laser.targetY - laser.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          laser.vx = (dx / distance) * laser.speed;
          laser.vy = (dy / distance) * laser.speed;

          this.lasers.push(laser);

          // å‰µå»ºç™¼å°„ç²’å­æ•ˆæœ
          this.createParticles(this.player.x, this.player.y - 20, "#00ffff", 5);
        }

        updateLasers() {
          for (let i = this.lasers.length - 1; i >= 0; i--) {
            const laser = this.lasers[i];

            laser.x += laser.vx;
            laser.y += laser.vy;

            // ç§»é™¤è¶…å‡ºé‚Šç•Œçš„é›·å°„
            if (
              laser.x < 0 ||
              laser.x > this.canvas.width ||
              laser.y < 0 ||
              laser.y > this.canvas.height
            ) {
              this.lasers.splice(i, 1);
            }
          }
        }

        updateEnemies() {
          for (let i = this.enemies.length - 1; i >= 0; i--) {
            const enemy = this.enemies[i];

            enemy.y += enemy.speed;
            enemy.angle += 0.02;

            // ç§»é™¤åˆ°é”åº•éƒ¨çš„æ•µäººä¸¦æ‰£è¡€
            if (enemy.y > this.canvas.height + enemy.size) {
              this.enemies.splice(i, 1);
              this.health -= 10;
              this.updateDisplay();
            }
          }
        }

        updateParticles() {
          for (let i = this.particles.length - 1; i >= 0; i--) {
            const particle = this.particles[i];

            particle.x += particle.vx;
            particle.y += particle.vy;
            particle.life -= particle.decay;
            particle.size *= 0.98;

            if (particle.life <= 0 || particle.size < 0.5) {
              this.particles.splice(i, 1);
            }
          }
        }

        updatePowerUps() {
          for (let i = this.powerUps.length - 1; i >= 0; i--) {
            const powerUp = this.powerUps[i];

            powerUp.y += powerUp.speed;
            powerUp.angle += 0.05;

            // ç§»é™¤è¶…å‡ºé‚Šç•Œçš„èƒ½é‡åŒ…
            if (powerUp.y > this.canvas.height + powerUp.size) {
              this.powerUps.splice(i, 1);
            }
          }
        }

        checkCollisions() {
          // é›·å°„ vs æ•µäºº
          for (let i = this.lasers.length - 1; i >= 0; i--) {
            const laser = this.lasers[i];

            for (let j = this.enemies.length - 1; j >= 0; j--) {
              const enemy = this.enemies[j];

              const distance = Math.sqrt(
                (laser.x - enemy.x) ** 2 + (laser.y - enemy.y) ** 2
              );

              if (distance < enemy.size / 2 + laser.size) {
                // ç§»é™¤é›·å°„
                this.lasers.splice(i, 1);

                // å‚·å®³æ•µäºº
                enemy.health--;

                if (enemy.health <= 0) {
                  // æ‘§æ¯€æ•µäºº
                  this.destroyEnemy(enemy, j);
                } else {
                  // å‰µå»ºå‘½ä¸­æ•ˆæœ
                  this.createParticles(enemy.x, enemy.y, "#ffff00", 3);
                }

                break;
              }
            }
          }
        }

        destroyEnemy(enemy, index) {
          // è¨ˆåˆ†
          let points = enemy.points;
          if (this.combo > 0) {
            points *= 1 + this.combo * 0.1;
          }
          this.score += Math.floor(points);
          this.destroyed++;
          this.combo++;
          this.comboTimer = 120; // 2ç§’

          // å‰µå»ºçˆ†ç‚¸æ•ˆæœ
          this.createParticles(enemy.x, enemy.y, enemy.color, 15);

          // éš¨æ©Ÿæ‰è½èƒ½é‡åŒ…
          if (Math.random() < 0.2) {
            this.powerUps.push({
              x: enemy.x,
              y: enemy.y,
              size: 15,
              speed: 2,
              angle: 0,
              type: "health",
            });
          }

          // ç§»é™¤æ•µäºº
          this.enemies.splice(index, 1);

          this.updateDisplay();
        }

        createParticles(x, y, color, count) {
          for (let i = 0; i < count; i++) {
            this.particles.push({
              x: x + (Math.random() - 0.5) * 20,
              y: y + (Math.random() - 0.5) * 20,
              vx: (Math.random() - 0.5) * 8,
              vy: (Math.random() - 0.5) * 8,
              size: Math.random() * 4 + 2,
              color: color,
              life: 1,
              decay: 0.02,
            });
          }
        }

        checkLevelUp() {
          const newLevel = Math.floor(this.destroyed / 10) + 1;
          if (newLevel > this.level) {
            this.level = newLevel;
            this.health = Math.min(100, this.health + 20); // å‡ç´šçå‹µ
            this.updateDisplay();
          }
        }

        gameOver() {
          this.gameState = "gameOver";
          document.getElementById(
            "gameOverlay"
          ).textContent = `éŠæˆ²çµæŸï¼\nå¾—åˆ†: ${this.score}\né»æ“Šé‡æ–°é–‹å§‹`;
          document.getElementById("gameOverlay").style.display = "block";

          // ä¿å­˜æœ€é«˜åˆ†
          if (typeof saveGameData === "function") {
            saveGameData("laser-defense", { score: this.score });
          }
        }

        draw() {
          // æ¸…ç©ºç•«å¸ƒ
          this.ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          // ç¹ªè£½ç©å®¶
          this.drawPlayer();

          // ç¹ªè£½é›·å°„
          this.drawLasers();

          // ç¹ªè£½æ•µäºº
          this.drawEnemies();

          // ç¹ªè£½ç²’å­æ•ˆæœ
          this.drawParticles();

          // ç¹ªè£½èƒ½é‡åŒ…
          this.drawPowerUps();

          // ç¹ªè£½ç„æº–ç·š
          this.drawCrosshair();

          // ç¹ªè£½é€£æ“Šé¡¯ç¤º
          if (this.combo > 1) {
            this.drawCombo();
          }
        }

        drawPlayer() {
          this.ctx.save();
          this.ctx.translate(this.player.x, this.player.y);

          // é£›èˆ¹æœ¬é«”
          this.ctx.fillStyle = "#00ffff";
          this.ctx.beginPath();
          this.ctx.moveTo(0, -15);
          this.ctx.lineTo(-15, 15);
          this.ctx.lineTo(0, 10);
          this.ctx.lineTo(15, 15);
          this.ctx.closePath();
          this.ctx.fill();

          // ç™¼å…‰æ•ˆæœ
          this.ctx.shadowColor = "#00ffff";
          this.ctx.shadowBlur = 20;
          this.ctx.stroke();

          this.ctx.restore();
        }

        drawLasers() {
          this.ctx.save();
          this.ctx.shadowColor = "#00ffff";
          this.ctx.shadowBlur = 10;

          for (const laser of this.lasers) {
            this.ctx.fillStyle = "#00ffff";
            this.ctx.fillRect(
              laser.x - laser.size / 2,
              laser.y - laser.size / 2,
              laser.size * 2,
              laser.size * 8
            );
          }

          this.ctx.restore();
        }

        drawEnemies() {
          for (const enemy of this.enemies) {
            this.ctx.save();
            this.ctx.translate(enemy.x, enemy.y);
            this.ctx.rotate(enemy.angle);

            // æ•µäººé£›èˆ¹
            this.ctx.fillStyle = enemy.color;
            this.ctx.fillRect(
              -enemy.size / 2,
              -enemy.size / 2,
              enemy.size,
              enemy.size
            );

            // è¡€é‡æ¢
            if (enemy.health < enemy.maxHealth) {
              this.ctx.restore();
              this.ctx.fillStyle = "rgba(255, 0, 0, 0.8)";
              this.ctx.fillRect(
                enemy.x - enemy.size / 2,
                enemy.y - enemy.size / 2 - 10,
                enemy.size,
                3
              );
              this.ctx.fillStyle = "rgba(0, 255, 0, 0.8)";
              this.ctx.fillRect(
                enemy.x - enemy.size / 2,
                enemy.y - enemy.size / 2 - 10,
                enemy.size * (enemy.health / enemy.maxHealth),
                3
              );
            } else {
              this.ctx.restore();
            }
          }
        }

        drawParticles() {
          for (const particle of this.particles) {
            this.ctx.save();
            this.ctx.globalAlpha = particle.life;
            this.ctx.fillStyle = particle.color;
            this.ctx.fillRect(
              particle.x - particle.size / 2,
              particle.y - particle.size / 2,
              particle.size,
              particle.size
            );
            this.ctx.restore();
          }
        }

        drawPowerUps() {
          for (const powerUp of this.powerUps) {
            this.ctx.save();
            this.ctx.translate(powerUp.x, powerUp.y);
            this.ctx.rotate(powerUp.angle);

            this.ctx.fillStyle = "#00ff00";
            this.ctx.shadowColor = "#00ff00";
            this.ctx.shadowBlur = 15;
            this.ctx.fillRect(
              -powerUp.size / 2,
              -powerUp.size / 2,
              powerUp.size,
              powerUp.size
            );

            this.ctx.restore();
          }
        }

        drawCrosshair() {
          this.ctx.save();
          this.ctx.strokeStyle = "#00ffff";
          this.ctx.lineWidth = 2;
          this.ctx.shadowColor = "#00ffff";
          this.ctx.shadowBlur = 10;

          // åå­—æº–å¿ƒ
          this.ctx.beginPath();
          this.ctx.moveTo(this.mouseX - 10, this.mouseY);
          this.ctx.lineTo(this.mouseX + 10, this.mouseY);
          this.ctx.moveTo(this.mouseX, this.mouseY - 10);
          this.ctx.lineTo(this.mouseX, this.mouseY + 10);
          this.ctx.stroke();

          // åœ“åœˆ
          this.ctx.beginPath();
          this.ctx.arc(this.mouseX, this.mouseY, 15, 0, Math.PI * 2);
          this.ctx.stroke();

          this.ctx.restore();
        }

        drawCombo() {
          this.ctx.save();
          this.ctx.fillStyle = "#ffff00";
          this.ctx.font = "bold 24px Arial";
          this.ctx.textAlign = "center";
          this.ctx.shadowColor = "#ffff00";
          this.ctx.shadowBlur = 15;
          this.ctx.fillText(`${this.combo}x COMBO!`, this.canvas.width / 2, 50);
          this.ctx.restore();
        }

        updateDisplay() {
          document.getElementById("score").textContent = this.score;
          document.getElementById("level").textContent = this.level;
          document.getElementById("destroyed").textContent = this.destroyed;

          const healthFill = document.getElementById("healthFill");
          healthFill.style.width = Math.max(0, this.health) + "%";

          if (this.health > 60) {
            healthFill.style.background =
              "linear-gradient(90deg, #00ff00, #ffff00)";
          } else if (this.health > 30) {
            healthFill.style.background =
              "linear-gradient(90deg, #ffff00, #ff8000)";
          } else {
            healthFill.style.background =
              "linear-gradient(90deg, #ff0000, #ff0000)";
          }
        }
      }

      // åˆå§‹åŒ–éŠæˆ²
      let game;

      function initGame() {
        game = new LaserDefenseGame();
      }

      function startGame() {
        if (game) {
          game.startGame();
        }
      }

      function pauseGame() {
        if (game) {
          game.pauseGame();
        }
      }

      function showInstructions() {
        document.getElementById("instructionModal").style.display = "block";
      }

      // ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–éŠæˆ²
      window.addEventListener("load", initGame);

      // éŠæˆ²å·¥å…·å‡½æ•¸
      if (typeof initializeGameUtils === "function") {
        initializeGameUtils("laser-defense");
      }
    </script>
  </body>
</html>
