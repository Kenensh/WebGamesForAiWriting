<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¨˜æ†¶ç¿»ç‰Œ - ç¶²é å°éŠæˆ²</title>
    <meta name="game-id" content="memory-card" />
    <meta name="game-name" content="è¨˜æ†¶ç¿»ç‰Œ" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .memory-game-container {
        max-width: 800px;
        margin: 0 auto;
      }

      .memory-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }

      .stat-box {
        background-color: #f5f5f5;
        padding: 10px 20px;
        border-radius: 5px;
        text-align: center;
        width: 150px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .stat-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }

      .memory-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-gap: 15px;
        margin-bottom: 30px;
      }

      @media (min-width: 768px) {
        .memory-board {
          grid-template-columns: repeat(5, 1fr);
        }
      }

      .memory-card {
        position: relative;
        height: 0;
        padding-bottom: 100%;
        perspective: 1000px;
        cursor: pointer;
      }

      .card-inner {
        position: absolute;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 0.5s;
      }

      .card-flipped .card-inner {
        transform: rotateY(180deg);
      }

      .card-front,
      .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .card-front {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        font-size: 24px;
        font-weight: bold;
        color: white;
      }

      .card-back {
        background-color: white;
        transform: rotateY(180deg);
        font-size: 36px;
      }

      .matched .card-front {
        background: linear-gradient(135deg, #1cb568 0%, #1bbd9d 100%);
        opacity: 0.8;
      }

      .difficulty-selector {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      .difficulty-btn {
        background-color: #f5f5f5;
        border: 2px solid transparent;
        border-radius: 5px;
        padding: 8px 15px;
        margin: 0 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .difficulty-btn:hover {
        background-color: #e0e0e0;
      }

      .difficulty-btn.active {
        border-color: #2575fc;
        background-color: #e6f0ff;
        font-weight: bold;
      }

      /* å‹•ç•«æ•ˆæœ */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 0.3s;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-10px);
        }
        40% {
          transform: translateX(10px);
        }
        60% {
          transform: translateX(-10px);
        }
        80% {
          transform: translateX(10px);
        }
        100% {
          transform: translateX(0);
        }
      }

      .shake {
        animation: shake 0.5s;
      }

      .card-emoji {
        font-size: 40px;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a href="index.html" class="site-title">ç¶²é å°éŠæˆ²</a>
        <nav class="site-nav">
          <ul>
            <li><a href="index.html">è¿”å›é¦–é </a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container game-container">
      <h1>è¨˜æ†¶ç¿»ç‰Œ</h1>
      <div class="score-display">åˆ†æ•¸: <span id="scoreValue">0</span></div>

      <div class="memory-game-container">
        <div class="memory-stats">
          <div class="stat-box">
            <div class="stat-label">ç¿»ç‰Œæ¬¡æ•¸</div>
            <div id="flipCount" class="stat-value">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">é…å°æ•¸</div>
            <div id="matchCount" class="stat-value">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">å‰©é¤˜æ™‚é–“</div>
            <div id="timeRemaining" class="stat-value">60</div>
          </div>
        </div>

        <div class="difficulty-selector">
          <div id="easyBtn" class="difficulty-btn active">ç°¡å–® (8å°)</div>
          <div id="mediumBtn" class="difficulty-btn">ä¸­ç­‰ (10å°)</div>
          <div id="hardBtn" class="difficulty-btn">å›°é›£ (12å°)</div>
        </div>

        <div id="memoryBoard" class="memory-board">
          <!-- å¡ç‰Œå°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div class="game-controls">
          <button id="pauseButton" class="primary-button">æš«åœ</button>
          <button id="restartButton" class="primary-button">é‡æ–°é–‹å§‹</button>
          <button id="helpButton" class="secondary-button">éŠæˆ²èªªæ˜</button>
          <button id="homeButton" class="secondary-button">è¿”å›é¦–é </button>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; 2025 ç¶²é å°éŠæˆ²åˆé›† | ä½¿ç”¨ç´” JavaScript é–‹ç™¼</p>
      </div>
    </footer>

    <script src="gameUtils.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ç²å– DOM å…ƒç´ 
        const memoryBoard = document.getElementById("memoryBoard");
        const flipCountElement = document.getElementById("flipCount");
        const matchCountElement = document.getElementById("matchCount");
        const timeRemainingElement = document.getElementById("timeRemaining");
        const easyBtn = document.getElementById("easyBtn");
        const mediumBtn = document.getElementById("mediumBtn");
        const hardBtn = document.getElementById("hardBtn");

        // å‰µå»ºéŠæˆ²æ§åˆ¶å™¨
        const gameController = new GameUtils.GameController();

        // å‰µå»ºåˆ†æ•¸ç®¡ç†å™¨
        const scoreManager = new GameUtils.ScoreManager("scoreValue");

        // å‰µå»ºèªªæ˜æ¨¡æ…‹æ¡†
        const helpModal = new GameUtils.Modal(
          "helpModal",
          "è¨˜æ†¶ç¿»ç‰Œ - éŠæˆ²èªªæ˜",
          `
            <h3>éŠæˆ²è¦å‰‡ï¼š</h3>
            <p>é»æ“Šå¡ç‰‡ç¿»é–‹ï¼Œå˜—è©¦é…å°ç›¸åŒçš„åœ–æ¡ˆã€‚æ¯æ¬¡åªèƒ½ç¿»é–‹å…©å¼µå¡ç‰‡ã€‚</p>
            <p>å¦‚æœå…©å¼µå¡ç‰‡åœ–æ¡ˆç›¸åŒï¼Œå‰‡ä¿æŒç¿»é–‹ç‹€æ…‹ï¼›å¦‚æœä¸åŒï¼Œå‰‡æœƒç¿»å›ã€‚</p>
            <p>ç•¶æ‰€æœ‰å¡ç‰‡éƒ½é…å°æˆåŠŸæ™‚ï¼ŒéŠæˆ²çµæŸã€‚</p>
            <p>éŠæˆ²æœ‰æ™‚é–“é™åˆ¶ï¼Œè«‹åœ¨æ™‚é–“è€—ç›¡å‰æ‰¾å‡ºæ‰€æœ‰é…å°ï¼</p>
            
            <h3>é›£åº¦ç­‰ç´šï¼š</h3>
            <ul>
              <li>ç°¡å–®: 8 å°å¡ç‰‡ (16 å¼µ)</li>
              <li>ä¸­ç­‰: 10 å°å¡ç‰‡ (20 å¼µ)</li>
              <li>å›°é›£: 12 å°å¡ç‰‡ (24 å¼µ)</li>
            </ul>
            
            <h3>è¨ˆåˆ†æ–¹å¼ï¼š</h3>
            <ul>
              <li>æ¯æˆåŠŸé…å°ä¸€æ¬¡: +10 åˆ†</li>
              <li>å‰©é¤˜æ™‚é–“çå‹µ: æ¯ç§’ +1 åˆ†</li>
              <li>ç¿»ç‰Œæ¬¡æ•¸å°‘: ç¿»ç‰Œæ•ˆç‡çå‹µ</li>
            </ul>
          `
        );

        // è¡¨æƒ…ç¬¦è™Ÿåˆ—è¡¨ (ç”¨æ–¼å¡ç‰‡åœ–æ¡ˆ)
        const emojis = [
          "ğŸ¶",
          "ğŸ±",
          "ğŸ­",
          "ğŸ¹",
          "ğŸ°",
          "ğŸ¦Š",
          "ğŸ»",
          "ğŸ¼",
          "ğŸ¨",
          "ğŸ¯",
          "ğŸ¦",
          "ğŸ®",
          "ğŸ·",
          "ğŸ¸",
          "ğŸµ",
          "ğŸ”",
          "ğŸ¦„",
          "ğŸ™",
          "ğŸ¢",
          "ğŸ¦‹",
          "ğŸ ",
          "ğŸ¦€",
          "ğŸ",
          "ğŸ¦–",
        ];

        // éŠæˆ²è®Šæ•¸
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalPairs = 8; // é»˜èªç°¡å–®æ¨¡å¼
        let flipCount = 0;
        let timeRemaining = 60;
        let timerId;
        let canFlip = true;
        let difficulty = "easy";

        // é›£åº¦è¨­å®š
        const difficultySettings = {
          easy: { pairs: 8, time: 60, columns: 4 },
          medium: { pairs: 10, time: 90, columns: 5 },
          hard: { pairs: 12, time: 120, columns: 6 },
        };

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
          // é‡ç½®éŠæˆ²ç‹€æ…‹
          cards = [];
          flippedCards = [];
          matchedPairs = 0;
          flipCount = 0;
          scoreManager.reset();

          // æ‡‰ç”¨é›£åº¦è¨­å®š
          const settings = difficultySettings[difficulty];
          totalPairs = settings.pairs;
          timeRemaining = settings.time;
          memoryBoard.style.gridTemplateColumns = `repeat(${settings.columns}, 1fr)`;

          // æ›´æ–°é¡¯ç¤º
          flipCountElement.textContent = flipCount;
          matchCountElement.textContent = matchedPairs;
          timeRemainingElement.textContent = timeRemaining;

          // æ¸…ç©ºæ£‹ç›¤
          memoryBoard.innerHTML = "";

          // å‰µå»ºå¡ç‰‡
          createCards();

          // é‡ç½®è¨ˆæ™‚å™¨
          if (timerId) {
            clearInterval(timerId);
          }

          // å•Ÿç”¨ç¿»ç‰Œ
          canFlip = true;

          // è¨­ç½®éŠæˆ²å¾ªç’° (ä¸»è¦ç”¨æ–¼æª¢æŸ¥éŠæˆ²ç‹€æ…‹)
          gameController.setGameLoop(() => {
            // åœ¨è¨˜æ†¶ç¿»ç‰ŒéŠæˆ²ä¸­ï¼Œä¸»è¦æ˜¯åŸºæ–¼äº‹ä»¶æ“ä½œï¼Œæ‰€ä»¥å¾ªç’°ä¸­ä¸éœ€è¦åšå¤ªå¤š
          });

          // é–‹å§‹è¨ˆæ™‚å™¨
          startTimer();

          // é–‹å§‹éŠæˆ²å¾ªç’°
          gameController.startGameLoop();
        }

        // å‰µå»ºå¡ç‰‡
        function createCards() {
          // å‰µå»ºé…å°æ•¸çµ„
          let cardEmojis = [];
          for (let i = 0; i < totalPairs; i++) {
            cardEmojis.push(emojis[i]);
            cardEmojis.push(emojis[i]);
          }

          // æ´—ç‰Œç®—æ³•
          for (let i = cardEmojis.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cardEmojis[i], cardEmojis[j]] = [cardEmojis[j], cardEmojis[i]];
          }

          // å‰µå»ºå¡ç‰‡å…ƒç´ 
          cardEmojis.forEach((emoji, index) => {
            const card = document.createElement("div");
            card.className = "memory-card";
            card.dataset.emoji = emoji;
            card.dataset.index = index;

            const cardInner = document.createElement("div");
            cardInner.className = "card-inner";

            const cardFront = document.createElement("div");
            cardFront.className = "card-front";
            cardFront.textContent = "?";

            const cardBack = document.createElement("div");
            cardBack.className = "card-back";
            const emojiSpan = document.createElement("span");
            emojiSpan.className = "card-emoji";
            emojiSpan.textContent = emoji;
            cardBack.appendChild(emojiSpan);

            cardInner.appendChild(cardFront);
            cardInner.appendChild(cardBack);
            card.appendChild(cardInner);

            card.addEventListener("click", flipCard);
            memoryBoard.appendChild(card);
            cards.push(card);
          });
        }

        // ç¿»ç‰Œå‡½æ•¸
        function flipCard() {
          // å¦‚æœå·²ç¶“ç¿»é–‹ã€å·²åŒ¹é…æˆ–ç•¶å‰ä¸èƒ½ç¿»ç‰Œï¼Œå‰‡è¿”å›
          if (
            this.classList.contains("card-flipped") ||
            this.classList.contains("matched") ||
            flippedCards.length >= 2 ||
            !canFlip ||
            gameController.paused
          ) {
            return;
          }

          // æ’­æ”¾ç¿»ç‰Œå‹•ç•«
          this.classList.add("card-flipped");
          flippedCards.push(this);

          // å¢åŠ ç¿»ç‰Œè¨ˆæ•¸
          flipCount++;
          flipCountElement.textContent = flipCount;

          // å¦‚æœç¿»é–‹å…©å¼µå¡ç‰‡ï¼Œæª¢æŸ¥æ˜¯å¦åŒ¹é…
          if (flippedCards.length === 2) {
            checkForMatch();
          }
        }

        // æª¢æŸ¥æ˜¯å¦é…å°
        function checkForMatch() {
          const card1 = flippedCards[0];
          const card2 = flippedCards[1];

          // æš«æ™‚ç¦ç”¨ç¿»ç‰Œ
          canFlip = false;

          if (card1.dataset.emoji === card2.dataset.emoji) {
            // é…å°æˆåŠŸ
            setTimeout(() => {
              card1.classList.add("matched");
              card2.classList.add("matched");
              card1.classList.add("pulse");
              card2.classList.add("pulse");

              // å¢åŠ åŒ¹é…è¨ˆæ•¸å’Œåˆ†æ•¸
              matchedPairs++;
              matchCountElement.textContent = matchedPairs;
              scoreManager.add(10);

              // é‡ç½®ç¿»ç‰Œæ•¸çµ„
              flippedCards = [];

              // æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
              checkGameCompletion();

              // é‡æ–°å•Ÿç”¨ç¿»ç‰Œ
              canFlip = true;

              // ç§»é™¤å‹•ç•«é¡
              setTimeout(() => {
                card1.classList.remove("pulse");
                card2.classList.remove("pulse");
              }, 300);
            }, 500);
          } else {
            // é…å°å¤±æ•—
            setTimeout(() => {
              card1.classList.add("shake");
              card2.classList.add("shake");

              // ç¿»å›å¡ç‰‡
              setTimeout(() => {
                card1.classList.remove("card-flipped", "shake");
                card2.classList.remove("card-flipped", "shake");
                flippedCards = [];

                // é‡æ–°å•Ÿç”¨ç¿»ç‰Œ
                canFlip = true;
              }, 500);
            }, 600);
          }
        }

        // æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
        function checkGameCompletion() {
          if (matchedPairs === totalPairs) {
            // åœæ­¢è¨ˆæ™‚å™¨
            clearInterval(timerId);

            // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
            calculateFinalScore();
          }
        }

        // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
        function calculateFinalScore() {
          // åŸºæœ¬åˆ†æ•¸ = åŒ¹é…å°æ•¸ * 10
          let finalScore = matchedPairs * 10;

          // æ™‚é–“çå‹µ
          const timeBonus = timeRemaining;
          finalScore += timeBonus;

          // ç¿»ç‰Œæ•ˆç‡çå‹µ (æœ€å°‘ç¿»ç‰Œæ¬¡æ•¸æ˜¯ totalPairs * 2)
          const perfectFlips = totalPairs * 2;
          const efficiency = Math.max(0, perfectFlips * 3 - flipCount);
          const efficiencyBonus = Math.floor(efficiency * 0.5);
          finalScore += efficiencyBonus;

          // æ›´æ–°åˆ†æ•¸
          scoreManager.add(timeBonus + efficiencyBonus);

          // é¡¯ç¤ºçµæœ
          let message = `
            <p>ä½ æˆåŠŸåŒ¹é…äº†æ‰€æœ‰å¡ç‰‡ï¼</p>
            <p>ç¿»ç‰Œæ¬¡æ•¸: ${flipCount}</p>
            <p>å‰©é¤˜æ™‚é–“: ${timeRemaining} ç§’</p>
            <p>åŸºæœ¬åˆ†æ•¸: ${matchedPairs * 10}</p>
            <p>æ™‚é–“çå‹µ: +${timeBonus}</p>
            <p>æ•ˆç‡çå‹µ: +${efficiencyBonus}</p>
            <p>æœ€çµ‚åˆ†æ•¸: <span style="font-size: 24px; font-weight: bold;">${finalScore}</span></p>
          `;

          // é¡¯ç¤ºéŠæˆ²çµæŸè¨Šæ¯
          gameController.endGame(finalScore, "æ­å–œå®Œæˆï¼");
        }

        // é–‹å§‹è¨ˆæ™‚å™¨
        function startTimer() {
          if (timerId) {
            clearInterval(timerId);
          }

          timerId = setInterval(() => {
            if (gameController.paused) return;

            timeRemaining--;
            timeRemainingElement.textContent = timeRemaining;

            if (timeRemaining <= 0) {
              clearInterval(timerId);
              canFlip = false;
              gameController.endGame(
                scoreManager.getCurrentScore(),
                "æ™‚é–“åˆ°ï¼"
              );
            } else if (timeRemaining <= 10) {
              // æ™‚é–“å¿«åˆ°æ™‚çš„è¦–è¦ºæé†’
              timeRemainingElement.style.color = "red";
            }
          }, 1000);
        }

        // è¨­ç½®é›£åº¦æŒ‰éˆ•é»æ“Šäº‹ä»¶
        easyBtn.addEventListener("click", () => setDifficulty("easy"));
        mediumBtn.addEventListener("click", () => setDifficulty("medium"));
        hardBtn.addEventListener("click", () => setDifficulty("hard"));

        // è¨­ç½®é›£åº¦
        function setDifficulty(level) {
          difficulty = level;

          // æ›´æ–°æŒ‰éˆ•æ¨£å¼
          easyBtn.classList.toggle("active", level === "easy");
          mediumBtn.classList.toggle("active", level === "medium");
          hardBtn.classList.toggle("active", level === "hard");

          // é‡æ–°é–‹å§‹éŠæˆ²
          initGame();
        }

        // è¨­ç½®é‡å•Ÿè™•ç†å™¨
        gameController.setRestartHandler(() => {
          initGame();
        });

        // æš«åœæ™‚è™•ç†
        const originalTogglePause = gameController.togglePause;
        gameController.togglePause = function () {
          const paused = originalTogglePause.call(gameController);
          return paused;
        };

        // é¡¯ç¤ºé–‹å§‹å‹•ç•«ç„¶å¾Œåˆå§‹åŒ–éŠæˆ²
        gameController.showStartAnimation(() => {
          initGame();
        });
      });
    </script>
  </body>
</html>
