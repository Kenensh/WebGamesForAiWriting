<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ³¡æ³¡çˆ†ç ´ - ç¶²é å°éŠæˆ²</title>
    <link rel="stylesheet" href="game-styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      #gameCanvas {
        border: 3px solid #2c3e50;
        border-radius: 10px;
        background: linear-gradient(to bottom, #87ceeb, #e6f3ff);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        cursor: crosshair;
      }

      .bubble {
        border-radius: 50%;
        position: absolute;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: inset -10px -10px 0px rgba(255, 255, 255, 0.2);
        animation: float 0.1s ease-in-out infinite alternate;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        100% {
          transform: translateY(-2px);
        }
      }

      .pop-effect {
        position: absolute;
        pointer-events: none;
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 0px #000;
        animation: popAnimation 0.6s ease-out forwards;
      }

      @keyframes popAnimation {
        0% {
          opacity: 1;
          transform: scale(0.5);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          opacity: 0;
          transform: scale(1) translateY(-50px);
        }
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        pointer-events: none;
        animation: particle 0.8s ease-out forwards;
      }

      @keyframes particle {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0;
          transform: scale(0.5) translateY(-100px);
        }
      }

      .game-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        background: linear-gradient(45deg, #3498db, #2980b9);
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: bold;
      }

      .info-item {
        text-align: center;
      }

      .info-value {
        font-size: 24px;
        display: block;
        margin-top: 5px;
      }

      .combo-display {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 215, 0, 0.9);
        color: #000;
        padding: 10px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 18px;
        display: none;
        animation: pulse 0.5s ease-in-out infinite alternate;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        100% {
          transform: scale(1.1);
        }
      }

      .time-warning {
        animation: timeWarning 0.5s ease-in-out infinite alternate;
      }

      @keyframes timeWarning {
        0% {
          color: #e74c3c;
        }
        100% {
          color: #c0392b;
        }
      }

      .game-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
      }

      .control-button {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .control-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .control-button:active {
        transform: translateY(0);
      }

      .control-button:disabled {
        background: #7f8c8d;
        cursor: not-allowed;
        transform: none;
      }

      .difficulty-selector {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      .difficulty-button {
        background: #34495e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .difficulty-button.active {
        background: #2ecc71;
      }

      .difficulty-button:hover {
        background: #4a6078;
      }

      .difficulty-button.active:hover {
        background: #27ae60;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <header class="game-header">
        <h1 class="game-title">
          <i class="fas fa-soap"></i>
          æ³¡æ³¡çˆ†ç ´
        </h1>
        <button class="back-button" onclick="window.location.href='index.html'">
          <i class="fas fa-arrow-left"></i>
          è¿”å›é¸å–®
        </button>
      </header>

      <div class="game-info">
        <div class="info-item">
          <span>åˆ†æ•¸</span>
          <span class="info-value" id="score">0</span>
        </div>
        <div class="info-item">
          <span>æ™‚é–“</span>
          <span class="info-value" id="timer">60</span>
        </div>
        <div class="info-item">
          <span>æ³¡æ³¡</span>
          <span class="info-value" id="bubblesPopped">0</span>
        </div>
        <div class="info-item">
          <span>æº–ç¢ºç‡</span>
          <span class="info-value" id="accuracy">100%</span>
        </div>
      </div>

      <div class="difficulty-selector">
        <button class="difficulty-button active" data-difficulty="easy">
          ç°¡å–®
        </button>
        <button class="difficulty-button" data-difficulty="medium">ä¸­ç­‰</button>
        <button class="difficulty-button" data-difficulty="hard">å›°é›£</button>
      </div>

      <div class="game-controls">
        <button class="control-button" id="startButton">é–‹å§‹éŠæˆ²</button>
        <button class="control-button" id="pauseButton" disabled>æš«åœ</button>
        <button class="control-button" id="resetButton">é‡æ–°é–‹å§‹</button>
        <button class="control-button" id="helpButton">éŠæˆ²èªªæ˜</button>
      </div>

      <div class="game-canvas-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="combo-display" id="comboDisplay">
          é€£æ“Š x<span id="comboCount">0</span>
        </div>
      </div>

      <div class="game-stats">
        <div class="stat-item">
          <span class="stat-label">æœ€é«˜åˆ†ï¼š</span>
          <span class="stat-value" id="highScore">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">ç¸½éŠæˆ²æ¬¡æ•¸ï¼š</span>
          <span class="stat-value" id="totalGames">0</span>
        </div>
      </div>
    </div>

    <!-- éŠæˆ²èªªæ˜æ¨¡æ…‹æ¡† -->
    <div id="helpModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ğŸ«§ æ³¡æ³¡çˆ†ç ´ - éŠæˆ²èªªæ˜</h2>
        <div class="help-content">
          <h3>ğŸ¯ éŠæˆ²ç›®æ¨™</h3>
          <p>åœ¨é™å®šæ™‚é–“å…§é»æ“Šçˆ†ç ´æ³¡æ³¡ï¼Œç²å¾—æœ€é«˜åˆ†æ•¸ï¼</p>

          <h3>ğŸ® éŠæˆ²è¦å‰‡</h3>
          <ul>
            <li>é»æ“Šæ³¡æ³¡å°‡å…¶çˆ†ç ´ä¸¦ç²å¾—åˆ†æ•¸</li>
            <li>ä¸åŒé¡è‰²çš„æ³¡æ³¡æœ‰ä¸åŒåˆ†å€¼ï¼š</li>
            <li>ğŸ”µ è—è‰²æ³¡æ³¡ï¼š10åˆ†</li>
            <li>ğŸŸ¢ ç¶ è‰²æ³¡æ³¡ï¼š15åˆ†</li>
            <li>ğŸŸ¡ é»ƒè‰²æ³¡æ³¡ï¼š20åˆ†</li>
            <li>ğŸ”´ ç´…è‰²æ³¡æ³¡ï¼š25åˆ†</li>
            <li>ğŸŸ£ ç´«è‰²æ³¡æ³¡ï¼š30åˆ†ï¼ˆç¨€æœ‰ï¼‰</li>
            <li>é€£çºŒé»æ“Šæ³¡æ³¡å¯ç²å¾—é€£æ“ŠåŠ æˆ</li>
            <li>éŒ¯éé»æ“Šæœƒä¸­æ–·é€£æ“Š</li>
          </ul>

          <h3>âš¡ é›£åº¦ç­‰ç´š</h3>
          <ul>
            <li><strong>ç°¡å–®ï¼š</strong>æ³¡æ³¡ç§»å‹•è¼ƒæ…¢ï¼Œæ•¸é‡è¼ƒå°‘</li>
            <li><strong>ä¸­ç­‰ï¼š</strong>å¹³è¡¡çš„é›£åº¦è¨­å®š</li>
            <li><strong>å›°é›£ï¼š</strong>æ³¡æ³¡ç§»å‹•å¿«é€Ÿï¼Œæ•¸é‡è¼ƒå¤š</li>
          </ul>

          <h3>ğŸ† å¾—åˆ†æŠ€å·§</h3>
          <ul>
            <li>ä¿æŒé€£æ“Šä»¥ç²å¾—åŠ æˆåˆ†æ•¸</li>
            <li>å„ªå…ˆé»æ“Šé«˜åˆ†å€¼çš„æ³¡æ³¡</li>
            <li>æ³¨æ„æ³¡æ³¡çš„ç§»å‹•è»Œè·¡</li>
            <li>åœ¨æ³¡æ³¡æ¶ˆå¤±å‰åŠæ™‚é»æ“Š</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- éŠæˆ²çµæŸæ¨¡æ…‹æ¡† -->
    <div id="gameOverModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ‰ éŠæˆ²çµæŸï¼</h2>
        <div id="gameOverContent">
          <p>æœ€çµ‚åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
          <p>æ³¡æ³¡çˆ†ç ´ï¼š<span id="finalBubbles">0</span></p>
          <p>æº–ç¢ºç‡ï¼š<span id="finalAccuracy">0%</span></p>
          <p>æœ€å¤§é€£æ“Šï¼š<span id="finalCombo">0</span></p>
        </div>
        <div class="modal-buttons">
          <button class="modal-button" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
          <button
            class="modal-button"
            onclick="window.location.href='index.html'"
          >
            è¿”å›é¸å–®
          </button>
        </div>
      </div>
    </div>

    <script src="gameUtils.js"></script>
    <script>
      class BubblePopGame {
        constructor() {
          this.canvas = document.getElementById("gameCanvas");
          this.ctx = this.canvas.getContext("2d");
          this.isRunning = false;
          this.isPaused = false;
          this.score = 0;
          this.timeLeft = 60;
          this.bubbles = [];
          this.bubblesPopped = 0;
          this.totalClicks = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.difficulty = "easy";
          this.bubbleSpawnRate = 1000;
          this.bubbleSpeed = 1;
          this.maxBubbles = 8;

          this.bubbleColors = [
            { color: "#3498db", value: 10, weight: 40 }, // è—è‰²
            { color: "#2ecc71", value: 15, weight: 30 }, // ç¶ è‰²
            { color: "#f1c40f", value: 20, weight: 20 }, // é»ƒè‰²
            { color: "#e74c3c", value: 25, weight: 8 }, // ç´…è‰²
            { color: "#9b59b6", value: 30, weight: 2 }, // ç´«è‰²
          ];

          this.particles = [];
          this.lastBubbleSpawn = 0;
          this.gameTimer = null;
          this.bubbleTimer = null;

          this.setupEventListeners();
          this.loadStats();
          this.setDifficulty("easy");
        }

        setupEventListeners() {
          document
            .getElementById("startButton")
            .addEventListener("click", () => this.startGame());
          document
            .getElementById("pauseButton")
            .addEventListener("click", () => this.togglePause());
          document
            .getElementById("resetButton")
            .addEventListener("click", () => this.resetGame());
          document
            .getElementById("helpButton")
            .addEventListener("click", () => this.showHelp());

          // é›£åº¦é¸æ“‡
          document.querySelectorAll(".difficulty-button").forEach((button) => {
            button.addEventListener("click", (e) =>
              this.setDifficulty(e.target.dataset.difficulty)
            );
          });

          // ç•«å¸ƒé»æ“Šäº‹ä»¶
          this.canvas.addEventListener("click", (e) =>
            this.handleCanvasClick(e)
          );

          // æ¨¡æ…‹æ¡†äº‹ä»¶
          setupModals();
        }

        setDifficulty(difficulty) {
          this.difficulty = difficulty;

          // æ›´æ–°UI
          document
            .querySelectorAll(".difficulty-button")
            .forEach((btn) => btn.classList.remove("active"));
          document
            .querySelector(`[data-difficulty="${difficulty}"]`)
            .classList.add("active");

          // è¨­å®šé›£åº¦åƒæ•¸
          switch (difficulty) {
            case "easy":
              this.bubbleSpawnRate = 1500;
              this.bubbleSpeed = 0.8;
              this.maxBubbles = 6;
              this.timeLeft = 60;
              break;
            case "medium":
              this.bubbleSpawnRate = 1200;
              this.bubbleSpeed = 1.2;
              this.maxBubbles = 8;
              this.timeLeft = 60;
              break;
            case "hard":
              this.bubbleSpawnRate = 800;
              this.bubbleSpeed = 1.6;
              this.maxBubbles = 12;
              this.timeLeft = 45;
              break;
          }

          document.getElementById("timer").textContent = this.timeLeft;
        }

        startGame() {
          if (this.isRunning) return;

          this.isRunning = true;
          this.isPaused = false;
          this.score = 0;
          this.bubblesPopped = 0;
          this.totalClicks = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.bubbles = [];
          this.particles = [];
          this.setDifficulty(this.difficulty);

          this.updateUI();
          this.updateButtons();

          // é–‹å§‹éŠæˆ²å¾ªç’°
          this.gameLoop();

          // é–‹å§‹è¨ˆæ™‚å™¨
          this.gameTimer = setInterval(() => {
            if (!this.isPaused) {
              this.timeLeft--;
              this.updateUI();

              if (this.timeLeft <= 0) {
                this.endGame();
              }
            }
          }, 1000);

          // é–‹å§‹ç”Ÿæˆæ³¡æ³¡
          this.spawnBubbles();
        }

        togglePause() {
          if (!this.isRunning) return;

          this.isPaused = !this.isPaused;
          document.getElementById("pauseButton").textContent = this.isPaused
            ? "ç¹¼çºŒ"
            : "æš«åœ";

          if (!this.isPaused) {
            this.gameLoop();
            this.spawnBubbles();
          }
        }

        resetGame() {
          this.isRunning = false;
          this.isPaused = false;
          clearInterval(this.gameTimer);
          clearTimeout(this.bubbleTimer);

          this.score = 0;
          this.timeLeft = 60;
          this.bubblesPopped = 0;
          this.totalClicks = 0;
          this.combo = 0;
          this.maxCombo = 0;
          this.bubbles = [];
          this.particles = [];

          this.setDifficulty(this.difficulty);
          this.updateUI();
          this.updateButtons();
          this.clearCanvas();

          // éš±è—é€£æ“Šé¡¯ç¤º
          document.getElementById("comboDisplay").style.display = "none";
        }

        endGame() {
          this.isRunning = false;
          clearInterval(this.gameTimer);
          clearTimeout(this.bubbleTimer);

          // æ›´æ–°çµ±è¨ˆ
          this.updateStats();

          // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
          this.showGameOver();

          this.updateButtons();
        }

        spawnBubbles() {
          if (!this.isRunning || this.isPaused) return;

          if (this.bubbles.length < this.maxBubbles) {
            this.createBubble();
          }

          this.bubbleTimer = setTimeout(
            () => this.spawnBubbles(),
            this.bubbleSpawnRate
          );
        }

        createBubble() {
          const colorData = this.getRandomBubbleColor();
          const size = 30 + Math.random() * 20;

          const bubble = {
            x: Math.random() * (this.canvas.width - size * 2) + size,
            y: this.canvas.height + size,
            size: size,
            color: colorData.color,
            value: colorData.value,
            speed: this.bubbleSpeed * (0.8 + Math.random() * 0.4),
            vx: (Math.random() - 0.5) * 2,
            vy: -this.bubbleSpeed * (0.8 + Math.random() * 0.4),
            life: 1.0,
            pulse: 0,
          };

          this.bubbles.push(bubble);
        }

        getRandomBubbleColor() {
          const totalWeight = this.bubbleColors.reduce(
            (sum, color) => sum + color.weight,
            0
          );
          let random = Math.random() * totalWeight;

          for (const color of this.bubbleColors) {
            random -= color.weight;
            if (random <= 0) {
              return color;
            }
          }

          return this.bubbleColors[0];
        }

        handleCanvasClick(e) {
          if (!this.isRunning || this.isPaused) return;

          const rect = this.canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          this.totalClicks++;

          // æª¢æŸ¥æ˜¯å¦é»æ“Šåˆ°æ³¡æ³¡
          let hit = false;
          for (let i = this.bubbles.length - 1; i >= 0; i--) {
            const bubble = this.bubbles[i];
            const dx = x - bubble.x;
            const dy = y - bubble.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance <= bubble.size) {
              this.popBubble(i, x, y);
              hit = true;
              break;
            }
          }

          if (!hit) {
            this.combo = 0;
            this.updateComboDisplay();
          }

          this.updateUI();
        }

        popBubble(index, x, y) {
          const bubble = this.bubbles[index];

          // å¢åŠ åˆ†æ•¸å’Œé€£æ“Š
          this.combo++;
          this.maxCombo = Math.max(this.maxCombo, this.combo);
          const comboMultiplier = Math.min(this.combo, 10);
          const points = bubble.value * comboMultiplier;
          this.score += points;
          this.bubblesPopped++;

          // é¡¯ç¤ºå¾—åˆ†æ•ˆæœ
          this.showPopEffect(x, y, points);

          // å‰µå»ºç²’å­æ•ˆæœ
          this.createParticles(x, y, bubble.color);

          // ç§»é™¤æ³¡æ³¡
          this.bubbles.splice(index, 1);

          // æ›´æ–°é€£æ“Šé¡¯ç¤º
          this.updateComboDisplay();
        }

        showPopEffect(x, y, points) {
          const effect = document.createElement("div");
          effect.className = "pop-effect";
          effect.textContent = `+${points}`;
          effect.style.left = x + "px";
          effect.style.top = y + "px";

          this.canvas.parentElement.appendChild(effect);

          setTimeout(() => {
            if (effect.parentElement) {
              effect.parentElement.removeChild(effect);
            }
          }, 600);
        }

        createParticles(x, y, color) {
          for (let i = 0; i < 8; i++) {
            const particle = {
              x: x,
              y: y,
              vx: (Math.random() - 0.5) * 10,
              vy: (Math.random() - 0.5) * 10,
              color: color,
              life: 1.0,
              decay: 0.02,
            };
            this.particles.push(particle);
          }
        }

        updateComboDisplay() {
          const comboDisplay = document.getElementById("comboDisplay");
          const comboCount = document.getElementById("comboCount");

          if (this.combo > 1) {
            comboCount.textContent = this.combo;
            comboDisplay.style.display = "block";
          } else {
            comboDisplay.style.display = "none";
          }
        }

        gameLoop() {
          if (!this.isRunning || this.isPaused) return;

          this.updateBubbles();
          this.updateParticles();
          this.render();

          requestAnimationFrame(() => this.gameLoop());
        }

        updateBubbles() {
          for (let i = this.bubbles.length - 1; i >= 0; i--) {
            const bubble = this.bubbles[i];

            bubble.x += bubble.vx;
            bubble.y += bubble.vy;
            bubble.pulse += 0.1;

            // é‚Šç•Œç¢°æ’
            if (
              bubble.x <= bubble.size ||
              bubble.x >= this.canvas.width - bubble.size
            ) {
              bubble.vx *= -0.8;
              bubble.x = Math.max(
                bubble.size,
                Math.min(this.canvas.width - bubble.size, bubble.x)
              );
            }

            // é ‚éƒ¨ç¢°æ’
            if (bubble.y <= bubble.size) {
              bubble.vy *= -0.8;
              bubble.y = bubble.size;
            }

            // é‡åŠ›æ•ˆæœ
            bubble.vy += 0.1;

            // ç§»é™¤è¶…å‡ºç•«é¢çš„æ³¡æ³¡
            if (bubble.y > this.canvas.height + bubble.size) {
              this.bubbles.splice(i, 1);
            }
          }
        }

        updateParticles() {
          for (let i = this.particles.length - 1; i >= 0; i--) {
            const particle = this.particles[i];

            particle.x += particle.vx;
            particle.y += particle.vy;
            particle.vy += 0.2; // é‡åŠ›
            particle.life -= particle.decay;

            if (particle.life <= 0) {
              this.particles.splice(i, 1);
            }
          }
        }

        render() {
          this.clearCanvas();

          // ç¹ªè£½æ³¡æ³¡
          this.bubbles.forEach((bubble) => this.drawBubble(bubble));

          // ç¹ªè£½ç²’å­
          this.particles.forEach((particle) => this.drawParticle(particle));
        }

        clearCanvas() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }

        drawBubble(bubble) {
          const pulseSize = bubble.size + Math.sin(bubble.pulse) * 2;

          // æ³¡æ³¡é™°å½±
          this.ctx.save();
          this.ctx.globalAlpha = 0.3;
          this.ctx.fillStyle = "#000";
          this.ctx.beginPath();
          this.ctx.arc(bubble.x + 2, bubble.y + 2, pulseSize, 0, Math.PI * 2);
          this.ctx.fill();
          this.ctx.restore();

          // æ³¡æ³¡ä¸»é«”
          this.ctx.fillStyle = bubble.color;
          this.ctx.beginPath();
          this.ctx.arc(bubble.x, bubble.y, pulseSize, 0, Math.PI * 2);
          this.ctx.fill();

          // æ³¡æ³¡é«˜å…‰
          const gradient = this.ctx.createRadialGradient(
            bubble.x - pulseSize * 0.3,
            bubble.y - pulseSize * 0.3,
            0,
            bubble.x,
            bubble.y,
            pulseSize
          );
          gradient.addColorStop(0, "rgba(255, 255, 255, 0.8)");
          gradient.addColorStop(0.3, "rgba(255, 255, 255, 0.3)");
          gradient.addColorStop(1, "rgba(255, 255, 255, 0)");

          this.ctx.fillStyle = gradient;
          this.ctx.beginPath();
          this.ctx.arc(bubble.x, bubble.y, pulseSize, 0, Math.PI * 2);
          this.ctx.fill();

          // åˆ†æ•¸æ¨™ç±¤
          this.ctx.fillStyle = "#fff";
          this.ctx.strokeStyle = "#000";
          this.ctx.lineWidth = 2;
          this.ctx.font = "bold 14px Arial";
          this.ctx.textAlign = "center";
          this.ctx.strokeText(bubble.value.toString(), bubble.x, bubble.y + 4);
          this.ctx.fillText(bubble.value.toString(), bubble.x, bubble.y + 4);
        }

        drawParticle(particle) {
          this.ctx.save();
          this.ctx.globalAlpha = particle.life;
          this.ctx.fillStyle = particle.color;
          this.ctx.beginPath();
          this.ctx.arc(particle.x, particle.y, 3, 0, Math.PI * 2);
          this.ctx.fill();
          this.ctx.restore();
        }

        updateUI() {
          document.getElementById("score").textContent =
            this.score.toLocaleString();
          document.getElementById("timer").textContent = this.timeLeft;
          document.getElementById("bubblesPopped").textContent =
            this.bubblesPopped;

          const accuracy =
            this.totalClicks > 0
              ? Math.round((this.bubblesPopped / this.totalClicks) * 100)
              : 100;
          document.getElementById("accuracy").textContent = accuracy + "%";

          // æ™‚é–“è­¦å‘Š
          const timerElement = document.getElementById("timer");
          if (this.timeLeft <= 10) {
            timerElement.classList.add("time-warning");
          } else {
            timerElement.classList.remove("time-warning");
          }
        }

        updateButtons() {
          const startButton = document.getElementById("startButton");
          const pauseButton = document.getElementById("pauseButton");

          startButton.disabled = this.isRunning;
          pauseButton.disabled = !this.isRunning;

          startButton.textContent = this.isRunning ? "é€²è¡Œä¸­" : "é–‹å§‹éŠæˆ²";
          pauseButton.textContent = this.isPaused ? "ç¹¼çºŒ" : "æš«åœ";
        }

        showHelp() {
          const modal = document.getElementById("helpModal");
          if (modal) {
            modal.style.display = "block";

            // Set up close button event listener
            const closeBtn = modal.querySelector(".close");
            if (closeBtn) {
              closeBtn.onclick = () => this.closeHelp();
            }

            // Close when clicking outside the modal
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                this.closeHelp();
              }
            });

            // Close with escape key
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                this.closeHelp();
              }
            });
          }
        }

        closeHelp() {
          const modal = document.getElementById("helpModal");
          if (modal) {
            modal.style.display = "none";
          }
        }

        showGameOver() {
          document.getElementById("finalScore").textContent =
            this.score.toLocaleString();
          document.getElementById("finalBubbles").textContent =
            this.bubblesPopped;

          const accuracy =
            this.totalClicks > 0
              ? Math.round((this.bubblesPopped / this.totalClicks) * 100)
              : 100;
          document.getElementById("finalAccuracy").textContent = accuracy + "%";
          document.getElementById("finalCombo").textContent = this.maxCombo;

          document.getElementById("gameOverModal").style.display = "block";
        }

        loadStats() {
          const stats = JSON.parse(
            localStorage.getItem("bubblePopStats") || "{}"
          );
          document.getElementById("highScore").textContent = (
            stats.highScore || 0
          ).toLocaleString();
          document.getElementById("totalGames").textContent =
            stats.totalGames || 0;
        }

        updateStats() {
          const stats = JSON.parse(
            localStorage.getItem("bubblePopStats") || "{}"
          );

          stats.highScore = Math.max(stats.highScore || 0, this.score);
          stats.totalGames = (stats.totalGames || 0) + 1;
          stats.totalBubbles = (stats.totalBubbles || 0) + this.bubblesPopped;
          stats.totalScore = (stats.totalScore || 0) + this.score;

          localStorage.setItem("bubblePopStats", JSON.stringify(stats));
          this.loadStats();
        }
      }

      // æ¨¡æ…‹æ¡†è¨­å®š
      function setupModals() {
        const modals = document.querySelectorAll(".modal");
        const closeButtons = document.querySelectorAll(".close");

        closeButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            e.target.closest(".modal").style.display = "none";
          });
        });

        window.addEventListener("click", (e) => {
          modals.forEach((modal) => {
            if (e.target === modal) {
              modal.style.display = "none";
            }
          });
        });
      }

      function restartGame() {
        document.getElementById("gameOverModal").style.display = "none";
        game.resetGame();
        game.startGame();
      }

      // åˆå§‹åŒ–éŠæˆ²
      const game = new BubblePopGame();

      // è¨»å†ŠéŠæˆ²çµ±è¨ˆ
      if (typeof gameStats !== "undefined") {
        gameStats.registerGame("bubblePop", "æ³¡æ³¡çˆ†ç ´");
      }
    </script>
  </body>
</html>
