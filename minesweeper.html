<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¸©åœ°é›· - ç¶²é å°éŠæˆ²</title>
    <meta name="game-id" content="minesweeper" />
    <meta name="game-name" content="è¸©åœ°é›·" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="notification-styles.css" />
    <style>
      .minesweeper-container {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
      }

      .game-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
      }

      .info-item {
        background-color: #e0e0e0;
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
      }

      .info-label {
        font-size: 14px;
        color: #666;
      }

      .info-value {
        font-size: 20px;
        color: #333;
      }

      #timer .info-value {
        color: #d32f2f;
      }

      .minesweeper-board {
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        gap: 2px;
        margin: 0 auto;
        width: 100%;
        max-width: 500px;
      }

      .minesweeper-cell {
        background-color: #bdbdbd;
        border: 2px outset #e0e0e0;
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        position: relative;
        box-sizing: border-box;
        user-select: none;
        cursor: pointer;
      }

      .minesweeper-cell.revealed {
        background-color: #e0e0e0;
        border: 1px solid #bdbdbd;
      }

      .minesweeper-cell.flagged::before {
        content: "ğŸš©";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
      }

      .minesweeper-cell.question::before {
        content: "?";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
        font-weight: bold;
        color: #333;
      }

      .minesweeper-cell.revealed.mine {
        background-color: #f44336;
      }

      .minesweeper-cell.revealed.mine::before {
        content: "ğŸ’£";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
      }

      .minesweeper-cell.revealed-mine-safe {
        background-color: #f44336;
        opacity: 0.5;
      }

      .minesweeper-cell.revealed-mine-safe::before {
        content: "ğŸ’£";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
        opacity: 0.7;
      }

      .minesweeper-cell.exploded::before {
        content: "ğŸ’¥";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
      }

      .minesweeper-cell.flagged-wrong::before {
        content: "âŒ";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
      }

      .cell-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        font-family: Arial, sans-serif;
      }

      .value-1 {
        color: #1976d2;
      } /* Blue */
      .value-2 {
        color: #388e3c;
      } /* Green */
      .value-3 {
        color: #d32f2f;
      } /* Red */
      .value-4 {
        color: #7b1fa2;
      } /* Purple */
      .value-5 {
        color: #ff8f00;
      } /* Amber */
      .value-6 {
        color: #0097a7;
      } /* Cyan */
      .value-7 {
        color: #424242;
      } /* Grey */
      .value-8 {
        color: #616161;
      } /* Dark grey */

      .difficulty-selector {
        display: flex;
        justify-content: center;
        margin-bottom: 15px;
      }

      .difficulty-btn {
        background-color: #f5f5f5;
        border: 2px solid transparent;
        border-radius: 5px;
        padding: 8px 15px;
        margin: 0 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .difficulty-btn:hover {
        background-color: #e0e0e0;
      }

      .difficulty-btn.active {
        border-color: #1976d2;
        background-color: #e3f2fd;
        font-weight: bold;
      }

      .smiley {
        font-size: 24px;
        cursor: pointer;
        margin-bottom: 10px;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a href="index.html" class="site-title">ç¶²é å°éŠæˆ²</a>
        <nav class="site-nav">
          <ul>
            <li><a href="index.html">è¿”å›é¦–é </a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container game-container">
      <h1>è¸©åœ°é›·</h1>
      <div class="score-display">åˆ†æ•¸: <span id="scoreValue">0</span></div>

      <div class="minesweeper-container">
        <div class="difficulty-selector">
          <div id="easyBtn" class="difficulty-btn active">ç°¡å–® (9Ã—9, 10é›·)</div>
          <div id="mediumBtn" class="difficulty-btn">ä¸­ç­‰ (16Ã—16, 40é›·)</div>
          <div id="hardBtn" class="difficulty-btn">å›°é›£ (16Ã—30, 99é›·)</div>
        </div>

        <div class="game-info">
          <div class="info-item" id="mines">
            <div class="info-label">å‰©é¤˜åœ°é›·</div>
            <div class="info-value">10</div>
          </div>
          <div class="smiley" id="smiley">ğŸ˜Š</div>
          <div class="info-item" id="timer">
            <div class="info-label">æ™‚é–“</div>
            <div class="info-value">0</div>
          </div>
        </div>

        <div id="minesweeperBoard" class="minesweeper-board"></div>

        <div class="game-controls">
          <button id="pauseButton" class="primary-button">æš«åœ</button>
          <button id="restartButton" class="primary-button">é‡æ–°é–‹å§‹</button>
          <button id="helpButton" class="secondary-button">éŠæˆ²èªªæ˜</button>
          <button id="homeButton" class="secondary-button">è¿”å›é¦–é </button>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; 2025 ç¶²é å°éŠæˆ²åˆé›† | ä½¿ç”¨ç´” JavaScript é–‹ç™¼</p>
      </div>
    </footer>
    <script src="gameUtils.js"></script>
    <script src="touchControls.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ç²å– DOM å…ƒç´ 
        const minesweeperBoard = document.getElementById("minesweeperBoard");
        const minesElement = document.querySelector("#mines .info-value");
        const timerElement = document.querySelector("#timer .info-value");
        const smileyElement = document.getElementById("smiley");
        const easyBtn = document.getElementById("easyBtn");
        const mediumBtn = document.getElementById("mediumBtn");
        const hardBtn = document.getElementById("hardBtn");

        // å‰µå»ºéŠæˆ²æ§åˆ¶å™¨
        const gameController = new GameUtils.GameController();

        // å‰µå»ºåˆ†æ•¸ç®¡ç†å™¨
        const scoreManager = new GameUtils.ScoreManager("scoreValue");

        // å‰µå»ºèªªæ˜æ¨¡æ…‹æ¡†
        const helpModal = new GameUtils.Modal(
          "helpModal",
          "è¸©åœ°é›· - éŠæˆ²èªªæ˜",
          `
            <h3>éŠæˆ²è¦å‰‡ï¼š</h3>
            <p>è¸©åœ°é›·æ˜¯ä¸€æ¬¾ç¶“å…¸çš„è§£è¬éŠæˆ²ã€‚éŠæˆ²ç›®æ¨™æ˜¯æ‰¾å‡ºæ‰€æœ‰ä¸å«åœ°é›·çš„æ ¼å­ï¼ŒåŒæ™‚é¿å…è¸©åˆ°åœ°é›·ã€‚</p>
            
            <h3>ç©æ³•èªªæ˜ï¼š</h3>
            <ul>
              <li><strong>å·¦éµé»æ“Š</strong>ï¼šæ­é–‹ä¸€å€‹æ ¼å­ã€‚</li>
              <li><strong>å³éµé»æ“Š</strong>ï¼šæ¨™è¨˜è©²æ ¼å­ç‚ºåœ°é›·ï¼ˆå†æ¬¡å³éµé»æ“Šå¯åˆ‡æ›ç‚ºå•è™Ÿæ¨™è¨˜æˆ–ç§»é™¤æ¨™è¨˜ï¼‰ã€‚</li>
              <li><strong>å·¦å³éµåŒæ™‚é»æ“Š</strong>ï¼šå¦‚æœä¸€å€‹å·²æ­é–‹çš„æ ¼å­å‘¨åœçš„åœ°é›·æ•¸é‡èˆ‡æ¨™è¨˜çš„åœ°é›·æ•¸é‡ç›¸ç¬¦ï¼Œå¯ä»¥åŒæ™‚æ­é–‹å‘¨åœå…¶ä»–æœªæ­é–‹çš„æ ¼å­ã€‚</li>
            </ul>
            
            <h3>æ•¸å­—å«ç¾©ï¼š</h3>
            <p>æ­é–‹çš„æ ¼å­ä¸Šçš„æ•¸å­—è¡¨ç¤ºè©²æ ¼å­å‘¨åœ8å€‹ç›¸é„°æ ¼å­ä¸­æœ‰å¹¾å€‹åœ°é›·ã€‚</p>
            
            <h3>éŠæˆ²çµæŸæ¢ä»¶ï¼š</h3>
            <ul>
              <li><strong>ç²å‹</strong>ï¼šæˆåŠŸæ¨™è¨˜æ‰€æœ‰åœ°é›·ï¼Œæˆ–æ­é–‹æ‰€æœ‰å®‰å…¨çš„æ ¼å­ã€‚</li>
              <li><strong>å¤±æ•—</strong>ï¼šè¸©åˆ°åœ°é›·ã€‚</li>
            </ul>
            
            <h3>è¨ˆåˆ†æ–¹å¼ï¼š</h3>
            <ul>
              <li>æ ¹æ“šé›£åº¦ç´šåˆ¥ã€å®Œæˆæ™‚é–“å’Œå‰©é¤˜åœ°é›·è¨ˆç®—å¾—åˆ†ã€‚</li>
              <li>é›£åº¦è¶Šé«˜ã€å®Œæˆæ™‚é–“è¶ŠçŸ­ï¼Œå¾—åˆ†è¶Šé«˜ã€‚</li>
            </ul>
          `
        );

        // é›£åº¦è¨­å®š
        const difficulties = {
          easy: { rows: 9, cols: 9, mines: 10, scoreMultiplier: 1 },
          medium: { rows: 16, cols: 16, mines: 40, scoreMultiplier: 2 },
          hard: { rows: 16, cols: 30, mines: 99, scoreMultiplier: 3 },
        };

        // éŠæˆ²è®Šæ•¸
        let board = [];
        let difficulty = "easy";
        let rows, cols, minesCount;
        let revealedCount = 0;
        let flaggedCount = 0;
        let isFirstClick = true;
        let timer;
        let time = 0;
        let isGameOver = false;

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
          // è¨­ç½®é›£åº¦åƒæ•¸
          const settings = difficulties[difficulty];
          rows = settings.rows;
          cols = settings.cols;
          minesCount = settings.mines;

          // é‡ç½®éŠæˆ²ç‹€æ…‹
          board = [];
          revealedCount = 0;
          flaggedCount = 0;
          isFirstClick = true;
          isGameOver = false;
          time = 0;

          // é‡ç½®UI
          minesElement.textContent = minesCount;
          timerElement.textContent = "0";
          smileyElement.textContent = "ğŸ˜Š";
          scoreManager.reset();

          // åœæ­¢è¨ˆæ™‚å™¨
          if (timer) {
            clearInterval(timer);
            timer = null;
          }

          // å‰µå»ºæ£‹ç›¤
          createBoard();

          // èª¿æ•´ç¶²æ ¼å¤§å°
          minesweeperBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

          // è¨­ç½®éŠæˆ²å¾ªç’°
          gameController.setGameLoop(() => {
            // åœ¨è¸©åœ°é›·éŠæˆ²ä¸­ï¼Œä¸»è¦æ˜¯åŸºæ–¼äº‹ä»¶æ“ä½œï¼Œæ‰€ä»¥å¾ªç’°ä¸­ä¸éœ€è¦åšå¤ªå¤š
          });

          // é–‹å§‹éŠæˆ²å¾ªç’°
          gameController.startGameLoop();
        }

        // å‰µå»ºæ£‹ç›¤
        function createBoard() {
          // æ¸…ç©ºæ£‹ç›¤
          minesweeperBoard.innerHTML = "";

          // å‰µå»ºåˆå§‹æ£‹ç›¤ï¼ˆç„¡åœ°é›·ï¼‰
          for (let y = 0; y < rows; y++) {
            board[y] = [];
            for (let x = 0; x < cols; x++) {
              board[y][x] = {
                x,
                y,
                isMine: false,
                isRevealed: false,
                isFlagged: false,
                isQuestion: false,
                neighborMines: 0,
              };

              // å‰µå»ºå–®å…ƒæ ¼ DOM å…ƒç´ 
              const cell = document.createElement("div");
              cell.className = "minesweeper-cell";
              cell.dataset.x = x;
              cell.dataset.y = y;

              // æ·»åŠ é»æ“Šäº‹ä»¶
              cell.addEventListener("click", () => revealCell(x, y));
              cell.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                flagCell(x, y);
              });

              // æ·»åŠ é›™æ“ŠåŠŸèƒ½ (æˆ–å·¦å³åŒæ™‚é»æ“Š)
              cell.addEventListener("auxclick", (e) => {
                if (e.button === 1) {
                  // ä¸­éµé»æ“Š
                  revealNeighbors(x, y);
                }
              });
              cell.addEventListener("dblclick", () => revealNeighbors(x, y));

              minesweeperBoard.appendChild(cell);
            }
          }
        }

        // åœ¨æ£‹ç›¤ä¸Šæ”¾ç½®åœ°é›·
        function placeMines(firstX, firstY) {
          let minesPlaced = 0;

          // è¨ˆç®—å®‰å…¨å€åŸŸ (é¦–æ¬¡é»æ“Šçš„å‘¨åœ3x3å€åŸŸ)
          const safeArea = [];
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              const nx = firstX + dx;
              const ny = firstY + dy;
              if (nx >= 0 && nx < cols && ny >= 0 && ny < rows) {
                safeArea.push({ x: nx, y: ny });
              }
            }
          }

          while (minesPlaced < minesCount) {
            const x = Math.floor(Math.random() * cols);
            const y = Math.floor(Math.random() * rows);

            // æª¢æŸ¥æ˜¯å¦åœ¨å®‰å…¨å€åŸŸ
            const isInSafeArea = safeArea.some(
              (pos) => pos.x === x && pos.y === y
            );

            if (!board[y][x].isMine && !isInSafeArea) {
              board[y][x].isMine = true;
              minesPlaced++;
            }
          }

          // è¨ˆç®—æ¯å€‹å–®å…ƒæ ¼é™„è¿‘çš„åœ°é›·æ•¸
          calculateNeighborMines();
        }

        // è¨ˆç®—æ¯å€‹å–®å…ƒæ ¼é™„è¿‘çš„åœ°é›·æ•¸
        function calculateNeighborMines() {
          for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
              if (!board[y][x].isMine) {
                // æª¢æŸ¥å‘¨åœ8å€‹æ–¹å‘
                let count = 0;
                for (let dy = -1; dy <= 1; dy++) {
                  for (let dx = -1; dx <= 1; dx++) {
                    if (dx === 0 && dy === 0) continue;

                    const nx = x + dx;
                    const ny = y + dy;

                    // æª¢æŸ¥é‚Šç•Œ
                    if (nx >= 0 && nx < cols && ny >= 0 && ny < rows) {
                      if (board[ny][nx].isMine) {
                        count++;
                      }
                    }
                  }
                }
                board[y][x].neighborMines = count;
              }
            }
          }
        }

        // æ­é–‹å–®å…ƒæ ¼
        function revealCell(x, y) {
          // å¦‚æœéŠæˆ²å·²çµæŸã€æš«åœæˆ–å–®å…ƒæ ¼å·²è¢«æ¨™è¨˜ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
          if (
            isGameOver ||
            gameController.paused ||
            board[y][x].isFlagged ||
            board[y][x].isRevealed
          ) {
            return;
          }

          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é»æ“Šï¼Œå‰‡æ”¾ç½®åœ°é›·ä¸¦é–‹å§‹è¨ˆæ™‚
          if (isFirstClick) {
            placeMines(x, y);
            isFirstClick = false;
            startTimer();

            // è¡¨æƒ…æ›´æ–°
            smileyElement.textContent = "ğŸ™‚";
          }

          const cell = board[y][x];

          // å¦‚æœé»åˆ°åœ°é›·ï¼ŒéŠæˆ²çµæŸ
          if (cell.isMine) {
            revealAllMines(x, y);
            endGame(false);
            return;
          }

          // æ­é–‹å–®å…ƒæ ¼
          revealCellHelper(x, y);

          // æ›´æ–° UI
          updateBoardView();

          // æª¢æŸ¥æ˜¯å¦ç²å‹
          checkWin();
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ­é–‹å–®å…ƒæ ¼ï¼ˆéæ­¸ï¼‰
        function revealCellHelper(x, y) {
          const cell = board[y][x];

          // å¦‚æœå·²ç¶“æ­é–‹æˆ–è¢«æ¨™è¨˜ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
          if (cell.isRevealed || cell.isFlagged) {
            return;
          }

          // æ¨™è¨˜ç‚ºå·²æ­é–‹
          cell.isRevealed = true;
          cell.isQuestion = false; // ç§»é™¤å•è™Ÿæ¨™è¨˜
          revealedCount++;

          // å¦‚æœå‘¨åœæ²’æœ‰åœ°é›·ï¼Œå‰‡è‡ªå‹•æ­é–‹å‘¨åœçš„å–®å…ƒæ ¼
          if (cell.neighborMines === 0) {
            for (let dy = -1; dy <= 1; dy++) {
              for (let dx = -1; dx <= 1; dx++) {
                if (dx === 0 && dy === 0) continue;

                const nx = x + dx;
                const ny = y + dy;

                if (nx >= 0 && nx < cols && ny >= 0 && ny < rows) {
                  revealCellHelper(nx, ny);
                }
              }
            }
          }
        }

        // æ¨™è¨˜å–®å…ƒæ ¼
        function flagCell(x, y) {
          // å¦‚æœéŠæˆ²å·²çµæŸã€æš«åœæˆ–å–®å…ƒæ ¼å·²è¢«æ­é–‹ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
          if (isGameOver || gameController.paused || board[y][x].isRevealed) {
            return;
          }

          const cell = board[y][x];

          // åˆ‡æ›æ¨™è¨˜ç‹€æ…‹ï¼šç„¡æ¨™è¨˜ -> æ——å­ -> å•è™Ÿ -> ç„¡æ¨™è¨˜
          if (!cell.isFlagged && !cell.isQuestion) {
            cell.isFlagged = true;
            flaggedCount++;
          } else if (cell.isFlagged) {
            cell.isFlagged = false;
            cell.isQuestion = true;
            flaggedCount--;
          } else {
            cell.isQuestion = false;
          }

          // æ›´æ–°å‰©é¤˜åœ°é›·æ•¸
          minesElement.textContent = minesCount - flaggedCount;

          // æ›´æ–° UI
          updateBoardView();
        }

        // æ­é–‹å‘¨åœçš„å–®å…ƒæ ¼ï¼ˆé›™æ“ŠåŠŸèƒ½ï¼‰
        function revealNeighbors(x, y) {
          const cell = board[y][x];

          // å¦‚æœå–®å…ƒæ ¼æœªæ­é–‹æˆ–æ²’æœ‰æ•¸å­—ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
          if (!cell.isRevealed || cell.neighborMines === 0) {
            return;
          }

          // è¨ˆç®—å‘¨åœæ¨™è¨˜çš„æ——å­æ•¸é‡
          let flagCount = 0;
          const neighbors = [];

          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              if (dx === 0 && dy === 0) continue;

              const nx = x + dx;
              const ny = y + dy;

              if (nx >= 0 && nx < cols && ny >= 0 && ny < rows) {
                neighbors.push({ x: nx, y: ny });
                if (board[ny][nx].isFlagged) {
                  flagCount++;
                }
              }
            }
          }

          // å¦‚æœæ¨™è¨˜çš„æ——å­æ•¸é‡èˆ‡å‘¨åœåœ°é›·æ•¸ç›¸ç¬¦ï¼Œå‰‡æ­é–‹å‘¨åœæœªæ¨™è¨˜çš„å–®å…ƒæ ¼
          if (flagCount === cell.neighborMines) {
            let hitMine = false;

            neighbors.forEach((neighbor) => {
              const nx = neighbor.x;
              const ny = neighbor.y;
              const neighborCell = board[ny][nx];

              if (!neighborCell.isRevealed && !neighborCell.isFlagged) {
                if (neighborCell.isMine) {
                  hitMine = true;
                } else {
                  revealCellHelper(nx, ny);
                }
              }
            });

            if (hitMine) {
              revealAllMines();
              endGame(false);
              return;
            }

            // æ›´æ–° UI
            updateBoardView();

            // æª¢æŸ¥æ˜¯å¦ç²å‹
            checkWin();
          }
        }

        // æ­é–‹æ‰€æœ‰åœ°é›·
        function revealAllMines(explodedX, explodedY) {
          for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
              const cell = board[y][x];

              if (cell.isMine) {
                // æ¨™è¨˜ç‚ºå·²æ­é–‹
                cell.isRevealed = true;

                // æ¨™è¨˜çˆ†ç‚¸çš„åœ°é›·
                if (
                  explodedX !== undefined &&
                  explodedY !== undefined &&
                  x === explodedX &&
                  y === explodedY
                ) {
                  cell.exploded = true;
                }
              } else if (cell.isFlagged) {
                // æ¨™è¨˜éŒ¯èª¤çš„æ——å­
                cell.wrongFlag = true;
              }
            }
          }

          // æ›´æ–° UI
          updateBoardView();
        }

        // æ›´æ–°æ£‹ç›¤è¦–åœ–
        function updateBoardView() {
          for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
              const cell = board[y][x];
              const cellElement = minesweeperBoard.children[y * cols + x];

              // é‡ç½®é¡
              cellElement.className = "minesweeper-cell";
              cellElement.innerHTML = "";

              if (cell.isRevealed) {
                cellElement.classList.add("revealed");

                if (cell.isMine) {
                  if (cell.exploded) {
                    cellElement.classList.add("exploded");
                  } else {
                    cellElement.classList.add("mine");
                  }
                } else if (cell.neighborMines > 0) {
                  const value = document.createElement("span");
                  value.className = `cell-value value-${cell.neighborMines}`;
                  value.textContent = cell.neighborMines;
                  cellElement.appendChild(value);
                }
              } else if (cell.isFlagged) {
                cellElement.classList.add("flagged");
                if (isGameOver && cell.wrongFlag) {
                  cellElement.classList.add("flagged-wrong");
                }
              } else if (cell.isQuestion) {
                cellElement.classList.add("question");
              }

              if (isGameOver && cell.isMine && !cell.isRevealed) {
                cellElement.classList.add("revealed-mine-safe");
              }
            }
          }
        }

        // é–‹å§‹è¨ˆæ™‚å™¨
        function startTimer() {
          if (timer) {
            clearInterval(timer);
          }

          time = 0;
          timerElement.textContent = time;

          timer = setInterval(() => {
            if (!gameController.paused) {
              time++;
              timerElement.textContent = time;
            }
          }, 1000);
        }

        // æª¢æŸ¥æ˜¯å¦ç²å‹
        function checkWin() {
          const totalCells = rows * cols;
          const targetRevealed = totalCells - minesCount;

          if (revealedCount === targetRevealed) {
            // æ¨™è¨˜æ‰€æœ‰å‰©é¤˜çš„åœ°é›·
            for (let y = 0; y < rows; y++) {
              for (let x = 0; x < cols; x++) {
                const cell = board[y][x];
                if (cell.isMine && !cell.isFlagged) {
                  cell.isFlagged = true;
                }
              }
            }

            // æ›´æ–°å‰©é¤˜åœ°é›·æ•¸
            minesElement.textContent = "0";

            // çµæŸéŠæˆ²
            endGame(true);
          }
        }

        // çµæŸéŠæˆ²
        function endGame(isWin) {
          isGameOver = true;

          // åœæ­¢è¨ˆæ™‚å™¨
          if (timer) {
            clearInterval(timer);
            timer = null;
          }

          // æ›´æ–°è¡¨æƒ…
          smileyElement.textContent = isWin ? "ğŸ˜" : "ğŸ˜µ";

          // è¨ˆç®—åˆ†æ•¸
          if (isWin) {
            const settings = difficulties[difficulty];

            // åŸºæœ¬åˆ†æ•¸ = é›£åº¦ä¿‚æ•¸ * åœ°é›·æ•¸ * 100
            const baseScore = settings.scoreMultiplier * minesCount * 100;

            // æ™‚é–“çå‹µ = é›£åº¦ä¿‚æ•¸ * æœ€å¤§æ™‚é–“(300ç§’) / (ç¶“éæ™‚é–“ + 30) * 100
            // é€™ç¢ºä¿äº†å®Œæˆæ™‚é–“è¶ŠçŸ­ï¼Œç²å¾—çš„çå‹µè¶Šå¤š
            const timeBonus = Math.floor(
              ((settings.scoreMultiplier * 300) / (time + 30)) * 100
            );

            const totalScore = baseScore + timeBonus;

            // æ›´æ–°åˆ†æ•¸
            scoreManager.add(totalScore);

            // é¡¯ç¤ºå‹åˆ©è¨Šæ¯
            let message = `
              <p>æ­å–œä½ å®Œæˆäº†${
                difficulty === "easy"
                  ? "ç°¡å–®"
                  : difficulty === "medium"
                  ? "ä¸­ç­‰"
                  : "å›°é›£"
              }é›£åº¦ï¼</p>
              <p>ç”¨æ™‚: ${time} ç§’</p>
              <p>åŸºæœ¬åˆ†æ•¸: ${baseScore}</p>
              <p>æ™‚é–“çå‹µ: ${timeBonus}</p>
              <p>ç¸½åˆ†: ${totalScore}</p>
            `;

            gameController.endGame(totalScore, "ä½ è´äº†ï¼");
          } else {
            gameController.endGame(0, "éŠæˆ²çµæŸï¼");
          }
        }

        // è¨­ç½®é›£åº¦åˆ‡æ›
        easyBtn.addEventListener("click", () => setDifficulty("easy"));
        mediumBtn.addEventListener("click", () => setDifficulty("medium"));
        hardBtn.addEventListener("click", () => setDifficulty("hard"));

        // é‡æ–°é–‹å§‹æŒ‰éˆ•
        smileyElement.addEventListener("click", () => {
          initGame();
        });

        // è¨­ç½®é›£åº¦
        function setDifficulty(level) {
          difficulty = level;

          // æ›´æ–°æŒ‰éˆ•æ¨£å¼
          easyBtn.classList.toggle("active", level === "easy");
          mediumBtn.classList.toggle("active", level === "medium");
          hardBtn.classList.toggle("active", level === "hard");

          // é‡æ–°åˆå§‹åŒ–éŠæˆ²
          initGame();
        }

        // è¨­ç½®é‡å•Ÿè™•ç†å™¨
        gameController.setRestartHandler(() => {
          initGame();
        });

        // é¼ æ¨™æŒ‰ä¸‹æ™‚æ”¹è®Šè¡¨æƒ…
        document.addEventListener("mousedown", () => {
          if (!isGameOver && !gameController.paused) {
            smileyElement.textContent = "ğŸ˜®";
          }
        });

        // é¼ æ¨™æŠ¬èµ·æ™‚æ¢å¾©è¡¨æƒ…
        document.addEventListener("mouseup", () => {
          if (!isGameOver && !gameController.paused) {
            smileyElement.textContent = "ğŸ™‚";
          }
        });

        // è§¸æ‘¸å±æ”¯æŒ
        minesweeperBoard.addEventListener("contextmenu", (e) => {
          e.preventDefault(); // é˜²æ­¢å³éµèœå–®å‡ºç¾
          return false;
        });

        // é•·æŒ‰åŠŸèƒ½ï¼ˆæ¨¡æ“¬å³éµï¼‰
        let touchTimer;
        let touchDuration = 500;
        let touchCell;

        minesweeperBoard.addEventListener("touchstart", (e) => {
          if (isGameOver || gameController.paused) return;

          const target = e.target;
          if (!target.classList.contains("minesweeper-cell")) return;

          touchCell = target;

          touchTimer = setTimeout(() => {
            const x = parseInt(touchCell.dataset.x);
            const y = parseInt(touchCell.dataset.y);
            flagCell(x, y);
            touchCell = null;
          }, touchDuration);
        });

        minesweeperBoard.addEventListener("touchend", (e) => {
          clearTimeout(touchTimer);

          if (isGameOver || gameController.paused || !touchCell) return;

          // å¦‚æœé•·æŒ‰æ™‚é–“å°æ–¼æŒçºŒæ™‚é–“ï¼Œå‰‡è¦–ç‚ºå·¦éµé»æ“Š
          const x = parseInt(touchCell.dataset.x);
          const y = parseInt(touchCell.dataset.y);
          revealCell(x, y);
          touchCell = null;
        });
        minesweeperBoard.addEventListener("touchmove", (e) => {
          clearTimeout(touchTimer);
          touchCell = null;
        });

        // åˆå§‹åŒ–TouchControlsä¾†å¢å¼·è§¸æ§é«”é©—
        const touchControls = new TouchControls().bindTo(minesweeperBoard);

        // é•·æŒ‰ç”¨æ–¼æ¨™è¨˜æ–¹æ ¼
        touchControls.on("longPress", (e) => {
          if (isGameOver || gameController.paused) return;

          const target = e.originalEvent.target;
          if (!target.classList.contains("minesweeper-cell")) return;

          const x = parseInt(target.dataset.x);
          const y = parseInt(target.dataset.y);
          flagCell(x, y);

          // é˜²æ­¢å…¶ä»–è§¸æ§äº‹ä»¶è§¸ç™¼
          e.originalEvent.preventDefault();
        });

        // é›™æ“Šç”¨æ–¼æ­éœ²å‘¨åœæ–¹æ ¼
        touchControls.on("doubleTap", (e) => {
          if (isGameOver || gameController.paused) return;

          const target = e.originalEvent.target;
          if (!target.classList.contains("minesweeper-cell")) return;

          const x = parseInt(target.dataset.x);
          const y = parseInt(target.dataset.y);
          revealNeighbors(x, y);
        });

        // æ·»åŠ ç§»å‹•è¨­å‚™æ“ä½œèªªæ˜
        if ("ontouchstart" in window || navigator.maxTouchPoints > 0) {
          const touchInstructions = document.createElement("div");
          touchInstructions.className = "touch-instructions";
          touchInstructions.innerHTML = `
            <div style="margin-top: 15px; padding: 10px; background-color: #f0f8ff; border-radius: 5px; text-align: left;">
              <p><strong>ç§»å‹•è¨­å‚™æ“ä½œï¼š</strong></p>
              <ul style="margin-left: 20px; padding-left: 10px;">
                <li>é»æ“Šæ–¹æ ¼ - æ­éœ²è©²æ–¹æ ¼</li>
                <li>é•·æŒ‰æ–¹æ ¼ - æ¨™è¨˜åœ°é›·</li>
                <li>é›™æ“Šæ–¹æ ¼ - æ­éœ²å‘¨åœæ–¹æ ¼</li>
              </ul>
            </div>
          `;

          // æ·»åŠ åˆ°éŠæˆ²æ§åˆ¶å€åŸŸä¸‹æ–¹
          document.querySelector(".game-controls").after(touchInstructions);
        }

        // é¡¯ç¤ºé–‹å§‹å‹•ç•«ç„¶å¾Œåˆå§‹åŒ–éŠæˆ²
        gameController.showStartAnimation(() => {
          initGame();
        });
      });
    </script>
  </body>
</html>
